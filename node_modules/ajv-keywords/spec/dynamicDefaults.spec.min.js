"use strict";var Ajv=require("ajv"),defFunc=require("../keywords/dynamicDefaults"),defineKeywords=require(".."),should=require("chai").should(),assert=require("assert"),uuid=require("uuid");describe('keyword "dynamicDefaults"',function(){function e(){return new Ajv({useDefaults:!0,unknownFormats:!0})}var t=[e(),e(),e()];defFunc(t[0]),defineKeywords(t[1],"dynamicDefaults"),defineKeywords(t[2]),t.forEach(function(e,t){it("should assign defaults #"+t,function(r){function s(t){t.ts.should.be.a("number"),assert(t.ts<=Date.now()),e.validate({type:"string",format:"date-time"},t.dt).should.equal(!0),new Date(t.dt).should.be.a("Date"),e.validate({type:"string",format:"date"},t.d).should.equal(!0),(new Date).toISOString().indexOf(t.d).should.equal(0),e.validate({type:"string",format:"time"},t.t).should.equal(!0),t.r.should.be.a("number"),assert(t.r<1),assert(t.r>=0),assert(0===t.ri||1===t.ri),t.riN.should.be.a("number"),assert.equal(Math.floor(t.riN),t.riN),assert(t.riN<1e6),assert(t.riN>=0),t.s.should.be.a("number"),t.sN.should.be.a("number")}var n={dynamicDefaults:{ts:"timestamp",dt:"datetime",d:"date",t:"time",r:"random",ri:"randomint",riN:{func:"randomint",args:{max:1e6}},s:"seq",sN:{func:"seq",args:{name:"foo"}}}},i=e.compile(n),o={};i(o).should.equal(!0),s(o),o.s.should.equal(2*t),o.sN.should.equal(2*t),setTimeout(function(){var e={};i(e).should.equal(!0),s(e),assert(o.ts<e.ts),assert.notEqual(o.dt,e.dt),assert.equal(o.d,e.d),assert.notEqual(o.t,e.t),assert.notEqual(o.r,e.r),assert.notEqual(o.riN,e.riN),e.s.should.equal(2*t+1),e.sN.should.equal(2*t+1),r()},1e3)}),it("should NOT assign default if property is present #"+t,function(){var t={dynamicDefaults:{ts:"timestamp"}},r=e.compile(t),n={ts:123};r(n).should.equal(!0),n.ts.should.equal(123)}),it("should NOT assign default inside anyOf etc. #"+t,function(){var t={anyOf:[{dynamicDefaults:{ts:"timestamp"}}]},r=e.compile(t),n={};r(n).should.equal(!0),should.not.exist(n.ts)}),it("should fail schema compilation on unknown default #"+t,function(){var t={dynamicDefaults:{ts:"unknown"}};should["throw"](function(){e.compile(t)})}),it("should allow adding defaults #"+t,function(){function i(r){e.validate(t,r).should.equal(!0),e.validate({format:"uuid",type:"string"},r.id).should.equal(!0),delete defFunc.definition.DEFAULTS.uuid,e.removeSchema()}function o(){return uuid.v4()}var t={dynamicDefaults:{id:"uuid"}};should["throw"](function(){e.compile(t)}),defFunc.definition.DEFAULTS.uuid=o;var r={};i(r),should["throw"](function(){e.compile(t)}),defineKeywords.get("dynamicDefaults").definition.DEFAULTS.uuid=o;var n={};i(n),assert.notEqual(r.id,n.id)})})});