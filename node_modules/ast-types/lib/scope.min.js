function Scope(e,t){if(!(this instanceof Scope))throw new Error("Scope constructor cannot be invoked without 'new'");if(!(e instanceof require("./node-path")))throw new Error("");ScopeType.assert(e.value);var r;if(t){if(!(t instanceof Scope))throw new Error("");r=t.depth+1}else t=null,r=0;Object.defineProperties(this,{path:{value:e},node:{value:e.value},isGlobal:{value:!t,enumerable:!0},depth:{value:r},parent:{value:t},bindings:{value:{}},types:{value:{}}})}function scanScope(e,t,r){var n=e.value;ScopeType.assert(n),namedTypes.CatchClause.check(n)?addPattern(e.get("param"),t):recursiveScanScope(e,t,r)}function recursiveScanScope(e,t,r){var n=e.value;e.parent&&namedTypes.FunctionExpression.check(e.parent.node)&&e.parent.node.id&&addPattern(e.parent.get("id"),t),n&&(isArray.check(n)?e.each(function(e){recursiveScanChild(e,t,r)}):namedTypes.Function.check(n)?(e.get("params").each(function(e){addPattern(e,t)}),recursiveScanChild(e.get("body"),t,r)):namedTypes.TypeAlias&&namedTypes.TypeAlias.check(n)?addTypePattern(e.get("id"),r):namedTypes.VariableDeclarator.check(n)?(addPattern(e.get("id"),t),recursiveScanChild(e.get("init"),t,r)):"ImportSpecifier"===n.type||"ImportNamespaceSpecifier"===n.type||"ImportDefaultSpecifier"===n.type?addPattern(e.get(n.local?"local":n.name?"name":"id"),t):Node.check(n)&&!Expression.check(n)&&types.eachField(n,function(n,i){var o=e.get(n);if(o.value!==i)throw new Error("");recursiveScanChild(o,t,r)}))}function recursiveScanChild(e,t,r){var n=e.value;if(!n||Expression.check(n));else if(namedTypes.FunctionDeclaration.check(n))addPattern(e.get("id"),t);else if(namedTypes.ClassDeclaration&&namedTypes.ClassDeclaration.check(n))addPattern(e.get("id"),t);else if(ScopeType.check(n)){if(namedTypes.CatchClause.check(n)){var i=n.param.name,o=hasOwn.call(t,i);recursiveScanScope(e.get("body"),t,r),o||delete t[i]}}else recursiveScanScope(e,t,r)}function addPattern(e,t){var r=e.value;namedTypes.Pattern.assert(r),namedTypes.Identifier.check(r)?hasOwn.call(t,r.name)?t[r.name].push(e):t[r.name]=[e]:namedTypes.ObjectPattern&&namedTypes.ObjectPattern.check(r)?e.get("properties").each(function(e){var r=e.value;namedTypes.Pattern.check(r)?addPattern(e,t):namedTypes.Property.check(r)?addPattern(e.get("value"),t):namedTypes.SpreadProperty&&namedTypes.SpreadProperty.check(r)&&addPattern(e.get("argument"),t)}):namedTypes.ArrayPattern&&namedTypes.ArrayPattern.check(r)?e.get("elements").each(function(e){var r=e.value;namedTypes.Pattern.check(r)?addPattern(e,t):namedTypes.SpreadElement&&namedTypes.SpreadElement.check(r)&&addPattern(e.get("argument"),t)}):namedTypes.PropertyPattern&&namedTypes.PropertyPattern.check(r)?addPattern(e.get("pattern"),t):(namedTypes.SpreadElementPattern&&namedTypes.SpreadElementPattern.check(r)||namedTypes.SpreadPropertyPattern&&namedTypes.SpreadPropertyPattern.check(r))&&addPattern(e.get("argument"),t)}function addTypePattern(e,t){var r=e.value;namedTypes.Pattern.assert(r),namedTypes.Identifier.check(r)&&(hasOwn.call(t,r.name)?t[r.name].push(e):t[r.name]=[e])}var types=require("./types"),Type=types.Type,namedTypes=types.namedTypes,Node=namedTypes.Node,Expression=namedTypes.Expression,isArray=types.builtInTypes.array,hasOwn=Object.prototype.hasOwnProperty,b=types.builders,scopeTypes=[namedTypes.Program,namedTypes.Function,namedTypes.CatchClause],ScopeType=Type.or.apply(Type,scopeTypes);Scope.isEstablishedBy=function(e){return ScopeType.check(e)};var Sp=Scope.prototype;Sp.didScan=!1,Sp.declares=function(e){return this.scan(),hasOwn.call(this.bindings,e)},Sp.declaresType=function(e){return this.scan(),hasOwn.call(this.types,e)},Sp.declareTemporary=function(e){if(e){if(!/^[a-z$_]/i.test(e))throw new Error("")}else e="t$";e+=this.depth.toString(36)+"$",this.scan();for(var t=0;this.declares(e+t);)++t;var r=e+t;return this.bindings[r]=types.builders.identifier(r)},Sp.injectTemporary=function(e,t){e||(e=this.declareTemporary());var r=this.path.get("body");return namedTypes.BlockStatement.check(r.value)&&(r=r.get("body")),r.unshift(b.variableDeclaration("var",[b.variableDeclarator(e,t||null)])),e},Sp.scan=function(e){if(e||!this.didScan){for(var t in this.bindings)delete this.bindings[t];scanScope(this.path,this.bindings,this.types),this.didScan=!0}},Sp.getBindings=function(){return this.scan(),this.bindings},Sp.getTypes=function(){return this.scan(),this.types},Sp.lookup=function(e){for(var t=this;t&&!t.declares(e);t=t.parent);return t},Sp.lookupType=function(e){for(var t=this;t&&!t.declaresType(e);t=t.parent);return t},Sp.getGlobalScope=function(){for(var e=this;!e.isGlobal;)e=e.parent;return e},module.exports=Scope;