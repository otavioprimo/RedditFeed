function Path(e,t,r){if(!(this instanceof Path))throw new Error("Path constructor cannot be invoked without 'new'");if(t){if(!(t instanceof Path))throw new Error("")}else t=null,r=null;this.value=e,this.parentPath=t,this.name=r,this.__childCache=null}function getChildCache(e){return e.__childCache||(e.__childCache=Object.create(null))}function getChildPath(e,t){var r=getChildCache(e),n=e.getValueProperty(t),i=r[t];return hasOwn.call(r,t)&&i.value===n||(i=r[t]=new e.constructor(n,e,t)),i}function emptyMoves(){}function getMoves(e,t,r,n){if(isArray.assert(e.value),0===t)return emptyMoves;var i=e.value.length;if(1>i)return emptyMoves;var o=arguments.length;2===o?(r=0,n=i):3===o?(r=Math.max(r,0),n=i):(r=Math.max(r,0),n=Math.min(n,i)),isNumber.assert(r),isNumber.assert(n);for(var a=Object.create(null),s=getChildCache(e),u=r;n>u;++u)if(hasOwn.call(e.value,u)){var l=e.get(u);if(l.name!==u)throw new Error("");var c=u+t;l.name=c,a[c]=l,delete s[u]}return delete s.length,function(){for(var t in a){var r=a[t];if(r.name!==+t)throw new Error("");s[t]=r,e.value[t]=r.value}}}function repairRelationshipWithParent(e){if(!(e instanceof Path))throw new Error("");var t=e.parentPath;if(!t)return e;var r=t.value,n=getChildCache(t);if(r[e.name]===e.value)n[e.name]=e;else if(isArray.check(r)){var i=r.indexOf(e.value);i>=0&&(n[e.name=i]=e)}else r[e.name]=e.value,n[e.name]=e;if(r[e.name]!==e.value)throw new Error("");if(e.parentPath.get(e.name)!==e)throw new Error("");return e}var Op=Object.prototype,hasOwn=Op.hasOwnProperty,types=require("./types"),isArray=types.builtInTypes.array,isNumber=types.builtInTypes.number,Ap=Array.prototype,slice=Ap.slice,map=Ap.map,Pp=Path.prototype;Pp.getValueProperty=function(e){return this.value[e]},Pp.get=function(e){for(var t=this,r=arguments,n=r.length,i=0;n>i;++i)t=getChildPath(t,r[i]);return t},Pp.each=function(e,t){for(var r=[],n=this.value.length,i=0,i=0;n>i;++i)hasOwn.call(this.value,i)&&(r[i]=this.get(i));for(t=t||this,i=0;n>i;++i)hasOwn.call(r,i)&&e.call(t,r[i])},Pp.map=function(e,t){var r=[];return this.each(function(t){r.push(e.call(this,t))},t),r},Pp.filter=function(e,t){var r=[];return this.each(function(t){e.call(this,t)&&r.push(t)},t),r},Pp.shift=function(){var e=getMoves(this,-1),t=this.value.shift();return e(),t},Pp.unshift=function(e){var t=getMoves(this,arguments.length),r=this.value.unshift.apply(this.value,arguments);return t(),r},Pp.push=function(e){return isArray.assert(this.value),delete getChildCache(this).length,this.value.push.apply(this.value,arguments)},Pp.pop=function(){isArray.assert(this.value);var e=getChildCache(this);return delete e[this.value.length-1],delete e.length,this.value.pop()},Pp.insertAt=function(e,t){var r=arguments.length,n=getMoves(this,r-1,e);if(n===emptyMoves)return this;e=Math.max(e,0);for(var i=1;r>i;++i)this.value[e+i-1]=arguments[i];return n(),this},Pp.insertBefore=function(e){for(var t=this.parentPath,r=arguments.length,n=[this.name],i=0;r>i;++i)n.push(arguments[i]);return t.insertAt.apply(t,n)},Pp.insertAfter=function(e){for(var t=this.parentPath,r=arguments.length,n=[this.name+1],i=0;r>i;++i)n.push(arguments[i]);return t.insertAt.apply(t,n)},Pp.replace=function(e){var t=[],r=this.parentPath.value,n=getChildCache(this.parentPath),i=arguments.length;if(repairRelationshipWithParent(this),isArray.check(r)){for(var o=r.length,a=getMoves(this.parentPath,i-1,this.name+1),s=[this.name,1],u=0;i>u;++u)s.push(arguments[u]);var l=r.splice.apply(r,s);if(l[0]!==this.value)throw new Error("");if(r.length!==o-1+i)throw new Error("");if(a(),0===i)delete this.value,delete n[this.name],this.__childCache=null;else{if(r[this.name]!==e)throw new Error("");for(this.value!==e&&(this.value=e,this.__childCache=null),u=0;i>u;++u)t.push(this.parentPath.get(this.name+u));if(t[0]!==this)throw new Error("")}}else if(1===i)this.value!==e&&(this.__childCache=null),this.value=r[this.name]=e,t.push(this);else{if(0!==i)throw new Error("Could not replace path");delete r[this.name],delete this.value,this.__childCache=null}return t},module.exports=Path;