function sign(t,e,n,r){var i=parseKeys(e);if(i.curve){if("ecdsa"!==r)throw new Error("wrong private key type");return ecSign(t,i)}if("dsa"===i.type){if("dsa"!==r)throw new Error("wrong private key type");return dsaSign(t,i,n)}if("rsa"!==r)throw new Error("wrong private key type");for(var o=i.modulus.byteLength(),s=[0,1];t.length+s.length+1<o;)s.push(255);s.push(0);for(var a=-1;++a<t.length;)s.push(t[a]);var c=crt(s,i);return c}function ecSign(t,e){var n=curves[e.curve.join(".")];if(!n)throw new Error("unknown curve "+e.curve.join("."));var r=new EC(n),i=r.genKeyPair();i._importPrivate(e.privateKey);var o=i.sign(t);return new Buffer(o.toDER())}function dsaSign(t,e,n){for(var c,r=e.params.priv_key,i=e.params.p,o=e.params.q,s=e.params.g,a=new BN(0),l=bits2int(t,o).mod(o),u=!1,h=getKey(r,o,t,n);u===!1;)c=makeKey(o,h,n),a=makeR(s,c,i,o),u=c.invm(o).imul(l.add(r.mul(a))).mod(o),u.cmpn(0)||(u=!1,a=new BN(0));return toDER(a,u)}function toDER(t,e){t=t.toArray(),e=e.toArray(),128&t[0]&&(t=[0].concat(t)),128&e[0]&&(e=[0].concat(e));var n=t.length+e.length+4,r=[48,n,2,t.length];return r=r.concat(t,[2,e.length],e),new Buffer(r)}function getKey(t,e,n,r){if(t=new Buffer(t.toArray()),t.length<e.byteLength()){var i=new Buffer(e.byteLength()-t.length);i.fill(0),t=Buffer.concat([i,t])}var o=n.length,s=bits2octets(n,e),a=new Buffer(o);a.fill(1);var c=new Buffer(o);return c.fill(0),c=createHmac(r,c).update(a).update(new Buffer([0])).update(t).update(s).digest(),a=createHmac(r,c).update(a).digest(),c=createHmac(r,c).update(a).update(new Buffer([1])).update(t).update(s).digest(),a=createHmac(r,c).update(a).digest(),{k:c,v:a}}function bits2int(t,e){var n=new BN(t),r=(t.length<<3)-e.bitLength();return r>0&&n.ishrn(r),n}function bits2octets(t,e){t=bits2int(t,e),t=t.mod(e);var n=new Buffer(t.toArray());if(n.length<e.byteLength()){var r=new Buffer(e.byteLength()-n.length);r.fill(0),n=Buffer.concat([r,n])}return n}function makeKey(t,e,n){var r,i;do{for(r=new Buffer("");8*r.length<t.bitLength();)e.v=createHmac(n,e.k).update(e.v).digest(),r=Buffer.concat([r,e.v]);i=bits2int(r,t),e.k=createHmac(n,e.k).update(e.v).update(new Buffer([0])).digest(),e.v=createHmac(n,e.k).update(e.v).digest()}while(-1!==i.cmp(t));return i}function makeR(t,e,n,r){return t.toRed(BN.mont(n)).redPow(e).fromRed().mod(r)}var createHmac=require("create-hmac"),crt=require("browserify-rsa"),curves=require("./curves"),elliptic=require("elliptic"),parseKeys=require("parse-asn1"),BN=require("bn.js"),EC=elliptic.ec;module.exports=sign,module.exports.getKey=getKey,module.exports.makeKey=makeKey;