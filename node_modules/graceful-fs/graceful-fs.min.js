function noop(){}function patch(t){function n(t,n,r){function i(t,n,r){return e(t,n,function(e){!e||"EMFILE"!==e.code&&"ENFILE"!==e.code?("function"==typeof r&&r.apply(this,arguments),retry()):enqueue([i,[t,n,r]])})}return"function"==typeof n&&(r=n,n=null),i(t,n,r)}function i(t,e,n,i){function o(t,e,n,i){return r(t,e,n,function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?("function"==typeof i&&i.apply(this,arguments),retry()):enqueue([o,[t,e,n,i]])})}return"function"==typeof n&&(i=n,n=null),o(t,e,n,i)}function s(t,e,n,r){function i(t,e,n,r){return o(t,e,n,function(o){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?("function"==typeof r&&r.apply(this,arguments),retry()):enqueue([i,[t,e,n,r]])})}return"function"==typeof n&&(r=n,n=null),i(t,e,n,r)}function c(t,e,n){function i(t,e){e&&e.sort&&e.sort(),!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?("function"==typeof n&&n.apply(this,arguments),retry()):enqueue([l,[r]])}var r=[t];return"function"!=typeof e?r.push(e):n=e,r.push(i),l(r)}function l(e){return a.apply(t,e)}function f(t,e){return this instanceof f?(h.apply(this,arguments),this):f.apply(Object.create(f.prototype),arguments)}function d(){var t=this;b(t.path,t.flags,t.mode,function(e,n){e?(t.autoClose&&t.destroy(),t.emit("error",e)):(t.fd=n,t.emit("open",n),t.read())})}function _(t,e){return this instanceof _?(p.apply(this,arguments),this):_.apply(Object.create(_.prototype),arguments)}function g(){var t=this;b(t.path,t.flags,t.mode,function(e,n){e?(t.destroy(),t.emit("error",e)):(t.fd=n,t.emit("open",n))})}function y(t,e){return new f(t,e)}function m(t,e){return new _(t,e)}function b(t,e,n,r){function i(t,e,n,r){return v(t,e,n,function(o,s){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?("function"==typeof r&&r.apply(this,arguments),retry()):enqueue([i,[t,e,n,r]])})}return"function"==typeof n&&(r=n,n=null),i(t,e,n,r)}polyfills(t),t.gracefulify=patch,t.FileReadStream=f,t.FileWriteStream=_,t.createReadStream=y,t.createWriteStream=m;var e=t.readFile;t.readFile=n;var r=t.writeFile;t.writeFile=i;var o=t.appendFile;o&&(t.appendFile=s);var a=t.readdir;if(t.readdir=c,"v0.8"===process.version.substr(0,4)){var u=legacy(t);f=u.ReadStream,_=u.WriteStream}var h=t.ReadStream;f.prototype=Object.create(h.prototype),f.prototype.open=d;var p=t.WriteStream;_.prototype=Object.create(p.prototype),_.prototype.open=g,t.ReadStream=f,t.WriteStream=_;var v=t.open;return t.open=b,t}function enqueue(t){debug("ENQUEUE",t[0].name,t[1]),queue.push(t)}function retry(){var t=queue.shift();t&&(debug("RETRY",t[0].name,t[1]),t[0].apply(null,t[1]))}var fs=require("fs"),polyfills=require("./polyfills.js"),legacy=require("./legacy-streams.js"),queue=[],util=require("util"),debug=noop;util.debuglog?debug=util.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(debug=function(){var t=util.format.apply(util,arguments);t="GFS4: "+t.split(/\n/).join("\nGFS4: "),console.error(t)}),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){debug(queue),require("assert").equal(queue.length,0)}),module.exports=patch(require("./fs.js")),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&(module.exports=patch(fs)),module.exports.close=fs.close=function(t){return function(e,n){return t.call(fs,e,function(t){t||retry(),"function"==typeof n&&n.apply(this,arguments)})}}(fs.close),module.exports.closeSync=fs.closeSync=function(t){return function(e){var n=t.apply(fs,arguments);return retry(),n}}(fs.closeSync);