function patch(t){constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&patchLchmod(t),t.lutimes||patchLutimes(t),t.chown=chownFix(t.chown),t.fchown=chownFix(t.fchown),t.lchown=chownFix(t.lchown),t.chmod=chmodFix(t.chmod),t.fchmod=chmodFix(t.fchmod),t.lchmod=chmodFix(t.lchmod),t.chownSync=chownFixSync(t.chownSync),t.fchownSync=chownFixSync(t.fchownSync),t.lchownSync=chownFixSync(t.lchownSync),t.chmodSync=chmodFixSync(t.chmodSync),t.fchmodSync=chmodFixSync(t.fchmodSync),t.lchmodSync=chmodFixSync(t.lchmodSync),t.stat=statFix(t.stat),t.fstat=statFix(t.fstat),t.lstat=statFix(t.lstat),t.statSync=statFixSync(t.statSync),t.fstatSync=statFixSync(t.fstatSync),t.lstatSync=statFixSync(t.lstatSync),t.lchmod||(t.lchmod=function(t,e,n){n&&process.nextTick(n)},t.lchmodSync=function(){}),t.lchown||(t.lchown=function(t,e,n,r){r&&process.nextTick(r)},t.lchownSync=function(){}),"win32"===platform&&(t.rename=function(e){return function(n,r,i){var o=Date.now(),s=0;e(n,r,function a(c){return c&&("EACCES"===c.code||"EPERM"===c.code)&&Date.now()-o<6e4?(setTimeout(function(){t.stat(r,function(t,o){t&&"ENOENT"===t.code?e(n,r,a):i(c)})},s),void(100>s&&(s+=10))):void(i&&i(c))})}}(t.rename)),t.read=function(e){return function(n,r,i,o,s,a){var c;if(a&&"function"==typeof a){var l=0;c=function(u,h,p){return u&&"EAGAIN"===u.code&&10>l?(l++,e.call(t,n,r,i,o,s,c)):void a.apply(this,arguments)}}return e.call(t,n,r,i,o,s,c)}}(t.read),t.readSync=function(e){return function(n,r,i,o,s){for(var a=0;;)try{return e.call(t,n,r,i,o,s)}catch(c){if("EAGAIN"===c.code&&10>a){a++;continue}throw c}}}(t.readSync)}function patchLchmod(t){t.lchmod=function(e,n,r){t.open(e,constants.O_WRONLY|constants.O_SYMLINK,n,function(e,i){return e?void(r&&r(e)):void t.fchmod(i,n,function(e){t.close(i,function(t){r&&r(e||t)})})})},t.lchmodSync=function(e,n){var o,r=t.openSync(e,constants.O_WRONLY|constants.O_SYMLINK,n),i=!0;try{o=t.fchmodSync(r,n),i=!1}finally{if(i)try{t.closeSync(r)}catch(s){}else t.closeSync(r)}return o}}function patchLutimes(t){constants.hasOwnProperty("O_SYMLINK")?(t.lutimes=function(e,n,r,i){t.open(e,constants.O_SYMLINK,function(e,o){return e?void(i&&i(e)):void t.futimes(o,n,r,function(e){t.close(o,function(t){i&&i(e||t)})})})},t.lutimesSync=function(e,n,r){var o,i=t.openSync(e,constants.O_SYMLINK),s=!0;try{o=t.futimesSync(i,n,r),s=!1}finally{if(s)try{t.closeSync(i)}catch(a){}else t.closeSync(i)}return o}):(t.lutimes=function(t,e,n,r){r&&process.nextTick(r)},t.lutimesSync=function(){})}function chmodFix(t){return t?function(e,n,r){return t.call(fs,e,n,function(t){chownErOk(t)&&(t=null),r&&r.apply(this,arguments)})}:t}function chmodFixSync(t){return t?function(e,n){try{return t.call(fs,e,n)}catch(r){if(!chownErOk(r))throw r}}:t}function chownFix(t){return t?function(e,n,r,i){return t.call(fs,e,n,r,function(t){chownErOk(t)&&(t=null),i&&i.apply(this,arguments)})}:t}function chownFixSync(t){return t?function(e,n,r){try{return t.call(fs,e,n,r)}catch(i){if(!chownErOk(i))throw i}}:t}function statFix(t){return t?function(e,n){return t.call(fs,e,function(t,e){return e?(e.uid<0&&(e.uid+=4294967296),e.gid<0&&(e.gid+=4294967296),void(n&&n.apply(this,arguments))):n.apply(this,arguments)})}:t}function statFixSync(t){return t?function(e){var n=t.call(fs,e);return n.uid<0&&(n.uid+=4294967296),n.gid<0&&(n.gid+=4294967296),n}:t}function chownErOk(t){if(!t)return!0;if("ENOSYS"===t.code)return!0;var e=!process.getuid||0!==process.getuid();return!e||"EINVAL"!==t.code&&"EPERM"!==t.code?!1:!0}var fs=require("./fs.js"),constants=require("constants"),origCwd=process.cwd,cwd=null,platform=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return cwd||(cwd=origCwd.call(process)),cwd};try{process.cwd()}catch(er){}var chdir=process.chdir;process.chdir=function(t){cwd=null,chdir.call(process,t)},module.exports=patch;