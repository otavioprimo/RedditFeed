"use strict";function bubbleChange(t){return function(e,n,i){t.completion[i.id]=n,t.finished||t.emit("change",e||t.name,t.completed(),t)}}var util=require("util"),TrackerBase=require("./tracker-base.js"),Tracker=require("./tracker.js"),TrackerStream=require("./tracker-stream.js"),TrackerGroup=module.exports=function(t){TrackerBase.call(this,t),this.parentGroup=null,this.trackers=[],this.completion={},this.weight={},this.totalWeight=0,this.finished=!1,this.bubbleChange=bubbleChange(this)};util.inherits(TrackerGroup,TrackerBase),TrackerGroup.prototype.nameInTree=function(){for(var t=[],e=this;e;)t.unshift(e.name),e=e.parentGroup;return t.join("/")},TrackerGroup.prototype.addUnit=function(t,e){if(t.addUnit){for(var n=this;n;){if(t===n)throw new Error("Attempted to add tracker group "+t.name+" to tree that already includes it "+this.nameInTree(this));n=n.parentGroup}t.parentGroup=this}return this.weight[t.id]=e||1,this.totalWeight+=this.weight[t.id],this.trackers.push(t),this.completion[t.id]=t.completed(),t.on("change",this.bubbleChange),this.finished||this.emit("change",t.name,this.completion[t.id],t),t},TrackerGroup.prototype.completed=function(){if(0===this.trackers.length)return 0;for(var t=1/this.totalWeight,e=0,n=0;n<this.trackers.length;n++){var i=this.trackers[n].id;e+=t*this.weight[i]*this.completion[i]}return e},TrackerGroup.prototype.newGroup=function(t,e){return this.addUnit(new TrackerGroup(t),e)},TrackerGroup.prototype.newItem=function(t,e,n){return this.addUnit(new Tracker(t,e),n)},TrackerGroup.prototype.newStream=function(t,e,n){return this.addUnit(new TrackerStream(t,e),n)},TrackerGroup.prototype.finish=function(){this.finished=!0,this.trackers.length||this.addUnit(new Tracker,1,!0);for(var t=0;t<this.trackers.length;t++){var e=this.trackers[t];e.finish(),e.removeListener("change",this.bubbleChange)}this.emit("change",this.name,1,this)};var buffer="                                  ";TrackerGroup.prototype.debug=function(t){t=t||0;var e=t?buffer.substr(0,t):"",n=e+(this.name||"top")+": "+this.completed()+"\n";return this.trackers.forEach(function(i){n+=i instanceof TrackerGroup?i.debug(t+1):e+" "+i.name+": "+i.completed()+"\n"}),n};