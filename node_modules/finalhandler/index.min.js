"use strict";function finalhandler(t,e,n){var r=n||{},i=r.env||process.env.NODE_ENV||"development",o=r.onerror;return function(n){var s,r=Object.create(null);if(!n&&e._header)return void debug("cannot 404 after headers sent");if(n){if(s=getErrorStatusCode(n)||e.statusCode,("number"!=typeof s||400>s||s>599)&&(s=500),n.headers&&(n.status===s||n.statusCode===s))for(var a=Object.keys(n.headers),c=0;c<a.length;c++){var l=a[c];r[l]=n.headers[l]}var u="production"===i?statuses[s]:n.stack||n.toString();u=escapeHtml(u).replace(/\n/g,"<br>").replace(/\x20{2}/g," &nbsp;")+"\n"}else s=404,u="Cannot "+escapeHtml(t.method)+" "+escapeHtml(t.originalUrl||t.url)+"\n";return debug("default %s",s),n&&o&&defer(o,n,t,e),e._header?(debug("cannot %d after headers sent",s),void t.socket.destroy()):void send(t,e,s,r,u)}}function getErrorStatusCode(t){return"number"==typeof t.status&&t.status>=400&&t.status<600?t.status:"number"==typeof t.statusCode&&t.statusCode>=400&&t.statusCode<600?t.statusCode:void 0}function send(t,e,n,r,i){function o(){e.statusCode=n,e.statusMessage=statuses[n];for(var o=Object.keys(r),s=0;s<o.length;s++){var a=o[s];e.setHeader(a,r[a])}return e.setHeader("X-Content-Type-Options","nosniff"),e.setHeader("Content-Type","text/html; charset=utf-8"),e.setHeader("Content-Length",Buffer.byteLength(i,"utf8")),"HEAD"===t.method?void e.end():void e.end(i,"utf8")}return isFinished(t)?void o():(unpipe(t),onFinished(t,o),void t.resume())}var debug=require("debug")("finalhandler"),escapeHtml=require("escape-html"),onFinished=require("on-finished"),statuses=require("statuses"),unpipe=require("unpipe"),defer="function"==typeof setImmediate?setImmediate:function(t){process.nextTick(t.bind.apply(t,arguments))},isFinished=onFinished.isFinished;module.exports=finalhandler;