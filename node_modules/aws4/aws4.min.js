function hmac(t,e,n){return crypto.createHmac("sha256",t).update(e,"utf8").digest(n)}function hash(t,e){return crypto.createHash("sha256").update(t,"utf8").digest(e)}function encodeRfc3986(t){return t.replace(/[!'()*]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})}function RequestSigner(t,e){"string"==typeof t&&(t=url.parse(t));var n=t.headers=t.headers||{},r=this.matchHost(t.hostname||t.host||n.Host||n.host);this.request=t,this.credentials=e||this.defaultCredentials(),this.service=t.service||r[0]||"",this.region=t.region||r[1]||"us-east-1","email"===this.service&&(this.service="ses"),!t.method&&t.body&&(t.method="POST"),n.Host||n.host||(n.Host=t.hostname||t.host||this.createHost(),t.port&&(n.Host+=":"+t.port)),t.hostname||t.host||(t.hostname=n.Host||n.host),this.isCodeCommitGit="codecommit"===this.service&&"GIT"===t.method}var aws4=exports,url=require("url"),querystring=require("querystring"),crypto=require("crypto"),lru=require("./lru"),credentialsCache=lru(1e3);RequestSigner.prototype.matchHost=function(t){var e=(t||"").match(/([^\.]+)\.(?:([^\.]*)\.)?amazonaws\.com$/),n=(e||[]).slice(1,3);return"es"===n[1]&&(n=n.reverse()),n},RequestSigner.prototype.isSingleRegion=function(){return["s3","sdb"].indexOf(this.service)>=0&&"us-east-1"===this.region?!0:["cloudfront","ls","route53","iam","importexport","sts"].indexOf(this.service)>=0},RequestSigner.prototype.createHost=function(){var t=this.isSingleRegion()?"":("s3"===this.service&&"us-east-1"!==this.region?"-":".")+this.region,e="ses"===this.service?"email":this.service;return e+t+".amazonaws.com"},RequestSigner.prototype.prepareRequest=function(){this.parsePath();var n,t=this.request,e=t.headers;t.signQuery?(this.parsedPath.query=n=this.parsedPath.query||{},this.credentials.sessionToken&&(n["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"!==this.service||n["X-Amz-Expires"]||(n["X-Amz-Expires"]=86400),n["X-Amz-Date"]?this.datetime=n["X-Amz-Date"]:n["X-Amz-Date"]=this.getDateTime(),n["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",n["X-Amz-Credential"]=this.credentials.accessKeyId+"/"+this.credentialString(),n["X-Amz-SignedHeaders"]=this.signedHeaders()):(t.doNotModifyHeaders||this.isCodeCommitGit||(!t.body||e["Content-Type"]||e["content-type"]||(e["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"),!t.body||e["Content-Length"]||e["content-length"]||(e["Content-Length"]=Buffer.byteLength(t.body)),this.credentials.sessionToken&&(e["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"===this.service&&(e["X-Amz-Content-Sha256"]=hash(this.request.body||"","hex")),e["X-Amz-Date"]?this.datetime=e["X-Amz-Date"]:e["X-Amz-Date"]=this.getDateTime()),delete e.Authorization,delete e.authorization)},RequestSigner.prototype.sign=function(){return this.parsedPath||this.prepareRequest(),this.request.signQuery?this.parsedPath.query["X-Amz-Signature"]=this.signature():this.request.headers.Authorization=this.authHeader(),this.request.path=this.formatPath(),this.request},RequestSigner.prototype.getDateTime=function(){if(!this.datetime){var t=this.request.headers,e=new Date(t.Date||t.date||new Date);this.datetime=e.toISOString().replace(/[:\-]|\.\d{3}/g,""),this.isCodeCommitGit&&(this.datetime=this.datetime.slice(0,-1))}return this.datetime},RequestSigner.prototype.getDate=function(){return this.getDateTime().substr(0,8)},RequestSigner.prototype.authHeader=function(){return["AWS4-HMAC-SHA256 Credential="+this.credentials.accessKeyId+"/"+this.credentialString(),"SignedHeaders="+this.signedHeaders(),"Signature="+this.signature()].join(", ")},RequestSigner.prototype.signature=function(){var n,r,i,t=this.getDate(),e=[this.credentials.secretAccessKey,t,this.region,this.service].join(),o=credentialsCache.get(e);return o||(n=hmac("AWS4"+this.credentials.secretAccessKey,t),r=hmac(n,this.region),i=hmac(r,this.service),o=hmac(i,"aws4_request"),credentialsCache.set(e,o)),hmac(o,this.stringToSign(),"hex")},RequestSigner.prototype.stringToSign=function(){return["AWS4-HMAC-SHA256",this.getDateTime(),this.credentialString(),hash(this.canonicalString(),"hex")].join("\n")},RequestSigner.prototype.canonicalString=function(){this.parsedPath||this.prepareRequest();var t=this.parsedPath.path,e=this.parsedPath.query,n="",r="s3"!==this.service,i="s3"===this.service||this.request.doNotEncodePath,o="s3"===this.service,s="s3"===this.service,a="s3"===this.service&&this.request.signQuery?"UNSIGNED-PAYLOAD":this.isCodeCommitGit?"":hash(this.request.body||"","hex");return e&&(n=encodeRfc3986(querystring.stringify(Object.keys(e).sort().reduce(function(t,n){return n?(t[n]=Array.isArray(e[n])?s?e[n][0]:e[n].slice().sort():e[n],t):t},{})))),"/"!==t&&(r&&(t=t.replace(/\/{2,}/g,"/")),t=t.split("/").reduce(function(t,e){return r&&".."===e?t.pop():r&&"."===e||(i&&(e=querystring.unescape(e)),t.push(encodeRfc3986(querystring.escape(e)))),t},[]).join("/"),"/"!==t[0]&&(t="/"+t),o&&(t=t.replace(/%2F/g,"/"))),[this.request.method||"GET",t,n,this.canonicalHeaders()+"\n",this.signedHeaders(),a].join("\n")},RequestSigner.prototype.canonicalHeaders=function(){function e(t){return t.toString().trim().replace(/\s+/g," ")}var t=this.request.headers;return Object.keys(t).sort(function(t,e){return t.toLowerCase()<e.toLowerCase()?-1:1}).map(function(n){return n.toLowerCase()+":"+e(t[n])}).join("\n")},RequestSigner.prototype.signedHeaders=function(){return Object.keys(this.request.headers).map(function(t){return t.toLowerCase()}).sort().join(";")},RequestSigner.prototype.credentialString=function(){return[this.getDate(),this.region,this.service,"aws4_request"].join("/")},RequestSigner.prototype.defaultCredentials=function(){var t=process.env;return{accessKeyId:t.AWS_ACCESS_KEY_ID||t.AWS_ACCESS_KEY,secretAccessKey:t.AWS_SECRET_ACCESS_KEY||t.AWS_SECRET_KEY,sessionToken:t.AWS_SESSION_TOKEN}},RequestSigner.prototype.parsePath=function(){var t=this.request.path||"/",e=t.indexOf("?"),n=null;e>=0&&(n=querystring.parse(t.slice(e+1)),t=t.slice(0,e)),/[^0-9A-Za-z!'()*\-._~%\/]/.test(t)&&(t=t.split("/").map(function(t){return querystring.escape(querystring.unescape(t))}).join("/")),this.parsedPath={path:t,query:n}},RequestSigner.prototype.formatPath=function(){var t=this.parsedPath.path,e=this.parsedPath.query;return e?(null!=e[""]&&delete e[""],t+"?"+encodeRfc3986(querystring.stringify(e))):t},aws4.RequestSigner=RequestSigner,aws4.sign=function(t,e){return new RequestSigner(t,e).sign()};