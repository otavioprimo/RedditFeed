function nameMatchFilter(e){return function(t){return e.name===t.name}}function wouldBreakCompatibility(e,t){for(var r=0;r<e.components.length;r++){var n=e.components[r],i=compactable[n.name],a=i&&i.canOverride||a.sameValue,o=shallowClone(n);if(o.value=[[i.defaultValue]],!a(o,n,t))return!0}return!1}function isComponentOf(e,t){return compactable[e.name].components.indexOf(t.name)>-1}function overrideIntoMultiplex(e,t){t.unused=!0,turnIntoMultiplex(t,multiplexSize(e)),e.value=t.value}function overrideByMultiplex(e,t){t.unused=!0,e.multiplex=!0,e.value=t.value}function overrideSimple(e,t){t.unused=!0,e.value=t.value}function override(e,t){t.multiplex?overrideByMultiplex(e,t):e.multiplex?overrideIntoMultiplex(e,t):overrideSimple(e,t)}function overrideShorthand(e,t){t.unused=!0;for(var r=0,n=e.components.length;n>r;r++)override(e.components[r],t.components[r],e.multiplex)}function turnIntoMultiplex(e,t){e.multiplex=!0;for(var r=0,n=e.components.length;n>r;r++){var i=e.components[r];if(!i.multiplex)for(var a=i.value.slice(0),o=1;t>o;o++)i.value.push([MULTIPLEX_SEPARATOR]),Array.prototype.push.apply(i.value,a)}}function multiplexSize(e){for(var t=0,r=0,n=e.value.length;n>r;r++)e.value[r][0]==MULTIPLEX_SEPARATOR&&t++;return t+1}function lengthOf(e){var t=[[e.name]].concat(e.value);return stringifyProperty([t],0).length}function moreSameShorthands(e,t,r){for(var n=0,i=t;i>=0&&(e[i].name!=r||e[i].unused||n++,!(n>1));i--);return n>1}function overridingFunction(e,t){for(var r=0,n=e.components.length;n>r;r++)if(anyValue(t.isValidFunction,e.components[r]))return!0;return!1}function anyValue(e,t){for(var r=0,n=t.value.length;n>r;r++)if(t.value[r][0]!=MULTIPLEX_SEPARATOR&&e(t.value[r][0]))return!0;return!1}function wouldResultInLongerValue(e,t){if(!e.multiplex&&!t.multiplex||e.multiplex&&t.multiplex)return!1;var i,r=e.multiplex?e:t,n=e.multiplex?t:e,a=deepClone(r);restoreFromOptimizing([a]);var o=deepClone(n);restoreFromOptimizing([o]);var s=lengthOf(a)+1+lengthOf(o);e.multiplex?(i=a.components.filter(nameMatchFilter(o))[0],overrideIntoMultiplex(i,o)):(i=o.components.filter(nameMatchFilter(a))[0],turnIntoMultiplex(o,multiplexSize(a)),overrideByMultiplex(i,a)),restoreFromOptimizing([o]);var u=lengthOf(o);return u>s}function isCompactable(e){return e.name in compactable}function noneOverrideHack(e,t){return!e.multiplex&&("background"==e.name||"background-image"==e.name)&&t.multiplex&&("background"==t.name||"background-image"==t.name)&&anyLayerIsNone(t.value)}function anyLayerIsNone(e){for(var t=intoLayers(e),r=0,n=t.length;n>r;r++)if(1==t[r].length&&"none"==t[r][0][0])return!0;return!1}function intoLayers(e){for(var t=[],r=0,n=[],i=e.length;i>r;r++){var a=e[r];a[0]==MULTIPLEX_SEPARATOR?(t.push(n),n=[]):n.push(a)}return t.push(n),t}function compactOverrides(e,t,r){var n,i,a,o,s,u,l;e:for(s=e.length-1;s>=0;s--)if(i=e[s],isCompactable(i)&&!i.variable)for(n=compactable[i.name].canOverride||canOverride.sameValue,u=s-1;u>=0;u--)if(a=e[u],isCompactable(a)&&!(a.variable||a.unused||i.unused||a.hack&&!i.hack||!a.hack&&i.hack||hasInherit(i)||noneOverrideHack(a,i)))if(!a.shorthand&&i.shorthand&&isComponentOf(i,a)){if(!i.important&&a.important)continue;if(!sameVendorPrefixesIn([a],i.components))continue;if(!anyValue(r.isValidFunction,a)&&overridingFunction(i,r))continue;o=i.components.filter(nameMatchFilter(a))[0],n=compactable[a.name]&&compactable[a.name].canOverride||canOverride.sameValue,everyCombination(n,a,o,r)&&(a.unused=!0)}else if(a.shorthand&&!i.shorthand&&isComponentOf(a,i)){if(i.important&&!a.important)continue;if(!i.important&&a.important){i.unused=!0;continue}if(moreSameShorthands(e,s-1,a.name))continue;if(overridingFunction(a,r))continue;if(o=a.components.filter(nameMatchFilter(i))[0],everyCombination(n,o,i,r)){var c=!t.properties.backgroundClipMerging&&o.name.indexOf("background-clip")>-1||!t.properties.backgroundOriginMerging&&o.name.indexOf("background-origin")>-1||!t.properties.backgroundSizeMerging&&o.name.indexOf("background-size")>-1,f=compactable[i.name].nonMergeableValue===i.value[0][0];if(c||f)continue;if(!t.properties.merging&&wouldBreakCompatibility(a,r))continue;if(o.value[0][0]!=i.value[0][0]&&(hasInherit(a)||hasInherit(i)))continue;if(wouldResultInLongerValue(a,i))continue;!a.multiplex&&i.multiplex&&turnIntoMultiplex(a,multiplexSize(i)),override(o,i),a.dirty=!0}}else if(a.shorthand&&i.shorthand&&a.name==i.name){if(!a.multiplex&&i.multiplex)continue;if(!i.important&&a.important){i.unused=!0;continue e}if(i.important&&!a.important){a.unused=!0;continue}for(l=a.components.length-1;l>=0;l--){var p=a.components[l],h=i.components[l];if(n=compactable[p.name].canOverride||canOverride.sameValue,!everyCombination(n,p,h,r))continue e;if(!everyCombination(canOverride.twoOptionalFunctions,p,h,r)&&r.isValidFunction(h))continue e}overrideShorthand(a,i),a.dirty=!0}else if(a.shorthand&&i.shorthand&&isComponentOf(a,i)){if(!a.important&&i.important)continue;if(o=a.components.filter(nameMatchFilter(i))[0],n=compactable[i.name].canOverride||canOverride.sameValue,!everyCombination(n,o,i,r))continue;if(a.important&&!i.important){i.unused=!0;continue}var d=compactable[i.name].restore(i,compactable);if(d.length>1)continue;o=a.components.filter(nameMatchFilter(i))[0],override(o,i),i.dirty=!0}else if(a.name==i.name){if(a.important&&!i.important){i.unused=!0;continue}if(n=compactable[i.name].canOverride||canOverride.sameValue,!everyCombination(n,a,i,r))continue;a.unused=!0}}var canOverride=require("./can-override"),compactable=require("./compactable"),deepClone=require("./clone").deep,shallowClone=require("./clone").shallow,hasInherit=require("./has-inherit"),restoreFromOptimizing=require("./restore-from-optimizing"),everyCombination=require("./every-combination"),sameVendorPrefixesIn=require("./vendor-prefixes").same,stringifyProperty=require("../stringifier/one-time").property,MULTIPLEX_SEPARATOR=",";module.exports=compactOverrides;