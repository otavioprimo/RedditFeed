function tokenize(e,t){var r=split(normalize(e),"}",!0,"{","}");if(0===r.length)return[];var n={chunk:r.shift(),chunks:r,column:0,cursor:0,line:1,mode:"top",resolvePath:t.options.explicitTarget?relativePathResolver(t.options.root,t.options.target):null,source:void 0,sourceMap:t.options.sourceMap,sourceMapInlineSources:t.options.sourceMapInlineSources,sourceMapTracker:t.inputSourceMapTracker,sourceReader:t.sourceReader,sourceTracker:t.sourceTracker,state:[],track:t.options.sourceMap?function(e,t,r){return[[track(e,n,t,r)]]}:function(){return[]},warnings:t.warnings};return intoTokens(n)}function normalize(e){return e.replace(/\r\n/g,"\n")}function relativePathResolver(e,t){var r=path.relative(e,t);return function(e,t){return e!=t?path.normalize(path.join(path.relative(r,path.dirname(e)),t)):t}}function whatsNext(e){var n,t=e.mode,r=e.chunk;if(r.length==e.cursor){if(0===e.chunks.length)return null;e.chunk=r=e.chunks.shift(),e.cursor=0}if("body"==t)return"}"==r[e.cursor]?[e.cursor,"bodyEnd"]:-1==r.indexOf("}",e.cursor)?null:(n=e.cursor+split(r.substring(e.cursor-1),"}",!0,"{","}")[0].length-2,[n,"bodyEnd"]);var i=r.indexOf("@",e.cursor),a=r.indexOf("__ESCAPED_",e.cursor),o=r.indexOf("{",e.cursor),s=r.indexOf("}",e.cursor);return a>-1&&/\S/.test(r.substring(e.cursor,a))&&(a=-1),n=i,(-1==n||a>-1&&n>a)&&(n=a),(-1==n||o>-1&&n>o)&&(n=o),(-1==n||s>-1&&n>s)&&(n=s),-1!=n?a===n?[n,"escape"]:o===n?[n,"bodyStart"]:s===n?[n,"bodyEnd"]:i===n?[n,"special"]:void 0:void 0}function intoTokens(e){for(var n,i,t=e.chunk,r=[];;){var a=whatsNext(e);if(!a){var o=e.chunk.substring(e.cursor);o.trim().length>0&&("body"==e.mode?e.warnings.push("Missing '}' after '"+o+"'. Ignoring."):r.push(["text",[o]]),e.cursor+=o.length);break}var l,c,s=a[0],u=a[1];if(t=e.chunk,e.cursor!=s&&"bodyEnd"!=u){var f=t.substring(e.cursor,s),p=/^\s+/.exec(f);p&&(e.cursor+=p[0].length,e.track(p[0]))}if("special"==u){var h=t.indexOf("{",s),d=t.indexOf(";",s),v=d>-1&&(-1==h||h>d),m=-1==h&&-1==d;if(m)e.warnings.push("Broken declaration: '"+t.substring(e.cursor)+"'."),e.cursor=t.length;else if(v)l=t.indexOf(";",s+1),i=t.substring(e.cursor,l+1),r.push(["at-rule",[i].concat(e.track(i,!0))]),e.track(";"),e.cursor=l+1;else{l=t.indexOf("{",s+1),i=t.substring(e.cursor,l);var g=i.trim(),y=flatBlock.test(g);c=e.mode,e.cursor=l+1,e.mode=y?"body":"block",n=[y?"flat-block":"block"],n.push([g].concat(e.track(i,!0))),e.track("{"),n.push(intoTokens(e)),"string"==typeof n[2]&&(n[2]=extractProperties(n[2],[[g]],e)),e.mode=c,e.track("}"),r.push(n)}}else if("escape"==u){l=t.indexOf("__",s+1);var b=t.substring(e.cursor,l+2),_=!!e.sourceTracker.nextStart(b),w=!!e.sourceTracker.nextEnd(b);if(_)e.track(b),e.state.push({source:e.source,line:e.line,column:e.column}),e.source=e.sourceTracker.nextStart(b).filename,e.line=1,e.column=0;else if(w){var x=e.state.pop();e.source=x.source,e.line=x.line,e.column=x.column,e.track(b)}else 0===b.indexOf("__ESCAPED_COMMENT_SPECIAL")&&r.push(["text",[b]]),e.track(b);e.cursor=l+2}else if("bodyStart"==u){var E=extractSelectors(t.substring(e.cursor,s),e);c=e.mode,e.cursor=s+1,e.mode="body";var S=extractProperties(intoTokens(e),E,e);e.track("{"),e.mode=c,r.push(["selector",E,S])}else if("bodyEnd"==u){if("top"==e.mode){var k=e.cursor,C="}"==t[e.cursor]?"Unexpected '}' in '"+t.substring(k-20,k+20)+"'. Ignoring.":"Unexpected content: '"+t.substring(k,s+1)+"'. Ignoring.";e.warnings.push(C),e.cursor=s+1;continue}"block"==e.mode&&e.track(t.substring(e.cursor,s)),"block"!=e.mode&&(r=t.substring(e.cursor,s)),e.cursor=s+1;break}}return r}var extractProperties=require("./extract-properties"),extractSelectors=require("./extract-selectors"),track=require("../source-maps/track"),split=require("../utils/split"),path=require("path"),flatBlock=/(@(font\-face|page|\-ms\-viewport|\-o\-viewport|viewport|counter\-style)|\\@.+?)/;module.exports=tokenize;