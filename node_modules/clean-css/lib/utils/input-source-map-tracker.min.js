function InputSourceMapStore(e){this.options=e.options,this.errors=e.errors,this.warnings=e.warnings,this.sourceTracker=e.sourceTracker,this.timeout=this.options.inliner.timeout,this.requestOptions=this.options.inliner.request,this.localOnly=e.localOnly,this.relativeTo=e.options.target||process.cwd(),this.maps={},this.sourcesContent={}}function fromString(e,t,r){return e.trackLoaded(void 0,void 0,e.options.sourceMap),r()}function fromSource(e,t,r,n){function a(){n.cursor+=i+1,fromSource(e,t,r,n)}for(var i=0;n.cursor<t.length;){var s=t.substring(n.cursor),o=e.sourceTracker.nextStart(s)||{index:-1},u=e.sourceTracker.nextEnd(s)||{index:-1},l=MAP_MARKER.exec(s)||{index:-1},c=l[1];if(i=t.length,o.index>-1&&(i=o.index),u.index>-1&&u.index<i&&(i=u.index),l.index>-1&&l.index<i&&(i=l.index),i==t.length)break;if(i==o.index)n.files.push(o.filename);else if(i==u.index)n.files.pop();else if(i==l.index){var f=/^https?:\/\//.test(c)||/^\/\//.test(c),p=DATA_URI.test(c);if(f)return fetchMapFile(e,c,n,a);var d,v,h=n.files[n.files.length-1],m=h?path.dirname(h):e.options.relativeTo;p?(d=path.resolve(e.options.root,h||""),v=fromDataUri(c)):(d=path.resolve(e.options.root,path.join(m||"",c)),v=fs.readFileSync(d,"utf-8")),e.trackLoaded(h||void 0,d,v)}n.cursor+=i+1}return r()}function fromDataUri(e){var t=DATA_URI.exec(e),r=t[2]?t[2].split(/[=;]/)[2]:"us-ascii",n=t[3]?t[3].split(";")[1]:"utf8",i="utf8"==n?unescape(t[4]):t[4],a=new Buffer(i,n);return a.charset=r,a.toString()}function fetchMapFile(e,t,r,n){fetch(e,t,function(i){e.trackLoaded(r.files[r.files.length-1]||void 0,t,i),n()},function(e){return r.errors.push('Broken source map at "'+t+'" - '+e),n()})}function fetch(e,t,r,n){var i=0===t.indexOf("https")?https:http,a=override(url.parse(t),e.requestOptions),s=!1;i.get(a,function(e){if(e.statusCode<200||e.statusCode>299)return n(e.statusCode);var t=[];e.on("data",function(e){t.push(e.toString())}),e.on("end",function(){r(t.join(""))})}).on("error",function(e){s||(n(e.message),s=!0)}).on("timeout",function(){s||(n("timeout"),s=!0)}).setTimeout(e.timeout)}function originalPositionIn(e,t,r,n,i){for(var a,s=n.length,o={line:t,column:r+s};s-->0&&(o.column--,!(a=e.data.originalPositionFor(o))););return null===a.line&&t>1&&i>0?originalPositionIn(e,t-1,r,n,i-1):(e.path&&a.source&&(a.source=REMOTE_RESOURCE.test(e.path)?url.resolve(e.path,a.source):path.join(e.path,a.source),a.sourceResolved=!0),a)}function trackContentSources(e,t){var r=e.maps[t].data,n=REMOTE_RESOURCE.test(t),i={};r.sources.forEach(function(a,s){var o=n?url.resolve(path.dirname(t),a):path.relative(e.relativeTo,path.resolve(path.dirname(t||"."),a));i[o]=r.sourcesContent&&r.sourcesContent[s]}),e.sourcesContent[t]=i}function _resolveSources(e,t,r){function n(){return _resolveSources(e,t,r)}if(0===t.length)return r();var i=t.shift(),a=i[0],s=i[1],o=REMOTE_RESOURCE.test(a);if(o&&e.localOnly)return e.warnings.push('No callback given to `#minify` method, cannot fetch a remote file from "'+s+'"'),n();if(!o){var u=path.join(e.options.root,s);return fs.existsSync(u)?e.sourcesContent[a][s]=fs.readFileSync(u,"utf-8"):e.warnings.push('Missing original source file at "'+u+'".'),n()}fetch(e,s,function(t){e.sourcesContent[a][s]=t,n()},function(t){e.warnings.push('Broken original source file at "'+s+'" - '+t),n()})}var SourceMapConsumer=require("source-map").SourceMapConsumer,fs=require("fs"),path=require("path"),http=require("http"),https=require("https"),url=require("url"),override=require("../utils/object.js").override,MAP_MARKER=/\/\*# sourceMappingURL=(\S+) \*\//,REMOTE_RESOURCE=/^(https?:)?\/\//,DATA_URI=/^data:(\S*?)?(;charset=[^;]+)?(;[^,]+?)?,(.+)/,unescape=global.unescape;InputSourceMapStore.prototype.track=function(e,t){return"string"==typeof this.options.sourceMap?fromString(this,e,t):fromSource(this,e,t,{files:[],cursor:0,errors:this.errors})},InputSourceMapStore.prototype.trackLoaded=function(e,t,r){var n=this.options.explicitTarget?this.options.target:this.options.root,i=REMOTE_RESOURCE.test(e);t&&(t=i?path.dirname(t):path.dirname(path.relative(n,t))),this.maps[e]={path:t,data:new SourceMapConsumer(r)},trackContentSources(this,e)},InputSourceMapStore.prototype.isTracking=function(e){return!!this.maps[e]},InputSourceMapStore.prototype.originalPositionFor=function(e,t,r){return originalPositionIn(this.maps[e.source],e.line,e.column,t,r)},InputSourceMapStore.prototype.sourcesContentFor=function(e){return this.sourcesContent[e]},InputSourceMapStore.prototype.resolveSources=function(e){var t=[];for(var r in this.sourcesContent){var n=this.sourcesContent[r];for(var i in n)n[i]||t.push([r,i])}return _resolveSources(this,t,e)},module.exports=InputSourceMapStore;