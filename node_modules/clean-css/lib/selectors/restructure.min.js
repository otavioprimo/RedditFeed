function naturalSorter(e,t){return e>t}function cloneAndMergeSelectors(e,t){var r=cloneArray(e);return r[5]=r[5].concat(t[5]),r}function restructure(e,t){function u(e,t,r){for(var n=r.length-1;n>=0;n--){var a=r[n][0],o=l(t,a);if(i[o].length>1&&w(e,i[o])){c(o);break}}}function l(e,t){var r=f(t);return i[r]=i[r]||[],i[r].push([e,t]),r}function c(e){var n,t=e.split(s),r=[];for(var a in i){var o=a.split(s);for(n=o.length-1;n>=0;n--)if(t.indexOf(o[n])>-1){r.push(a);break}}for(n=r.length-1;n>=0;n--)delete i[r[n]]}function f(e){for(var t=[],r=0,n=e.length;n>r;r++)t.push(stringifySelectors(e[r][1]));return t.join(s)}function p(e){for(var r=[],n=[],i=e.length-1;i>=0;i--)isSpecial(t,stringifySelectors(e[i][1]))||(n.unshift(e[i]),e[i][2].length>0&&-1==r.indexOf(e[i])&&r.push(e[i]));return r.length>1?n:[]}function h(e,t){var n=t[0],i=t[1],a=t[4],o=n.length+i.length+1,s=[],l=[],c=p(r[a]);if(!(c.length<2)){var f=v(c,o,1),h=f[0];if(h[1]>0)return u(e,t,f);for(var d=h[0].length-1;d>=0;d--)s=h[0][d][1].concat(s),l.unshift(h[0][d]);s=cleanUpSelectorDuplicates(s),y(e,[t],s,l)}}function d(e,t){return e[1]>t[1]}function v(e,t,r){var n=m(e,t,r,o-1);return n.sort(d)}function m(e,t,r,n){var i=[[e,g(e,t,r)]];if(e.length>2&&n>0)for(var a=e.length-1;a>=0;a--){var o=Array.prototype.slice.call(e,0);o.splice(a,1),i=i.concat(m(o,t,r,n-1))}return i}function g(e,t,r){for(var n=0,i=e.length-1;i>=0;i--)n+=e[i][2].length>r?stringifySelectors(e[i][1]).length:-1;return n-(e.length-1)*t+1}function y(t,r,n,i){var a,o,s,u,l=[];for(a=i.length-1;a>=0;a--){var c=i[a];for(o=c[2].length-1;o>=0;o--){var f=c[2][o];for(s=0,u=r.length;u>s;s++){var p=r[s],h=f[0][0],d=p[0],v=p[4];if(h==d&&stringifyBody([f])==v){c[2].splice(o,1);break}}}}for(a=r.length-1;a>=0;a--)l.unshift(r[a][3]);var m=["selector",n,l];e.splice(t,0,m)}function b(e,t){var n=t[4],i=r[n];i&&i.length>1&&(_(e,t)||h(e,t))}function _(e,t){var s,u,i=[],a=[],o=t[4],l=p(r[o]);if(!(l.length<2)){e:for(var c in r){var f=r[c];for(s=l.length-1;s>=0;s--)if(-1==f.indexOf(l[s]))continue e;i.push(c)}if(i.length<2)return!1;for(s=i.length-1;s>=0;s--)for(u=n.length-1;u>=0;u--)if(n[u][4]==i[s]){a.unshift([n[u],l]);break}return w(e,a)}}function w(e,t){for(var s,i=0,o=[],u=t.length-1;u>=0;u--){s=t[u][0];var l=s[4];i+=l.length+(u>0?1:0),o.push(s)}var c=t[0][1],f=v(c,i,o.length)[0];if(f[1]>0)return!1;var p=[],h=[];for(u=f[0].length-1;u>=0;u--)p=f[0][u][1].concat(p),h.unshift(f[0][u]);for(p=cleanUpSelectorDuplicates(p),y(e,o,p,h),u=o.length-1;u>=0;u--){s=o[u];var d=n.indexOf(s);delete r[s[4]],d>-1&&-1==a.indexOf(d)&&a.push(d)}return!0}function x(e,t,n){var i=e[0],a=t[0];if(i!=a)return!1;var o=t[4],s=r[o];return s&&s.indexOf(n)>-1}for(var r={},n=[],i={},a=[],o=2,s="%",E=e.length-1;E>=0;E--){var k,C,A,P,T,S=e[E];if("selector"==S[0])k=!0;else{if("block"!=S[0])continue;k=!1}var O=n.length,N=extractProperties(S);a=[];var q=[];for(C=N.length-1;C>=0;C--)for(A=C-1;A>=0;A--)if(!canReorderSingle(N[C],N[A])){q.push(C);break}for(C=N.length-1;C>=0;C--){var B=N[C],R=!1;for(A=0;O>A;A++){var I=n[A];-1!=a.indexOf(A)||canReorderSingle(B,I)||x(B,I,S)||(b(E+1,I,S),-1==a.indexOf(A)&&(a.push(A),delete r[I[4]])),R||(R=B[0]==I[0]&&B[1]==I[1],R&&(T=A))}if(k&&!(q.indexOf(C)>-1)){var M=B[4];r[M]=r[M]||[],r[M].push(S),R?n[T]=cloneAndMergeSelectors(n[T],B):n.push(B)}}for(a=a.sort(naturalSorter),C=0,P=a.length;P>C;C++){var D=a[C]-C;n.splice(D,1)}}for(var j=e[0]&&"at-rule"==e[0][0]&&0===e[0][1][0].indexOf("@charset")?1:0;j<e.length-1;j++){var L="at-rule"===e[j][0]&&0===e[j][1][0].indexOf("@import"),F="text"===e[j][0]&&0===e[j][1][0].indexOf("__ESCAPED_COMMENT_SPECIAL");if(!L&&!F)break}for(E=0;E<n.length;E++)b(j,n[E])}var extractProperties=require("./extractor"),canReorderSingle=require("./reorderable").canReorderSingle,stringifyBody=require("../stringifier/one-time").body,stringifySelectors=require("../stringifier/one-time").selectors,cleanUpSelectorDuplicates=require("./clean-up").selectorDuplicates,isSpecial=require("./is-special"),cloneArray=require("../utils/clone-array");module.exports=restructure;