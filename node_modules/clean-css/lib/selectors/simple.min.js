function isNegative(e,t){return e.value[t]&&"-"==e.value[t][0][0]&&parseFloat(e.value[t][0])<0}function zeroMinifier(e,t){return-1==t.indexOf("0")?t:(t.indexOf("-")>-1&&(t=t.replace(/([^\w\d\-]|^)\-0([^\.]|$)/g,"$10$2").replace(/([^\w\d\-]|^)\-0([^\.]|$)/g,"$10$2")),t.replace(/(^|\s)0+([1-9])/g,"$1$2").replace(/(^|\D)\.0+(\D|$)/g,"$10$2").replace(/(^|\D)\.0+(\D|$)/g,"$10$2").replace(/\.([1-9]*)0+(\D|$)/g,function(e,t,r){return(t.length>0?".":"")+t+r}).replace(/(^|\D)0\.(\d)/g,"$1.$2"))}function zeroDegMinifier(e,t){return-1==t.indexOf("0deg")?t:t.replace(/\(0deg\)/g,"(0)")}function whitespaceMinifier(e,t){return e.indexOf("filter")>-1||-1==t.indexOf(" ")?t:(t=t.replace(/\s+/g," "),t.indexOf("calc")>-1&&(t=t.replace(/\) ?\/ ?/g,")/ ")),t.replace(/\( /g,"(").replace(/ \)/g,")").replace(/, /g,","))}function precisionMinifier(e,t,r){return-1===r.value||-1===t.indexOf(".")?t:t.replace(r.regexp,function(e,t){return Math.round(parseFloat(t)*r.multiplier)/r.multiplier+"px"}).replace(/(\d)\.($|\D)/g,"$1$2")}function unitMinifier(e,t,r){return/^(?:\-moz\-calc|\-webkit\-calc|calc)\(/.test(t)?t:"flex"==e||"-ms-flex"==e||"-webkit-flex"==e||"flex-basis"==e||"-webkit-flex-basis"==e?t:t.indexOf("%")>0&&("height"==e||"max-height"==e)?t:t.replace(r,"$10$2").replace(r,"$10$2")}function multipleZerosMinifier(e){var r,t=e.value;4==t.length&&"0"===t[0][0]&&"0"===t[1][0]&&"0"===t[2][0]&&"0"===t[3][0]&&(r=e.name.indexOf("box-shadow")>-1?2:1),r&&(e.value.splice(r),e.dirty=!0)}function colorMininifier(e,t,r){return-1===t.indexOf("#")&&-1==t.indexOf("rgb")&&-1==t.indexOf("hsl")?HexNameShortener.shorten(t):(t=t.replace(/rgb\((\-?\d+),(\-?\d+),(\-?\d+)\)/g,function(e,t,r,n){return new RGB(t,r,n).toHex()}).replace(/hsl\((-?\d+),(-?\d+)%?,(-?\d+)%?\)/g,function(e,t,r,n){return new HSL(t,r,n).toHex()}).replace(/(^|[^='"])#([0-9a-f]{6})/gi,function(e,t,r){return r[0]==r[1]&&r[2]==r[3]&&r[4]==r[5]?t+"#"+r[0]+r[2]+r[4]:t+"#"+r}).replace(/(rgb|rgba|hsl|hsla)\(([^\)]+)\)/g,function(e,t,r){var n=r.split(","),i="hsl"==t&&3==n.length||"hsla"==t&&4==n.length||"rgb"==t&&3==n.length&&r.indexOf("%")>0||"rgba"==t&&4==n.length&&r.indexOf("%")>0;return i?(-1==n[1].indexOf("%")&&(n[1]+="%"),-1==n[2].indexOf("%")&&(n[2]+="%"),t+"("+n.join(",")+")"):e}),r.colors.opacity&&-1==e.indexOf("background")&&(t=t.replace(/(?:rgba|hsla)\(0,0%?,0%?,0\)/g,function(e){return split(t,",").pop().indexOf("gradient(")>-1?e:"transparent"})),HexNameShortener.shorten(t))}function pixelLengthMinifier(e,t,r){return WHOLE_PIXEL_VALUE.test(t)?t.replace(WHOLE_PIXEL_VALUE,function(e,t){var n,i=parseInt(t);return 0===i?e:(r.properties.shorterLengthUnits&&r.units.pt&&3*i%4===0&&(n=3*i/4+"pt"),r.properties.shorterLengthUnits&&r.units.pc&&i%16===0&&(n=i/16+"pc"),r.properties.shorterLengthUnits&&r.units["in"]&&i%96===0&&(n=i/96+"in"),n&&(n=e.substring(0,e.indexOf(t))+n),n&&n.length<e.length?n:e)}):t}function timeUnitMinifier(e,t){return TIME_VALUE.test(t)?t.replace(TIME_VALUE,function(e,t,r){var n;return"ms"==r?n=parseInt(t)/1e3+"s":"s"==r&&(n=1e3*parseFloat(t)+"ms"),n.length<e.length?n:e}):t}function minifyBorderRadius(e){var r,t=e.value;3==t.length&&"/"==t[1][0]&&t[0][0]==t[2][0]?r=1:5==t.length&&"/"==t[2][0]&&t[0][0]==t[3][0]&&t[1][0]==t[4][0]?r=2:7==t.length&&"/"==t[3][0]&&t[0][0]==t[4][0]&&t[1][0]==t[5][0]&&t[2][0]==t[6][0]?r=3:9==t.length&&"/"==t[4][0]&&t[0][0]==t[5][0]&&t[1][0]==t[6][0]&&t[2][0]==t[7][0]&&t[3][0]==t[8][0]&&(r=4),r&&(e.value.splice(r),e.dirty=!0)}function minifyFilter(e){1==e.value.length&&(e.value[0][0]=e.value[0][0].replace(/progid:DXImageTransform\.Microsoft\.(Alpha|Chroma)(\W)/,function(e,t,r){return t.toLowerCase()+r})),e.value[0][0]=e.value[0][0].replace(/,(\S)/g,", $1").replace(/ ?= ?/g,"=")}function minifyFont(e){var t=e.value,r=FONT_NUMERAL_WEIGHTS.indexOf(t[0][0])>-1||t[1]&&FONT_NUMERAL_WEIGHTS.indexOf(t[1][0])>-1||t[2]&&FONT_NUMERAL_WEIGHTS.indexOf(t[2][0])>-1;if(!r&&"/"!=t[1]){var n=0;if("normal"==t[0][0]&&n++,t[1]&&"normal"==t[1][0]&&n++,t[2]&&"normal"==t[2][0]&&n++,!(n>1)){var i;FONT_NAME_WEIGHTS_WITHOUT_NORMAL.indexOf(t[0][0])>-1?i=0:t[1]&&FONT_NAME_WEIGHTS_WITHOUT_NORMAL.indexOf(t[1][0])>-1?i=1:t[2]&&FONT_NAME_WEIGHTS_WITHOUT_NORMAL.indexOf(t[2][0])>-1?i=2:FONT_NAME_WEIGHTS.indexOf(t[0][0])>-1?i=0:t[1]&&FONT_NAME_WEIGHTS.indexOf(t[1][0])>-1?i=1:t[2]&&FONT_NAME_WEIGHTS.indexOf(t[2][0])>-1&&(i=2),void 0!==i&&(e.value[i][0]=valueMinifiers["font-weight"](t[i][0]),e.dirty=!0)}}}function optimizeBody(e,t){for(var r,n,i,a=wrapForOptimizing(e),o=0,s=a.length;s>o;o++)if(r=a[o],n=r.name,r.hack&&(("star"==r.hack||"underscore"==r.hack)&&!t.compatibility.properties.iePrefixHack||"backslash"==r.hack&&!t.compatibility.properties.ieSuffixHack||"bang"==r.hack&&!t.compatibility.properties.ieBangHack)&&(r.unused=!0),0===n.indexOf("padding")&&(isNegative(r,0)||isNegative(r,1)||isNegative(r,2)||isNegative(r,3))&&(r.unused=!0),!r.unused)if(r.variable)r.block&&optimizeBody(r.value[0],t);else{for(var u=0,l=r.value.length;l>u;u++)i=r.value[u][0],valueMinifiers[n]&&(i=valueMinifiers[n](i,u,l)),i=whitespaceMinifier(n,i),i=precisionMinifier(n,i,t.precision),i=pixelLengthMinifier(n,i,t.compatibility),i=timeUnitMinifier(n,i),i=zeroMinifier(n,i),t.compatibility.properties.zeroUnits&&(i=zeroDegMinifier(n,i),i=unitMinifier(n,i,t.unitsRegexp)),t.compatibility.properties.colors&&(i=colorMininifier(n,i,t.compatibility)),r.value[u][0]=i;multipleZerosMinifier(r),0===n.indexOf("border")&&n.indexOf("radius")>0?minifyBorderRadius(r):"filter"==n?minifyFilter(r):"font"==n&&minifyFont(r)}restoreFromOptimizing(a,!0),removeUnused(a)}function cleanupCharsets(e){for(var t=!1,r=0,n=e.length;n>r;r++){var i=e[r];"at-rule"==i[0]&&CHARSET_REGEXP.test(i[1][0])&&(t||-1==i[1][0].indexOf(CHARSET_TOKEN)?(e.splice(r,1),r--,n--):(t=!0,e.splice(r,1),e.unshift(["at-rule",[i[1][0].replace(CHARSET_REGEXP,CHARSET_TOKEN)]])))}}function buildUnitRegexp(e){var t=["px","em","ex","cm","mm","in","pt","pc","%"],r=["ch","rem","vh","vm","vmax","vmin","vw"];return r.forEach(function(r){e.compatibility.units[r]&&t.push(r)}),new RegExp("(^|\\s|\\(|,)0(?:"+t.join("|")+")(\\W|$)","g")}function buildPrecision(e){var t={};return t.value=void 0===e.roundingPrecision?DEFAULT_ROUNDING_PRECISION:e.roundingPrecision,t.multiplier=Math.pow(10,t.value),t.regexp=new RegExp("(\\d*\\.\\d{"+(t.value+1)+",})px","g"),t}function optimize(e,t){var r=t.compatibility.selectors.ie7Hack,n=t.compatibility.selectors.adjacentSpace,i=t.compatibility.properties.spaceAfterClosingBrace,a=!1;t.unitsRegexp=buildUnitRegexp(t),t.precision=buildPrecision(t);for(var o=0,s=e.length;s>o;o++){var u=e[o];switch(u[0]){case"selector":u[1]=cleanUpSelectors(u[1],!r,n),optimizeBody(u[2],t);break;case"block":cleanUpBlock(u[1],i),optimize(u[2],t);break;case"flat-block":cleanUpBlock(u[1],i),optimizeBody(u[2],t);break;case"at-rule":cleanUpAtRule(u[1]),a=!0}(0===u[1].length||u[2]&&0===u[2].length)&&(e.splice(o,1),o--,s--)}a&&cleanupCharsets(e)}var cleanUpSelectors=require("./clean-up").selectors,cleanUpBlock=require("./clean-up").block,cleanUpAtRule=require("./clean-up").atRule,split=require("../utils/split"),RGB=require("../colors/rgb"),HSL=require("../colors/hsl"),HexNameShortener=require("../colors/hex-name-shortener"),wrapForOptimizing=require("../properties/wrap-for-optimizing").all,restoreFromOptimizing=require("../properties/restore-from-optimizing"),removeUnused=require("../properties/remove-unused"),DEFAULT_ROUNDING_PRECISION=2,CHARSET_TOKEN="@charset",CHARSET_REGEXP=new RegExp("^"+CHARSET_TOKEN,"i"),FONT_NUMERAL_WEIGHTS=["100","200","300","400","500","600","700","800","900"],FONT_NAME_WEIGHTS=["normal","bold","bolder","lighter"],FONT_NAME_WEIGHTS_WITHOUT_NORMAL=["bold","bolder","lighter"],WHOLE_PIXEL_VALUE=/(?:^|\s|\()(-?\d+)px/,TIME_VALUE=/^(\-?[\d\.]+)(m?s)$/,valueMinifiers={background:function(e,t,r){return 0!==t||1!=r||"none"!=e&&"transparent"!=e?e:"0 0"},"font-weight":function(e){return"normal"==e?"400":"bold"==e?"700":e},outline:function(e,t,r){return 0===t&&1==r&&"none"==e?"0":e}};module.exports=optimize;