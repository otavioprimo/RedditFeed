function ImportInliner(e){this.outerContext=e}function importFrom(e,t){if(t.shallow)return t.shallow=!1,t.done.push(e),processNext(t);for(var r=0,n=0,i=0,a=commentScanner(e);n<e.length&&(r=nextImportAt(e,i),-1!=r);){if(!a(r)){if(n=e.indexOf(";",r),-1==n){i=e.length,e="";break}var s=e.substring(0,r);return t.done.push(s),t.left.unshift([e.substring(n+1),t]),t.afterContent=hasContent(s),inline(e,r,n,t)}i=r+1}return t.done.push(e),processNext(t)}function rebaseMap(e,t){return e.replace(MAP_MARKER,function(e,r){return REMOTE_RESOURCE.test(r)?e:e.replace(r,url.resolve(t,r))})}function nextImportAt(e,t){var r=e.indexOf("@import",t),n=e.indexOf("@IMPORT",t);return r>-1&&-1==n?r:-1==r&&n>-1?n:Math.min(r,n)}function processNext(e){return e.left.length>0?importFrom.apply(null,e.left.shift()):e.whenDone(e.done.join(""))}function commentScanner(e){var t=/(\/\*(?!\*\/)[\s\S]*?\*\/)/,r=0,n=0,i=!1;return function(a){var s,o=0,u=0,l=0,c=0;if(i)return!1;do{if(a>r&&n>a)return!0;if(s=e.match(t),!s)return i=!0,!1;r=o=s.index,u=o+s[0].length,c=u+n,l=c-s[0].length,e=e.substring(u),n=c}while(a>c);return c>a&&a>l}}function hasContent(e){for(var t=commentScanner(e),r=-1;;)if(r=e.indexOf("{",r+1),-1==r||!t(r))break;return r>-1}function inline(e,t,r,n){n.shallow=e.indexOf("@shallow")>0;var i=e.substring(nextImportAt(e,t)+"@import".length+1,r).replace(/@shallow\)$/,")").trim(),a=0===i.indexOf("url("),s=a?4:0,o=/^['"]/.exec(i.substring(s,s+2)),u=o?i.indexOf(o[0],s+1):split(i," ")[0].length-(a?1:0),l=i.substring(s,u).replace(/['"]/g,"").replace(/\)$/,"").trim(),c=i.substring(u+1).replace(/^\)/,"").trim(),f=n.isRemote||REMOTE_RESOURCE.test(l);if(f&&(n.localOnly||!allowedResource(l,!0,n.imports)))return n.afterContent||hasContent(n.done.join(""))?n.warnings.push('Ignoring remote @import of "'+l+'" as no callback given.'):restoreImport(l,c,n),processNext(n);if(!f&&!allowedResource(l,!1,n.imports))return n.afterImport?n.warnings.push('Ignoring local @import of "'+l+'" as after other inlined content.'):restoreImport(l,c,n),processNext(n);if(!f&&n.afterContent)return n.warnings.push('Ignoring local @import of "'+l+'" as after other CSS content.'),processNext(n);var p=f?inlineRemoteResource:inlineLocalResource;return p(l,c,n)}function allowedResource(e,t,r){if(0===r.length)return!1;t&&NO_PROTOCOL_RESOURCE.test(e)&&(e="http:"+e);for(var n=t?url.parse(e).host:e,i=!0,a=0;a<r.length;a++){var s=r[a];"all"==s?i=!0:t&&"local"==s?i=!1:t&&"remote"==s?i=!0:t||"remote"!=s?t||"local"!=s?"!"==s[0]&&s.substring(1)===n&&(i=!1):i=!0:i=!1}return i}function inlineRemoteResource(e,t,r){function u(e){o||(o=!0,r.errors.push('Broken @import declaration of "'+n+'" - '+e),restoreImport(n,t,r),process.nextTick(function(){processNext(r)}))}var n=REMOTE_RESOURCE.test(e)?e:url.resolve(r.relativeTo,e),i=n;if(NO_PROTOCOL_RESOURCE.test(n)&&(n="http:"+n),r.visited.indexOf(n)>-1)return processNext(r);r.debug&&console.error("Inlining remote stylesheet: "+n),r.visited.push(n);var a=r.inliner.request.protocol||r.inliner.request.hostname,s=a&&0!==a.indexOf("https://")||0===n.indexOf("http://")?http.get:https.get,o=!1,l=override(url.parse(n),r.inliner.request);void 0!==r.inliner.request.hostname&&(l.protocol=r.inliner.request.protocol||"http:",l.path=l.href),s(l,function(e){if(e.statusCode<200||e.statusCode>399)return u("error "+e.statusCode);if(e.statusCode>299){var a=url.resolve(n,e.headers.location);return inlineRemoteResource(a,t,r)}var s=[],o=url.parse(n);e.on("data",function(e){s.push(e.toString())}),e.on("end",function(){var e=s.join("");r.rebase&&(e=rewriteUrls(e,{toBase:i},r)),r.sourceReader.trackSource(n,e),e=r.sourceTracker.store(n,e),e=rebaseMap(e,n),t.length>0&&(e="@media "+t+"{"+e+"}"),r.afterImport=!0;var a=override(r,{isRemote:!0,relativeTo:o.protocol+"//"+o.host+o.pathname});process.nextTick(function(){importFrom(e,a)})})}).on("error",function(e){u(e.message)}).on("timeout",function(){u("timeout")}).setTimeout(r.inliner.timeout)}function inlineLocalResource(e,t,r){var n="/"==e[0]?r.root:r.relativeTo,i=path.resolve(path.join(n,e));if(!fs.existsSync(i)||!fs.statSync(i).isFile())return r.errors.push('Broken @import declaration of "'+e+'"'),processNext(r);if(r.visited.indexOf(i)>-1)return processNext(r);r.debug&&console.error("Inlining local stylesheet: "+i),r.visited.push(i);var a=path.dirname(i),s=fs.readFileSync(i,"utf8");if(r.rebase){var o={relative:!0,fromBase:a,toBase:r.baseRelativeTo};s=rewriteUrls(s,o,r)}var u=path.relative(r.root,i);r.sourceReader.trackSource(u,s),s=r.sourceTracker.store(u,s),t.length>0&&(s="@media "+t+"{"+s+"}"),r.afterImport=!0;var l=override(r,{relativeTo:a});return importFrom(s,l)}function restoreImport(e,t,r){var n="@import url("+e+")"+(t.length>0?" "+t:"")+";";r.done.push(n)}var fs=require("fs"),path=require("path"),http=require("http"),https=require("https"),url=require("url"),rewriteUrls=require("../urls/rewrite"),split=require("../utils/split"),override=require("../utils/object.js").override,MAP_MARKER=/\/\*# sourceMappingURL=(\S+) \*\//,REMOTE_RESOURCE=/^(https?:)?\/\//,NO_PROTOCOL_RESOURCE=/^\/\//;ImportInliner.prototype.process=function(e,t){var r=this.outerContext.options.root;return t=override(t,{baseRelativeTo:this.outerContext.options.relativeTo||r,debug:this.outerContext.options.debug,done:[],errors:this.outerContext.errors,left:[],inliner:this.outerContext.options.inliner,rebase:this.outerContext.options.rebase,relativeTo:this.outerContext.options.relativeTo||r,root:r,sourceReader:this.outerContext.sourceReader,sourceTracker:this.outerContext.sourceTracker,warnings:this.outerContext.warnings,visited:[]}),importFrom(e,t)},module.exports=ImportInliner;