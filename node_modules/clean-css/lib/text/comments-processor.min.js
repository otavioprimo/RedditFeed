function CommentsProcessor(e,t,r,n){this.comments=new EscapeStore("COMMENT"),this.specialComments=new EscapeStore("COMMENT_SPECIAL"),this.context=e,this.restored=0,this.keepAll="*"==t,this.keepOne="1"==t||1===t,this.keepBreaks=r,this.saveWaypoints=n}function quoteScannerFor(e){var t=[];return new QuoteScanner(e).each(function(e,r,n){t.push([n,n+e.length])}),function(e){for(var r=0,n=t.length;n>r;r++)if(t[r][0]<e&&t[r][1]>e)return!0;return!1}}function restore(e,t,r,n){for(var i=[],a=0;a<t.length;){var o=r.nextMatch(t,a);if(o.start<0)break;i.push(t.substring(a,o.start));var s=r.restore(o.match);n&&(e.keepAll||e.keepOne&&0===e.restored)?(e.restored++,i.push(s),a=o.end):a=o.end+(e.keepBreaks&&t.substring(o.end,o.end+lineBreak.length)==lineBreak?lineBreak.length:0)}return i.length>0?i.join("")+t.substring(a,t.length):t}var EscapeStore=require("./escape-store"),QuoteScanner=require("../utils/quote-scanner"),SPECIAL_COMMENT_PREFIX="/*!",COMMENT_PREFIX="/*",COMMENT_SUFFIX="*/",lineBreak=require("os").EOL;CommentsProcessor.prototype.escape=function(e){for(var o,s,u,t=[],r=0,n=0,i=0,a=0,l=quoteScannerFor(e),c=this.saveWaypoints;n<e.length&&(r=e.indexOf(COMMENT_PREFIX,i),-1!=r);)if(l(r))t.push(e.substring(i,r+COMMENT_PREFIX.length)),i=r+COMMENT_PREFIX.length;else{n=e.indexOf(COMMENT_SUFFIX,r+COMMENT_PREFIX.length),-1==n&&(this.context.warnings.push("Broken comment: '"+e.substring(r)+"'."),n=e.length-2),t.push(e.substring(i,r));var f=e.substring(r,n+COMMENT_SUFFIX.length),p=0===f.indexOf(SPECIAL_COMMENT_PREFIX);if(c&&(o=f.split(lineBreak).length-1,s=f.lastIndexOf(lineBreak),u=s>0?f.substring(s+lineBreak.length).length:a+f.length),c||p){var h=c?[o,u]:null,d=p?this.specialComments.store(f,h):this.comments.store(f,h);t.push(d)}c&&(a=u+1),i=n+COMMENT_SUFFIX.length}return t.length>0?t.join("")+e.substring(i,e.length):e},CommentsProcessor.prototype.restore=function(e){return e=restore(this,e,this.comments,!1),e=restore(this,e,this.specialComments,!0)},module.exports=CommentsProcessor;