function FreeTextProcessor(e){this.matches=new EscapeStore("FREE_TEXT"),this.saveWaypoints=e}function normalize(e,t,r,n){var i=t;r&&(i=r+t.substring(0,t.indexOf("__ESCAPED_FREE_TEXT_CLEAN_CSS")),n=i.length);var a=i.lastIndexOf(";",n),o=i.lastIndexOf("{",n),s=0;s=a>-1&&o>-1?Math.max(a,o):-1==a?o:a;var u=i.substring(s+1,n);if(/\[[\w\d\-]+[\*\|\~\^\$]?=$/.test(u)&&(e=e.replace(/\\\n|\\\r\n/g,"").replace(/\n|\r\n/g,"")),/^['"][a-zA-Z][a-zA-Z\d\-_]+['"]$/.test(e)&&!/format\($/.test(u)){var l=/^(font|font\-family):/.test(u),c=/\[[\w\d\-]+[\*\|\~\^\$]?=$/.test(u),f=/@(-moz-|-o-|-webkit-)?keyframes /.test(u),p=/^(-moz-|-o-|-webkit-)?animation(-name)?:/.test(u);(l||c||f||p)&&(e=e.substring(1,e.length-1))}return e}var EscapeStore=require("./escape-store"),QuoteScanner=require("../utils/quote-scanner"),lineBreak=require("os").EOL;FreeTextProcessor.prototype.escape=function(e){var r,n,i,a,t=this,o=this.saveWaypoints;return new QuoteScanner(e).each(function(e,s){o&&(r=e.split(lineBreak).length-1,n=e.lastIndexOf(lineBreak),i=n>0?e.substring(n+lineBreak.length).length:e.length,a=[r,i]);var u=t.matches.store(e,a);s.push(u)})},FreeTextProcessor.prototype.restore=function(e,t){for(var r=[],n=0;n<e.length;){var i=this.matches.nextMatch(e,n);if(i.start<0)break;r.push(e.substring(n,i.start));var a=normalize(this.matches.restore(i.match),e,t,i.start);r.push(a),n=i.end}return r.length>0?r.join("")+e.substring(n,e.length):e},module.exports=FreeTextProcessor;