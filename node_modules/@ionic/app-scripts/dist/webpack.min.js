"use strict";function webpack(e,t){e=config_1.generateContext(e),t=config_1.getUserConfigFile(e,taskInfo,t),logger_1.Logger.debug("Webpack: Setting Context on shared singleton"),helpers_1.setContext(e);var r=new logger_1.Logger("webpack");return webpackWorker(e,t).then(function(){e.bundleState=interfaces_1.BuildState.SuccessfulBuild,r.finish()})["catch"](function(t){throw e.bundleState=interfaces_1.BuildState.RequiresBuild,r.fail(t)})}function webpackUpdate(e,t,r,n){var i=new logger_1.Logger("webpack update"),o=getWebpackConfig(r,n);logger_1.Logger.debug("webpackUpdate: Starting Incremental Build");var a=runWebpackIncrementalBuild(!1,r,o);return events_1.emit(events_1.EventType.WebpackFilesChanged,[t]),a.then(function(e){return pendingPromises=[],logger_1.Logger.debug("webpackUpdate: Incremental Build Done, processing Data"),webpackBuildComplete(e,r,o)}).then(function(){return r.bundleState=interfaces_1.BuildState.SuccessfulBuild,i.finish()})["catch"](function(e){if(r.bundleState=interfaces_1.BuildState.RequiresBuild,e instanceof errors_1.IgnorableError)throw e;throw i.fail(e)})}function webpackWorker(e,t){var r=getWebpackConfig(e,t),n=null;return n=e.isWatch?runWebpackIncrementalBuild(!e.webpackWatch,e,r):runWebpackFullBuild(r),n.then(function(t){return webpackBuildComplete(t,e,r)})}function webpackBuildComplete(e,t,r){var n=e.compilation.modules.map(function(e){return e.resource?e.resource:e.context}).filter(function(e){return e&&e.length>0});return t.moduleFiles=n,Promise.resolve()}function runWebpackFullBuild(e){return new Promise(function(t,r){var n=function(e,n){e?r(new errors_1.BuildError(e)):t(n)},i=webpackApi(e);i.run(n)})}function runWebpackIncrementalBuild(e,t,r){var n=new Promise(function(i,o){eventEmitter.on(INCREMENTAL_BUILD_FAILED,function(e){logger_1.Logger.debug("Webpack Bundle Update Failed"),eventEmitter.removeAllListeners(),handleWebpackBuildFailure(i,o,e,n,pendingPromises)}),eventEmitter.on(INCREMENTAL_BUILD_SUCCESS,function(e){logger_1.Logger.debug("Webpack Bundle Updated"),eventEmitter.removeAllListeners(),handleWebpackBuildSuccess(i,o,e,n,pendingPromises)}),e&&startWebpackWatch(t,r)});return pendingPromises.push(n),n}function handleWebpackBuildFailure(e,t,r,n,i){return i.length>0&&i[i.length-1]===n?void t(new errors_1.BuildError(r)):void t(new errors_1.IgnorableError)}function handleWebpackBuildSuccess(e,t,r,n,i){return i.length>0&&i[i.length-1]===n?(logger_1.Logger.debug("handleWebpackBuildSuccess: Resolving with Webpack data"),void e(r)):(logger_1.Logger.debug("handleWebpackBuildSuccess: Rejecting with ignorable error"),void t(new errors_1.IgnorableError))}function startWebpackWatch(e,t){logger_1.Logger.debug("Starting Webpack watch");var r=webpackApi(t);e.webpackWatch=r.watch({},function(e,t){e?eventEmitter.emit(INCREMENTAL_BUILD_FAILED,e):eventEmitter.emit(INCREMENTAL_BUILD_SUCCESS,t)})}function getWebpackConfig(e,t){t=config_1.getUserConfigFile(e,taskInfo,t);var r=config_1.fillConfigDefaults(t,taskInfo.defaultConfigFile);return r.entry=config_1.replacePathVars(e,r.entry),r.output.path=config_1.replacePathVars(e,r.output.path),r}function getOutputDest(e,t){return path_1.join(t.output.path,t.output.filename)}function typescriptFileChanged(e,t){var r=helpers_1.changeExtension(e,".js"),n=t.get(r),i=t.get(r+".map");return[n,i]}function otherFileChanged(e){return helpers_1.readFileAsync(e).then(function(t){return{path:e,content:t}})}var interfaces_1=require("./util/interfaces"),errors_1=require("./util/errors"),helpers_1=require("./util/helpers"),events_1=require("./util/events"),path_1=require("path"),config_1=require("./util/config"),logger_1=require("./logger/logger"),webpackApi=require("webpack"),events_2=require("events"),eventEmitter=new events_2.EventEmitter,INCREMENTAL_BUILD_FAILED="incremental_build_failed",INCREMENTAL_BUILD_SUCCESS="incremental_build_success",pendingPromises=[];exports.webpack=webpack,exports.webpackUpdate=webpackUpdate,exports.webpackWorker=webpackWorker,exports.getWebpackConfig=getWebpackConfig,exports.getOutputDest=getOutputDest;var taskInfo={fullArg:"--webpack",shortArg:"-w",envVar:"IONIC_WEBPACK",packageConfig:"ionic_webpack",defaultConfigFile:"webpack.config"};