"use strict";var events_1=require("../util/events"),logger_1=require("../logger/logger"),WatchMemorySystem=function(){function e(e){this.fileCache=e,this.lastWatchEventTimestamp=Date.now()}return e.prototype.close=function(){this.isListening=!1},e.prototype.pause=function(){this.isListening=!1},e.prototype.watch=function(e,t,r,n,i,o,a){return this.filePathsBeingWatched=e,this.dirPaths=t,this.missing=r,this.startTime=n,this.options=i,this.immediateCallback=a,this.aggregatedCallback=o,this.isListening||this.startListening(),{pause:this.pause,close:this.close}},e.prototype.startListening=function(){var e=this;this.isListening=!0,events_1.on(events_1.EventType.WebpackFilesChanged,function(){e.changes=new Set;var t=e.fileCache.getAll().filter(function(t){return t.timestamp>=e.lastWatchEventTimestamp}).map(function(e){return e.path});logger_1.Logger.debug("filePaths: ",t),e.lastWatchEventTimestamp=Date.now(),e.processChanges(t)})},e.prototype.processChanges=function(e){this.immediateCallback(e[0],Date.now());for(var t=0,r=e;t<r.length;t++){var n=r[t];this.changes.add(n)}this.doneAggregating(this.changes)},e.prototype.doneAggregating=function(e){var t=this;this.isAggregating=!1;var r=Array.from(e),n=r.filter(function(e){return t.filePathsBeingWatched.indexOf(e)>=0}).sort(),i=r.filter(function(e){return t.dirPaths.indexOf(e)>=0}).sort(),o=r.filter(function(e){return t.missing.indexOf(e)>=0}).sort(),a=this.getTimes(this.filePathsBeingWatched,this.startTime,this.fileCache);this.aggregatedCallback(null,n,i,o,a,a)},e.prototype.getTimes=function(e,t,r){for(var n={},i=0,o=e;i<o.length;i++){var a=o[i],s=r.get(a);s?n[a]=s.timestamp:n[a]=t}return n},e}();exports.WatchMemorySystem=WatchMemorySystem;