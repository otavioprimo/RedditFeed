"use strict";function ngc(e,t){e=config_1.generateContext(e),t=config_1.getUserConfigFile(e,taskInfo,t);var r=new logger_1.Logger("ngc");return ngcWorker(e,t).then(function(){r.finish()})["catch"](function(e){throw r.fail(e)})}function ngcWorker(e,t){return copySrcTsToTmpDir(e).then(function(){return runNgc(e,t)})}function runNgc(e,t){return new Promise(function(r,n){var i=config_1.fillConfigDefaults(t,taskInfo.defaultConfigFile);createTmpTsConfig(e,i);var o=config_1.getNodeBinExecutable(e,"ngc");if(!o)return void n(new errors_1.BuildError('Unable to find Angular Compiler "ngc" command: '+o+". Please ensure @angular/compiler-cli has been installed with NPM."));var s=require("cross-spawn"),a=["--project",getTmpTsConfigPath(e)];logger_1.Logger.debug("run: "+o+" "+a.join(" "));var u=s(o,a),c=[];u.stdout.on("data",function(e){logger_1.Logger.info(e)}),u.stderr.on("data",function(e){e&&e.toString().split("\n").forEach(function(e){if(e.trim().length&&"    "!==e.substr(0,4)&&"Compilation failed"!==e){for(var t=e.split(": "),r=[],n=0;n<t.length;n++)r.push(t[n]),r.join(": ").length>40&&(c.push(r.join(": ")),r=[]);r.length&&c.push(r.join(": "))}})}),u.on("close",function(e){c.length?(c.forEach(function(e){logger_1.Logger.error(e)}),n(new errors_1.BuildError)):r()})})}function createTmpTsConfig(e,t){var r=transpile_1.getTsConfigPath(e),n=ts.readConfigFile(r,function(e){return fs_extra_1.readFileSync(e,"utf8")});if(!n||!n.config)throw new errors_1.BuildError("invalid tsconfig: "+r);if(!n.config.compilerOptions)throw new errors_1.BuildError("invalid tsconfig compilerOptions: "+r);delete n.config.compilerOptions.outDir;var i=helpers_1.objectAssign({},n.config,t);fs_extra_1.outputJsonSync(getTmpTsConfigPath(e),i)}function copySrcTsToTmpDir(e){return new Promise(function(t,r){try{fs_extra_1.emptyDirSync(e.tmpDir)}catch(n){return void r(new errors_1.BuildError("tmpDir error: "+n))}var i={filter:filterCopyFiles};logger_1.Logger.debug("copySrcTsToTmpDir, srcDir: "+e.srcDir+" to tmpDir: "+e.tmpDir),fs_extra_1.copy(e.srcDir,e.tmpDir,i,function(e){e?r(new errors_1.BuildError(e)):t()})})}function filterCopyFiles(e,t){var r=!1;try{var n=fs_extra_1.statSync(e);r=n.isDirectory()?EXCLUDE_DIRS.indexOf(path_1.basename(e))<0:e.endsWith(".ts")||e.endsWith(".html")}catch(i){}return r}function getTmpTsConfigPath(e){return path_1.join(e.tmpDir,"tsconfig.json")}var path_1=require("path"),errors_1=require("./util/errors"),fs_extra_1=require("fs-extra"),config_1=require("./util/config"),transpile_1=require("./transpile"),logger_1=require("./logger/logger"),helpers_1=require("./util/helpers"),ts=require("typescript");exports.ngc=ngc,exports.ngcWorker=ngcWorker,exports.getTmpTsConfigPath=getTmpTsConfigPath;var EXCLUDE_DIRS=["assets","theme"],taskInfo={fullArg:"--ngc",shortArg:"-n",envVar:"IONIC_NGC",packageConfig:"ionic_ngc",defaultConfigFile:"ngc.config"};