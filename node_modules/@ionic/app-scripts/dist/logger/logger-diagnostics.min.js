"use strict";function printDiagnostics(e,t,r,n,i){if(r&&r.length&&(n&&r.forEach(consoleLogDiagnostic),i)){var o=r.map(generateDiagnosticHtml),s=getDiagnosticsFileName(e.buildDir,t);fs_1.writeFileSync(s,o.join("\n"),{encoding:"utf8"})}}function consoleLogDiagnostic(e){if("warn"===e.level?logger_1.Logger.warn(e.header):logger_1.Logger.error(e.header),logger_1.Logger.wordWrap([e.messageText]).forEach(function(e){console.log(e)}),console.log(""),e.lines&&e.lines.length){var t=prepareLines(e.lines,"text");t.forEach(function(t){if(isMeaningfulLine(t.text)){for(var r="L"+t.lineNumber+":  ";r.length<logger_1.Logger.INDENT.length;)r=" "+r;var n=t.text;t.errorCharStart>-1&&(n=consoleHighlightError(n,t.errorCharStart,t.errorLength)),r=chalk.dim(r),r+="javascript"===e.language?jsConsoleSyntaxHighlight(n):"scss"===e.language?cssConsoleSyntaxHighlight(n,t.errorCharStart):n,console.log(r)}}),console.log("")}}function consoleHighlightError(e,t,r){for(var n=e.length-t+r-1;e.length+logger_1.Logger.INDENT.length>logger_1.Logger.MAX_LEN;)if(t>e.length-t+r&&t>5)e=e.substr(1),t--;else{if(!(n>1))break;e=e.substr(0,e.length-1),n--}for(var i=[],o=Math.max(e.length,t+r),s=0;o>s;s++){var a=e.charAt(s);s>=t&&t+r>s&&(a=chalk.bgRed(""===a?" ":a)),i.push(a)}return i.join("")}function clearDiagnosticsCache(){diagnosticsHtmlCache={}}function clearDiagnostics(e,t){try{delete diagnosticsHtmlCache[t],fs_1.unlinkSync(getDiagnosticsFileName(e.buildDir,t))}catch(r){}}function hasDiagnostics(e){loadBuildDiagnosticsHtml(e);for(var t=Object.keys(diagnosticsHtmlCache),r=0;r<t.length;r++)if("string"==typeof diagnosticsHtmlCache[t[r]])return!0;return!1}function loadBuildDiagnosticsHtml(e){try{void 0===diagnosticsHtmlCache[exports.DiagnosticsType.TypeScript]&&(diagnosticsHtmlCache[exports.DiagnosticsType.TypeScript]=fs_1.readFileSync(getDiagnosticsFileName(e,exports.DiagnosticsType.TypeScript),"utf8"))}catch(t){diagnosticsHtmlCache[exports.DiagnosticsType.TypeScript]=!1}try{void 0===diagnosticsHtmlCache[exports.DiagnosticsType.Sass]&&(diagnosticsHtmlCache[exports.DiagnosticsType.Sass]=fs_1.readFileSync(getDiagnosticsFileName(e,exports.DiagnosticsType.Sass),"utf8"))}catch(t){diagnosticsHtmlCache[exports.DiagnosticsType.Sass]=!1}}function injectDiagnosticsHtml(e,t){if(!hasDiagnostics(e))return t;var r=t.toString(),n=[];n.push('<div id="ion-diagnostics">'),n.push(getDiagnosticsHtmlContent(e)),n.push("</div>");var i=r.match(/<body>(?![\s\S]*<body>)/i);return r=i?r.replace(i[0],i[0]+"\n"+n.join("\n")):n.join("\n")+r}function getDiagnosticsHtmlContent(e,t){var r=[];r.push('\n    <div class="ion-diagnostics-header">\n      <div class="ion-diagnostics-header-content">\n        <div class="ion-diagnostics-header-inner">Error</div>\n        <div class="ion-diagnostics-buttons">\n          <button id="ion-diagnostic-close">Close</button>\n        </div>\n      </div>\n    </div>\n  '),r.push('<div class="ion-diagnostics-content">'),t&&r.push(t),loadBuildDiagnosticsHtml(e);for(var n=Object.keys(diagnosticsHtmlCache),i=0;i<n.length;i++)"string"==typeof diagnosticsHtmlCache[n[i]]&&r.push(diagnosticsHtmlCache[n[i]]);return r.push("</div>"),r.join("\n")}function generateDiagnosticHtml(e){var t=[];t.push('<div class="ion-diagnostic">'),t.push('<div class="ion-diagnostic-masthead" title="'+helpers_1.escapeHtml(e.type)+" error: "+helpers_1.escapeHtml(e.code)+'">');var r=helpers_1.titleCase(e.type)+" "+helpers_1.titleCase(e.level);return t.push('<div class="ion-diagnostic-title">'+helpers_1.escapeHtml(r)+"</div>"),t.push('<div class="ion-diagnostic-message" data-error-code="'+helpers_1.escapeHtml(e.type)+"-"+helpers_1.escapeHtml(e.code)+'">'+helpers_1.escapeHtml(e.messageText)+"</div>"),t.push("</div>"),t.push(generateCodeBlock(e)),t.push("</div>"),t.join("\n")}function generateCodeBlock(e){var t=[];return t.push('<div class="ion-diagnostic-file">'),t.push('<div class="ion-diagnostic-file-header" title="'+helpers_1.escapeHtml(e.absFileName)+'">'+helpers_1.escapeHtml(e.relFileName)+"</div>"),e.lines&&e.lines.length&&(t.push('<div class="ion-diagnostic-blob">'),t.push('<table class="ion-diagnostic-table">'),prepareLines(e.lines,"html").forEach(function(e){t.push("<tr"+(e.errorCharStart>-1?' class="ion-diagnostic-error-line"':"")+">"),t.push('<td class="ion-diagnostic-blob-num" data-line-number="'+e.lineNumber+'"></td>'),t.push('<td class="ion-diagnostic-blob-code">'+highlight_1.highlightError(e.html,e.errorCharStart,e.errorLength)+"</td>"),t.push("</tr>")}),t.push("</table>"),t.push("</div>")),t.push("</div>"),t.join("\n")}function jsConsoleSyntaxHighlight(e){if(e.trim().startsWith("//"))return chalk.dim(e);var t=e.split(" ").map(function(e){return JS_KEYWORDS.indexOf(e)>-1?chalk.cyan(e):e});return t.join(" ")}function cssConsoleSyntaxHighlight(e,t){for(var r=!0,n="abcdefghijklmnopqrstuvwxyz-_",i=".#,:}@$[]/*",o=[],s=0;s<e.length;s++){var a=e.charAt(s);";"===a||"{"===a?r=!0:i.indexOf(a)>-1&&(r=!1),r&&n.indexOf(a.toLowerCase())>-1?o.push(chalk.cyan(a)):o.push(a)}return o.join("")}function prepareLines(e,t){for(var r=JSON.parse(JSON.stringify(e)),n=0;100>n;n++){if(!eachLineHasLeadingWhitespace(r,t))return r;for(var n=0;n<r.length;n++)if(r[n][t]=r[n][t].substr(1),r[n].errorCharStart--,!r[n][t].length)return r}return r}function eachLineHasLeadingWhitespace(e,t){if(!e.length)return!1;for(var r=0;r<e.length;r++){if(e[r][t].length<1)return!1;var n=e[r][t].charAt(0);if(" "!==n&&"	"!==n)return!1}return!0}function getDiagnosticsFileName(e,t){return path_1.join(e,".ion-diagnostic-"+t+".html")}function isMeaningfulLine(e){return e&&(e=e.trim(),e.length)?MEH_LINES.indexOf(e)<0:!1}var helpers_1=require("../util/helpers"),highlight_1=require("../highlight/highlight"),path_1=require("path"),logger_1=require("./logger"),fs_1=require("fs"),chalk=require("chalk");exports.printDiagnostics=printDiagnostics;var diagnosticsHtmlCache={};exports.clearDiagnosticsCache=clearDiagnosticsCache,exports.clearDiagnostics=clearDiagnostics,exports.hasDiagnostics=hasDiagnostics,exports.injectDiagnosticsHtml=injectDiagnosticsHtml,exports.getDiagnosticsHtmlContent=getDiagnosticsHtmlContent,exports.generateDiagnosticHtml=generateDiagnosticHtml,exports.generateCodeBlock=generateCodeBlock;var JS_KEYWORDS=["abstract","any","as","break","boolean","case","catch","class","console","const","continue","debugger","declare","default","delete","do","else","enum","export","extends","false","finally","for","from","function","get","if","import","in","implements","Infinity","instanceof","let","module","namespace","NaN","new","number","null","public","private","protected","require","return","static","set","string","super","switch","this","throw","try","true","type","typeof","undefined","var","void","with","while","yield"],MEH_LINES=[";",":","{","}","(",")","/**","/*","*/","*","({","})"];exports.DiagnosticsType={TypeScript:"typescript",Sass:"sass",TsLint:"tslint"};