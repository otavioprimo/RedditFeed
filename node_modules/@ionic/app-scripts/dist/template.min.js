"use strict";function templateUpdate(e,t,r){return new Promise(function(e){function o(){r.transpileState=interfaces_1.BuildState.RequiresBuild,r.bundleState=interfaces_1.BuildState.RequiresUpdate,e()}var n=Date.now(),i=bundle_1.getJsOutputDest(r);try{var a=fs_1.readFileSync(i,"utf8"),s=fs_1.readFileSync(t,"utf8"),u=updateCorrespondingJsFile(r,s,t);if(a=replaceExistingJsTemplate(a,s,t),rollup_1.invalidateCache(),u&&a){var l=new logger_1.Logger("template update");l.setStartTime(n),fs_1.writeFile(i,a,{encoding:"utf8"},function(n){n?(l.fail(n),o()):(logger_1.Logger.debug("templateUpdate, updated: "+t),r.templateState=interfaces_1.BuildState.SuccessfulBuild,l.finish(),e())})}else o()}catch(c){logger_1.Logger.debug("templateUpdate error: "+c),o()}})}function updateCorrespondingJsFile(e,t,r){for(var n=e.fileCache.getAll().filter(function(e){return path_1.dirname(e.path)===path_1.dirname(r)&&".js"===path_1.extname(e.path)}),i=0,o=n;i<o.length;i++){var a=o[i],s=replaceExistingJsTemplate(a.content,t,r);if(s!==a.content){a.content=s,e.fileCache.set(a.path,a);var u=helpers_1.changeExtension(a.path,".ts");return e.fileCache.set(u,e.fileCache.get(u)),!0}}return!1}function inlineTemplate(e,t){for(var n,i,r=path_1.parse(t).dir,o=null;n=getTemplateMatch(e);){if(n.component===o)return logger_1.Logger.debug("Error matching component: "+n.component),e;if(o=n.component,""===n.templateUrl)return logger_1.Logger.error('Error @Component templateUrl missing in: "'+t+'"'),e;i=updateTemplate(r,n),i&&(e=e.replace(n.component,i))}return e}function updateTemplate(e,t){var r=path_1.join(e,t.templateUrl);try{var n=fs_1.readFileSync(r,"utf8");return replaceTemplateUrl(t,r,n)}catch(i){logger_1.Logger.error('template error, "'+r+'": '+i)}return null}function replaceTemplateUrl(e,t,r){var n=e.templateProperty,i=getTemplateFormat(t,r);return e.component.replace(n,i)}function replaceExistingJsTemplate(e,t,r){var n=getTemplatePrefix(r),i=e.indexOf(n),o=!1;if(-1===i&&(n=stringify(n),o=!0),i=e.indexOf(n),-1===i)return null;var a=getTemplateSuffix(r);o&&(a=stringify(a));var s=e.indexOf(a,i+1);if(-1===s)return null;var u=e.substring(i,s+a.length),l=getTemplateFormat(r,t);o&&(l=stringify(l));for(var c=null;e.indexOf(u)>-1&&e!==c;)c=e=e.replace(u,l);return e}function stringify(e){return e=JSON.stringify(e),e.substr(1,e.length-2)}function getTemplateFormat(e,t){return t=t.replace(/\r|\n/g,"\\n"),t=t.replace(/\'/g,"\\'"),getTemplatePrefix(e)+"'"+t+"'"+getTemplateSuffix(e)}function getTemplatePrefix(e){return'template:/*ion-inline-start:"'+path_1.resolve(e)+'"*/'}function getTemplateSuffix(e){return'/*ion-inline-end:"'+path_1.resolve(e)+'"*/'}function getTemplateMatch(e){var t=COMPONENT_REGEX.exec(e);return t?{start:t.index,end:t.index+t[0].length,component:t[0],templateProperty:t[3],templateUrl:t[5].trim()}:null}var interfaces_1=require("./util/interfaces"),helpers_1=require("./util/helpers"),logger_1=require("./logger/logger"),bundle_1=require("./bundle"),rollup_1=require("./rollup"),path_1=require("path"),fs_1=require("fs");exports.templateUpdate=templateUpdate,exports.inlineTemplate=inlineTemplate,exports.updateTemplate=updateTemplate,exports.replaceTemplateUrl=replaceTemplateUrl,exports.replaceExistingJsTemplate=replaceExistingJsTemplate,exports.getTemplateFormat=getTemplateFormat,exports.getTemplateMatch=getTemplateMatch;var COMPONENT_REGEX=/Component\s*?\(\s*?(\{([\s\S]*?)(\s*templateUrl\s*:\s*(['"`])(.*?)(['"`])\s*?)([\s\S]*?)}\s*?)\)/m;