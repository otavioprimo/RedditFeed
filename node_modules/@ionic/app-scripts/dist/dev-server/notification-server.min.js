"use strict";function createNotificationServer(e){function n(e){r.push(e),i()}function i(){if(t)for(var e=void 0;e=r.shift();)try{t.send(JSON.stringify(e))}catch(n){logger_1.Logger.error("error sending client ws, "+n)}}function s(e){if(e&&e.data)switch(e.category){case"console":a(e);break;case"runtimeError":u(e)}}function a(e){var t=e.data;switch(t[0]="console."+e.type+": "+t[0],e.type){case"error":logger_1.Logger.error.apply(this,t);break;case"warn":logger_1.Logger.warn.apply(this,t);break;case"debug":logger_1.Logger.debug.apply(this,t);break;default:logger_1.Logger.info.apply(this,t)}}function u(t){var r={category:"buildUpdate",type:"completed",data:{diagnosticsHtml:logger_runtime_1.generateRuntimeDiagnosticContent(e.rootDir,e.buildDir,t.data.message,t.data.stack)}};n(r)}var t,r=[];events_1.on(events_1.EventType.BuildUpdateStarted,function(e){var t={category:"buildUpdate",type:"started",data:{buildId:e.buildId,reloadApp:e.reloadApp,diagnosticsHtml:null}};n(t)}),events_1.on(events_1.EventType.BuildUpdateCompleted,function(t){var r={category:"buildUpdate",type:"completed",data:{buildId:t.buildId,reloadApp:t.reloadApp,diagnosticsHtml:logger_diagnostics_1.hasDiagnostics(e.buildDir)?logger_diagnostics_1.getDiagnosticsHtmlContent(e.buildDir):null}};n(r)});var o=new ws_1.Server({port:e.notificationPort});o.on("connection",function(e){t=e,t.on("message",function(e){try{s(JSON.parse(e))}catch(t){logger_1.Logger.error("error opening ws message: "+e)}}),i()})}var logger_1=require("../logger/logger"),logger_runtime_1=require("../logger/logger-runtime"),logger_diagnostics_1=require("../logger/logger-diagnostics"),events_1=require("../util/events"),ws_1=require("ws");exports.createNotificationServer=createNotificationServer;