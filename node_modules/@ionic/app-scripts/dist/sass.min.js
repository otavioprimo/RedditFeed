"use strict";function sass(e,t){e=config_1.generateContext(e),t=config_1.getUserConfigFile(e,taskInfo,t);var r=new logger_1.Logger("sass");return sassWorker(e,t).then(function(t){return e.sassState=interfaces_1.BuildState.SuccessfulBuild,r.finish(),t})["catch"](function(t){throw e.sassState=interfaces_1.BuildState.RequiresBuild,r.fail(t)})}function sassUpdate(e,t,r){var n=config_1.getUserConfigFile(r,taskInfo,null),i=new logger_1.Logger("sass update");return sassWorker(r,n).then(function(e){return r.sassState=interfaces_1.BuildState.SuccessfulBuild,i.finish(),e})["catch"](function(e){throw r.sassState=interfaces_1.BuildState.RequiresBuild,i.fail(e)})}function sassWorker(e,t){var r=[];return e.moduleFiles||r.push(bundle_1.bundle(e)),Promise.all(r).then(function(){logger_diagnostics_1.clearDiagnostics(e,logger_diagnostics_1.DiagnosticsType.Sass);var r=config_1.fillConfigDefaults(t,taskInfo.defaultConfigFile);return r.outFile||(r.outFile=path_1.join(e.buildDir,r.outputFilename)),logger_1.Logger.debug("sass outFile: "+r.outFile),r.includePaths.unshift(path_1.join(e.srcDir)),logger_1.Logger.debug("sass includePaths: "+r.includePaths),r.sortComponentPathsFn=r.sortComponentPathsFn||defaultSortComponentPathsFn,r.sortComponentFilesFn=r.sortComponentFilesFn||defaultSortComponentFilesFn,r.file||generateSassData(e,r),render(e,r)})}function generateSassData(e,t){var r=[];e.moduleFiles.forEach(function(e){var t=path_1.dirname(e);r.indexOf(t)<0&&r.push(t)}),logger_1.Logger.debug("sass moduleDirectories: "+r.length);var n=t.variableSassFiles.map(function(t){return config_1.replacePathVars(e,t)}),i=getComponentSassFiles(r,e,t);logger_1.Logger.debug("sass userSassVariableFiles: "+n.length),logger_1.Logger.debug("sass componentSassFiles: "+i.length);var o=n.concat(i).map(function(e){return'"'+e.replace(/\\/g,"\\\\")+'"'});o.length&&(t.data='@charset "UTF-8"; @import '+o.join(",")+";")}function getComponentSassFiles(e,t,r){var n=[],i=getComponentDirectories(e,r),o=i.sort(r.sortComponentPathsFn);return o.forEach(function(e){addComponentSassFiles(e,n,t,r)}),n}function addComponentSassFiles(e,t,r,n){var i=getSiblingSassFiles(e,n);if(!i.length&&-1===e.indexOf(path_1.sep+"node_modules"))for(var o in n.directoryMaps)if(n.directoryMaps.hasOwnProperty(o)){var s=config_1.replacePathVars(r,o),a=config_1.replacePathVars(r,n.directoryMaps[o]);if(e=e.replace(s,a),i=getSiblingSassFiles(e,n),i.length)break}i.length&&(i=i.sort(n.sortComponentFilesFn),i.forEach(function(e){t.push(e)}))}function getSiblingSassFiles(e,t){return fs_extra_1.readdirSync(e).filter(function(e){return isValidSassFile(e,t)}).map(function(t){return path_1.join(e,t)})}function isValidSassFile(e,t){for(var r=0;r<t.includeFiles.length;r++)if(t.includeFiles[r].test(e)){for(var n=0;n<t.excludeFiles.length;n++)if(t.excludeFiles[n].test(e))return logger_1.Logger.debug("sass excluded: "+e),!1;return!0}return!1}function getComponentDirectories(e,t){return e.filter(function(e){e=e.replace(/\\/g,"/");for(var r=0;r<t.excludeModules.length;r++)if(e.indexOf("/node_modules/"+t.excludeModules[r]+"/")>-1)return!1;return!0})}function render(e,t){return new Promise(function(r,n){t.omitSourceMapUrl=!0,t.sourceMap&&(t.sourceMap=path_1.basename(t.outFile),t.sourceMapContents=!0),node_sass_1.render(t,function(i,o){var s=logger_sass_1.runSassDiagnostics(e,i);s.length?(logger_diagnostics_1.printDiagnostics(e,logger_diagnostics_1.DiagnosticsType.Sass,s,!0,!0),n(new errors_1.BuildError)):renderSassSuccess(e,o,t).then(function(e){r(e)})["catch"](function(e){n(new errors_1.BuildError(e))})})})}function renderSassSuccess(e,t,r){if(r.autoprefixer){var n=!1;r.sourceMap&&(n={inline:!1});var i={to:path_1.basename(r.outFile),map:n};return logger_1.Logger.debug("sass, start postcss/autoprefixer"),postcss([autoprefixer(r.autoprefixer)]).process(t.css,i).then(function(t){t.warnings().forEach(function(e){logger_1.Logger.warn(e.toString())});var n=null;return r.sourceMap&&t.map&&(logger_1.Logger.debug("sass, parse postCssResult.map"),n=JSON.parse(t.map.toString()).mappings),logger_1.Logger.debug("sass: postcss/autoprefixer completed"),writeOutput(e,r,t.css,n)})}generateSourceMaps(t,r);var o=null;return t.map&&(o=JSON.parse(t.map.toString()).mappings),writeOutput(e,r,t.css.toString(),o)}function generateSourceMaps(e,t){if(e.map){logger_1.Logger.debug("sass, generateSourceMaps");var r=JSON.parse(e.map.toString()),n=r.file.replace(/^stdout$/,"stdin"),i=t.outFile,o=path_1.dirname(i);if(o){var s=r.sources.indexOf(n);r.sources=r.sources.map(function(e,t){return t===s?e:path_1.join(o,e)})}r.sources=r.sources.filter(function(e){return"stdin"!==e?e:void 0})}}function writeOutput(e,t,r,n){return new Promise(function(e,i){logger_1.Logger.debug("sass start write output: "+t.outFile);var o=path_1.dirname(t.outFile);fs_extra_1.ensureDirSync(o),fs_extra_1.writeFile(t.outFile,r,function(r){if(r)i(new errors_1.BuildError("Error writing css file, "+t.outFile+": "+r));else{if(logger_1.Logger.debug("sass saved output: "+t.outFile),n){var s=path_1.join(o,path_1.basename(t.outFile)+".map");logger_1.Logger.debug("sass start write css map: "+s),fs_extra_1.writeFile(s,n,function(e){e?logger_1.Logger.error("Error writing css map file, "+s+": "+e):logger_1.Logger.debug("sass saved css map: "+s)})}e(t.outFile)}})})}function defaultSortComponentPathsFn(e,t){var r=e.indexOf("node_modules"),n=t.indexOf("node_modules");return r>-1&&n>-1?e>t?1:-1:r>-1&&-1===n?-1:-1===r&&n>-1?1:e>t?1:-1}function defaultSortComponentFilesFn(e,t){var r=e.split(".").length,n=t.split(".").length,i=e.split("-").length,o=t.split("-").length;return r>n?1:n>r?-1:i>o?1:o>i?-1:e>t?1:-1}var path_1=require("path"),interfaces_1=require("./util/interfaces"),errors_1=require("./util/errors"),bundle_1=require("./bundle"),fs_extra_1=require("fs-extra"),config_1=require("./util/config"),logger_1=require("./logger/logger"),logger_sass_1=require("./logger/logger-sass"),logger_diagnostics_1=require("./logger/logger-diagnostics"),node_sass_1=require("node-sass"),postcss=require("postcss"),autoprefixer=require("autoprefixer");exports.sass=sass,exports.sassUpdate=sassUpdate,exports.sassWorker=sassWorker;var taskInfo={fullArg:"--sass",shortArg:"-s",envVar:"IONIC_SASS",packageConfig:"ionic_sass",defaultConfigFile:"sass.config"};