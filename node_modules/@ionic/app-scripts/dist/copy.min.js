"use strict";function copy(e,t){e=config_1.generateContext(e),t=config_1.getUserConfigFile(e,taskInfo,t);var r=new logger_1.Logger("copy");return copyWorker(e,t).then(function(){r.finish()})["catch"](function(e){throw r.fail(e)})}function copyUpdate(e,t,r){var n=config_1.getUserConfigFile(r,taskInfo,null);if(logger_1.Logger.debug("copyUpdate, event: "+e+", path: "+t),"change"===e||"add"===e||"addDir"===e){var i=config_1.fillConfigDefaults(n,taskInfo.defaultConfigFile),o=findFileCopyOptions(r,i,t);if(o.length){var s=o.map(function(e){return copySrcToDest(r,e.src,e.dest,e.filter,!0)});return Promise.all(s).then(function(e){printCopyErrorMessages("copy",e);var t=e.map(function(e){return e.dest});events_1.emit(events_1.EventType.FileChange,t)})}}else if("unlink"===e||"unlinkDir"===e)return new Promise(function(n,i){var o=path_1.join(r.rootDir,t);fs.remove(o,function(t){t?i(new errors_1.BuildError(t)):("unlink"===e?events_1.emit(events_1.EventType.FileDelete,o):"unlinkDir"===e&&events_1.emit(events_1.EventType.DirectoryDelete,o),n())})});return copyWorker(r,n)}function copyWorker(e,t){var r=config_1.fillConfigDefaults(t,taskInfo.defaultConfigFile),n=r.include.map(function(t){return copySrcToDest(e,t.src,t.dest,t.filter,!0)});return Promise.all(n).then(function(e){printCopyErrorMessages("copy",e)})}function printCopyErrorMessages(e,t){t.forEach(function(t){t.success||logger_1.Logger.warn(e+": "+t.errorMessage)})}function findFileCopyOptions(e,t,r){var n=[];if(!t||!t.include||!e.rootDir)return n;r=path_1.join(e.rootDir,r);for(var o,s,a,u,i=r.split(path_1.sep);i.length>1;){o=i.join(path_1.sep);for(var c=0;c<t.include.length;c++)s=path_1.resolve(config_1.replacePathVars(e,t.include[c].src)),o===s&&(a=path_1.resolve(config_1.replacePathVars(e,t.include[c].dest)),u=r.replace(s,a),n.push({src:r,dest:u,filter:t.include[c].filter}));if(o.length<e.rootDir.length)break;i.pop()}return n}function copySrcToDest(e,t,r,n,i){return new Promise(function(o,s){t=path_1.resolve(config_1.replacePathVars(e,t)),r=path_1.resolve(config_1.replacePathVars(e,r));var a={filter:n,clobber:i};fs.copy(t,r,a,function(e){return e?void o(e.message&&e.message.indexOf("ENOENT")>-1?{success:!1,src:t,dest:r,errorMessage:'Error copying "'+t+'" to "'+r+'": File not found'}:{success:!1,src:t,dest:r,errorMessage:'Error copying "'+t+'" to "'+r+'"'}):void o({success:!0,src:t,dest:r})})})}var errors_1=require("./util/errors"),events_1=require("./util/events"),config_1=require("./util/config"),path_1=require("path"),logger_1=require("./logger/logger"),fs=require("fs-extra");exports.copy=copy,exports.copyUpdate=copyUpdate,exports.copyWorker=copyWorker,exports.findFileCopyOptions=findFileCopyOptions;var taskInfo={fullArg:"--copy",shortArg:"-y",envVar:"IONIC_COPY",packageConfig:"ionic_copy",defaultConfigFile:"copy.config"};