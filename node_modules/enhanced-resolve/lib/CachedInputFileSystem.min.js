function Storage(e){if(this.duration=e,this.running={},this.data={},this.levels=[],e>0){this.levels.push([],[],[],[],[],[],[],[],[]);for(var t=8e3;e>t;t+=500)this.levels.push([])}this.count=0,this.interval=null,this.needTickCheck=!1,this.nextTick=null,this.passive=!0,this.tick=this.tick.bind(this)}function CachedInputFileSystem(e,t){this.fileSystem=e,this._statStorage=new Storage(t),this._readdirStorage=new Storage(t),this._readFileStorage=new Storage(t),this._readJsonStorage=new Storage(t),this._readlinkStorage=new Storage(t),this._stat=this.fileSystem.stat.bind(this.fileSystem),this._readdir=this.fileSystem.readdir?this.fileSystem.readdir.bind(this.fileSystem):null,this._readFile=this.fileSystem.readFile?this.fileSystem.readFile.bind(this.fileSystem):null,this.fileSystem.readJson?this._readJson=this.fileSystem.readJson.bind(this.fileSystem):this._readJson=function(e,t){this.readFile(e,function(e,r){if(e)return t(e);try{var n=JSON.parse(r.toString("utf-8"))}catch(i){return t(i)}t(null,n)})}.bind(this),this._readlink=this.fileSystem.readlink?this.fileSystem.readlink.bind(this.fileSystem):null}Storage.prototype.ensureTick=function(){!this.interval&&this.duration>0&&!this.nextTick&&(this.interval=setInterval(this.tick,Math.floor(this.duration/this.levels.length)))},Storage.prototype.finished=function(e){var t=Array.prototype.slice.call(arguments,1),r=this.running[e];delete this.running[e],this.duration>0&&(this.count++,this.data[e]=t,this.levels[0].push(e),this.ensureTick());for(var n=0;n<r.length;n++)r[n].apply(null,t)},Storage.prototype.provide=function(e,t,r){var n=this.running[e];if(n)return void n.push(r);if(this.duration>0){this.checkTicks();var i=this.data[e];if(i)return r.apply(null,i)}this.running[e]=n=[r],t(e,this.finished.bind(this,e))},Storage.prototype.tick=function(){for(var e=this.levels.pop(),t=e.length-1;t>=0;t--)delete this.data[e[t]];if(this.count-=e.length,e.length=0,this.levels.unshift(e),0==this.count)return clearInterval(this.interval),this.interval=null,this.nextTick=null,!0;if(this.nextTick){this.nextTick+=Math.floor(this.duration/this.levels.length);var r=(new Date).getTime();if(this.nextTick>r)return this.nextTick=null,this.interval=setInterval(this.tick,Math.floor(this.duration/this.levels.length)),!0}else this.passive?(clearInterval(this.interval),this.interval=null,this.nextTick=(new Date).getTime()+Math.floor(this.duration/this.levels.length)):this.passive=!0},Storage.prototype.checkTicks=function(){if(this.passive=!1,this.nextTick)for(;!this.tick(););},Storage.prototype.purge=function(e){if(e)if("string"==typeof e)Object.keys(this.data).forEach(function(t){0===t.indexOf(e)&&delete this.data[t]},this);else for(var t=e.length-1;t>=0;t--)this.purge(e[t]);else this.count=0,clearInterval(this.interval),this.nextTick=null,this.data={},this.levels.forEach(function(e){e.length=0})},module.exports=CachedInputFileSystem,CachedInputFileSystem.prototype.isSync=function(){return this.fileSystem.isSync()},CachedInputFileSystem.prototype.stat=function(e,t){this._statStorage.provide(e,this._stat,t)},CachedInputFileSystem.prototype.readdir=function(e,t){this._readdirStorage.provide(e,this._readdir,t)},CachedInputFileSystem.prototype.readFile=function(e,t){this._readFileStorage.provide(e,this._readFile,t)},CachedInputFileSystem.prototype.readJson=function(e,t){this._readJsonStorage.provide(e,this._readJson,t)},CachedInputFileSystem.prototype.readlink=function(e,t){this._readlinkStorage.provide(e,this._readlink,t)},CachedInputFileSystem.prototype.purge=function(e){this._statStorage.purge(e),this._readdirStorage.purge(e),this._readFileStorage.purge(e),this._readlinkStorage.purge(e)};