"use strict";function callWith(t,e){return function(){return e.call(t)}}function Gauge(t,e){var n,r;t&&t.write?(r=t,n=e||{}):e&&e.write?(r=e,n=t||{}):(r=process.stderr,n=t||e||{}),this._status={spun:0,section:"",subsection:""},this._paused=!1,this._disabled=!0,this._showing=!1,this._onScreen=!1,this._needsRedraw=!1,this._hideCursor=null==n.hideCursor?!0:n.hideCursor,this._fixedFramerate=null==n.fixedFramerate?!/^v0\.8\./.test(process.version):n.fixedFramerate,this._lastUpdateAt=null,this._updateInterval=null==n.updateInterval?50:n.updateInterval,this._themes=n.themes||defaultThemes,this._theme=n.theme;var i=this._computeTheme(n.theme),o=n.template||[{type:"progressbar",length:20},{type:"activityIndicator",kerning:1,length:1},{type:"section",kerning:1,"default":""},{type:"subsection",kerning:1,"default":""}];this.setWriteTo(r,n.tty);var s=n.Plumbing||Plumbing;this._gauge=new s(i,o,this.getWidth()),this._$$doRedraw=callWith(this,this._doRedraw),this._$$handleSizeChange=callWith(this,this._handleSizeChange),(null==n.cleanupOnExit||n.cleanupOnExit)&&onExit(callWith(this,this.disable)),n.enabled||null==n.enabled&&this._tty&&this._tty.isTTY?this.enable():this.disable()}var Plumbing=require("./plumbing.js"),hasUnicode=require("has-unicode"),hasColor=require("./has-color.js"),onExit=require("signal-exit"),defaultThemes=require("./themes"),setInterval=require("./set-interval.js"),process=require("./process.js"),setImmediate=require("./set-immediate");module.exports=Gauge,Gauge.prototype={},Gauge.prototype.setTemplate=function(t){this._gauge.setTemplate(t),this._showing&&this._requestRedraw()},Gauge.prototype._computeTheme=function(t){if(t||(t={}),!t||0!==Object.keys(t).length&&null==t.hasUnicode&&null==t.hasColor)"string"==typeof t&&(t=this._themes.getTheme(t));else{var e=null==t.hasUnicode?hasUnicode():t.hasUnicode,n=null==t.hasColor?hasColor:t.hasColor;t=this._themes.getDefault({hasUnicode:e,hasColor:n,platform:t.platform})}return t},Gauge.prototype.setThemeset=function(t){this._themes=t,this.setTheme(this._theme)},Gauge.prototype.setTheme=function(t){this._gauge.setTheme(this._computeTheme(t)),this._showing&&this._requestRedraw(),this._theme=t},Gauge.prototype._requestRedraw=function(){this._needsRedraw=!0,this._fixedFramerate||this._doRedraw()},Gauge.prototype.getWidth=function(){return(this._tty&&this._tty.columns||80)-1},Gauge.prototype.setWriteTo=function(t,e){var n=!this._disabled;n&&this.disable(),this._writeTo=t,this._tty=e||t===process.stderr&&process.stdout.isTTY&&process.stdout||t.isTTY&&t||this._tty,this._gauge&&this._gauge.setWidth(this.getWidth()),n&&this.enable()},Gauge.prototype.enable=function(){this._disabled&&(this._disabled=!1,this._tty&&this._enableEvents(),this._showing&&this.show())},Gauge.prototype.disable=function(){this._disabled||(this._showing&&(this._lastUpdateAt=null,this._showing=!1,this._doRedraw(),this._showing=!0),this._disabled=!0,this._tty&&this._disableEvents())},Gauge.prototype._enableEvents=function(){this._tty.on("resize",this._$$handleSizeChange),this._fixedFramerate&&(this.redrawTracker=setInterval(this._$$doRedraw,this._updateInterval),this.redrawTracker.unref&&this.redrawTracker.unref())},Gauge.prototype._disableEvents=function(){this._tty.removeListener("resize",this._$$handleSizeChange),this._fixedFramerate&&clearInterval(this.redrawTracker)},Gauge.prototype.hide=function(t){return this._disabled?t&&process.nextTick(t):this._showing?(this._showing=!1,this._doRedraw(),void(t&&setImmediate(t))):t&&process.nextTick(t)},Gauge.prototype.show=function(t,e){if(!this._disabled){if(this._showing=!0,"string"==typeof t)this._status.section=t;else if("object"==typeof t)for(var n=Object.keys(t),r=0;r<n.length;++r){var i=n[r];this._status[i]=t[i]}null!=e&&(this._status.completed=e),this._requestRedraw()}},Gauge.prototype.pulse=function(t){this._disabled||this._showing&&(this._status.subsection=t||"",this._status.spun++,this._requestRedraw())},Gauge.prototype._handleSizeChange=function(){this._gauge.setWidth(this._tty.columns-1),this._requestRedraw()},Gauge.prototype._doRedraw=function(){if(!this._disabled&&!this._paused){if(!this._fixedFramerate){var t=Date.now();if(this._lastUpdateAt&&t-this._lastUpdateAt<this._updateInterval)return;this._lastUpdateAt=t}if(!this._showing&&this._onScreen){this._onScreen=!1;var e=this._gauge.hide();return this._hideCursor&&(e+=this._gauge.showCursor()),this._writeTo.write(e)}(this._showing||this._onScreen)&&(this._showing&&!this._onScreen&&(this._onScreen=!0,this._needsRedraw=!0,this._hideCursor&&this._writeTo.write(this._gauge.hideCursor())),this._needsRedraw&&(this._writeTo.write(this._gauge.show(this._status))||(this._paused=!0,this._writeTo.on("drain",callWith(this,function(){this._paused=!1,this._doRedraw()})))))}};