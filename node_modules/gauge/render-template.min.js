"use strict";function renderValueWithValues(t){return function(e){return renderValue(e,t)}}function preType(t){var e=t.type[0].toUpperCase()+t.type.slice(1);return"pre"+e}function postType(t){var e=t.type[0].toUpperCase()+t.type.slice(1);return"post"+e}function hasPreOrPost(t,e){return t.type?e[preType(t)]||e[postType(t)]:void 0}function generatePreAndPost(t,e){var n=objectAssign({},t),r=Object.create(e),i=[],o=preType(n),s=postType(n);return r[o]&&(i.push({value:r[o]}),r[o]=null),n.minLength=null,n.length=null,n.maxLength=null,i.push(n),r[n.type]=r[n.type],r[s]&&(i.push({value:r[s]}),r[s]=null),function(t,e,n){return renderTemplate(n,i,r)}}function prepareItems(t,e,n){function r(e,r,i){var o=new TemplateItem(e,t),s=o.type;if(null==o.value)if(s in n)o.value=n[s];else{if(null==o["default"])throw new error.MissingTemplateValue(o,n);o.value=o["default"]}return null==o.value||""===o.value?null:(o.index=r,o.first=0===r,o.last=r===i.length-1,hasPreOrPost(o,n)&&(o.value=generatePreAndPost(o,n)),o)}function c(t){t>s&&(t=s),o+=t,s-=t}function l(t,e){if(t.finished)throw new error.Internal("Tried to finish template item that was already finished");if(e===1/0)throw new error.Internal("Length of template item cannot be infinity");if(null!=e&&(t.length=e),t.minLength=null,t.maxLength=null,--a,t.finished=!0,null==t.length&&(t.length=t.getBaseLength()),null==t.length)throw new error.Internal("Finished template items must have a length");c(t.getLength())}var i=e.map(r).filter(function(t){return null!=t}),o=0,s=t,a=i.length;i.forEach(function(t){if(t.kerning){var e=t.first?0:i[t.index-1].padRight;!t.first&&e<t.kerning&&(t.padLeft=t.kerning-e),t.last||(t.padRight=t.kerning)}}),i.forEach(function(t){null!=t.getBaseLength()&&l(t)});var h,p,u=0;do h=!1,p=Math.round(s/a),i.forEach(function(t){t.finished||t.maxLength&&t.getMaxLength()<p&&(l(t,t.maxLength),h=!0)});while(h&&u++<i.length);if(h)throw new error.Internal("Resize loop iterated too many times while determining maxLength");u=0;do h=!1,p=Math.round(s/a),i.forEach(function(t){t.finished||t.minLength&&t.getMinLength()>=p&&(l(t,t.minLength),h=!0)});while(h&&u++<i.length);if(h)throw new error.Internal("Resize loop iterated too many times while determining minLength");return p=Math.round(s/a),i.forEach(function(t){t.finished||l(t,p)}),i}function renderFunction(t,e,n){return validate("OON",arguments),t.type?t.value(e,e[t.type+"Theme"]||{},n):t.value(e,{},n)}function renderValue(t,e){var n=t.getBaseLength(),r="function"==typeof t.value?renderFunction(t,e,n):t.value;if(null==r||""===r)return"";var i=align[t.align]||align.left,o=t.padLeft?align.left("",t.padLeft):"",s=t.padRight?align.right("",t.padRight):"",a=wideTruncate(String(r),n),c=i(a,n);return o+c+s}var align=require("wide-align"),validate=require("aproba"),objectAssign=require("object-assign"),wideTruncate=require("./wide-truncate"),error=require("./error"),TemplateItem=require("./template-item"),renderTemplate=module.exports=function(t,e,n){var r=prepareItems(t,e,n),i=r.map(renderValueWithValues(n)).join("");return align.left(wideTruncate(i,t),t)};