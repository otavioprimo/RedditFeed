"use strict";function FSWatcher(t){function r(t){return void 0===e[t]}EventEmitter.call(this);var e={};if(t)for(var n in t)e[n]=t[n];this._watched=Object.create(null),this._closers=Object.create(null),this._ignoredPaths=Object.create(null),Object.defineProperty(this,"_globIgnored",{get:function(){return Object.keys(this._ignoredPaths)}}),this.closed=!1,this._throttled=Object.create(null),this._symlinkPaths=Object.create(null),r("persistent")&&(e.persistent=!0),r("ignoreInitial")&&(e.ignoreInitial=!1),r("ignorePermissionErrors")&&(e.ignorePermissionErrors=!1),r("interval")&&(e.interval=100),r("binaryInterval")&&(e.binaryInterval=300),this.enableBinaryInterval=e.binaryInterval!==e.interval,r("useFsEvents")&&(e.useFsEvents=!e.usePolling),FsEventsHandler.canUse()||(e.useFsEvents=!1),r("usePolling")&&!e.useFsEvents&&(e.usePolling="darwin"===process.platform);var i=process.env.CHOKIDAR_USEPOLLING;if(void 0!==i){var o=i.toLowerCase();"false"===o||"0"===o?e.usePolling=!1:"true"===o||"1"===o?e.usePolling=!0:e.usePolling=!!o}r("atomic")&&(e.atomic=!e.usePolling&&!e.useFsEvents),e.atomic&&(this._pendingUnlinks=Object.create(null)),r("followSymlinks")&&(e.followSymlinks=!0),r("awaitWriteFinish")&&(e.awaitWriteFinish=!1),e.awaitWriteFinish===!0&&(e.awaitWriteFinish={});var s=e.awaitWriteFinish;s&&(s.stabilityThreshold||(s.stabilityThreshold=2e3),s.pollInterval||(s.pollInterval=100),this._pendingWrites=Object.create(null)),e.ignored&&(e.ignored=arrify(e.ignored)),this._isntIgnored=function(t,e){return!this._isIgnored(t,e)}.bind(this);var a=0;this._emitReady=function(){++a>=this._readyCount&&(this._emitReady=Function.prototype,this._readyEmitted=!0,process.nextTick(this.emit.bind(this,"ready")))}.bind(this),this.options=e,Object.freeze(e)}function importHandler(t){Object.keys(t.prototype).forEach(function(e){FSWatcher.prototype[e]=t.prototype[e]})}var EventEmitter=require("events").EventEmitter,fs=require("fs"),sysPath=require("path"),asyncEach=require("async-each"),anymatch=require("anymatch"),globParent=require("glob-parent"),isGlob=require("is-glob"),isAbsolute=require("path-is-absolute"),inherits=require("inherits"),NodeFsHandler=require("./lib/nodefs-handler"),FsEventsHandler=require("./lib/fsevents-handler"),arrify=function(t){return null==t?[]:Array.isArray(t)?t:[t]},flatten=function(t,e){return null==e&&(e=[]),t.forEach(function(t){Array.isArray(t)?flatten(t,e):e.push(t)}),e},isString=function(t){return"string"==typeof t};inherits(FSWatcher,EventEmitter),FSWatcher.prototype._emit=function(t,e,n,r,i){this.options.cwd&&(e=sysPath.relative(this.options.cwd,e));var o=[t,e];void 0!==i?o.push(n,r,i):void 0!==r?o.push(n,r):void 0!==n&&o.push(n);var s=this.options.awaitWriteFinish;if(s&&this._pendingWrites[e])return this._pendingWrites[e].lastChange=new Date,this;if(this.options.atomic){if("unlink"===t)return this._pendingUnlinks[e]=o,setTimeout(function(){Object.keys(this._pendingUnlinks).forEach(function(t){this.emit.apply(this,this._pendingUnlinks[t]),this.emit.apply(this,["all"].concat(this._pendingUnlinks[t])),delete this._pendingUnlinks[t]}.bind(this))}.bind(this),"number"==typeof this.options.atomic?this.options.atomic:100),this;"add"===t&&this._pendingUnlinks[e]&&(t=o[0]="change",delete this._pendingUnlinks[e])}var a=function(){this.emit.apply(this,o),"error"!==t&&this.emit.apply(this,["all"].concat(o))}.bind(this);if(s&&("add"===t||"change"===t)&&this._readyEmitted){var c=function(e,n){e?(t=o[0]="error",o[1]=e,a()):n&&(o.length>2?o[2]=n:o.push(n),a())};return this._awaitWriteFinish(e,s.stabilityThreshold,t,c),this}if("change"===t&&!this._throttle("change",e,50))return this;if(!this.options.alwaysStat||void 0!==n||"add"!==t&&"addDir"!==t&&"change"!==t)a();else{var l=this.options.cwd?sysPath.join(this.options.cwd,e):e;fs.stat(l,function(t,e){!t&&e&&(o.push(e),a())})}return this},FSWatcher.prototype._handleError=function(t){var e=t&&t.code,n=this.options.ignorePermissionErrors;return t&&"ENOENT"!==e&&"ENOTDIR"!==e&&(!n||"EPERM"!==e&&"EACCES"!==e)&&this.emit("error",t),t||this.closed},FSWatcher.prototype._throttle=function(t,e,n){function i(){delete r[e],clearTimeout(o)}t in this._throttled||(this._throttled[t]=Object.create(null));var r=this._throttled[t];if(e in r)return!1;var o=setTimeout(i,n);return r[e]={timeoutObject:o,clear:i},r[e]},FSWatcher.prototype._awaitWriteFinish=function(t,e,n,r){var i,o=t;this.options.cwd&&!isAbsolute(t)&&(o=sysPath.join(this.options.cwd,t));var s=new Date,a=function(n){fs.stat(o,function(o,s){if(o)return void("ENOENT"!==o.code&&r(o));var c=new Date;n&&s.size!=n.size&&(this._pendingWrites[t].lastChange=c),c-this._pendingWrites[t].lastChange>=e?(delete this._pendingWrites[t],r(null,s)):i=setTimeout(a.bind(this,s),this.options.awaitWriteFinish.pollInterval)}.bind(this))}.bind(this);t in this._pendingWrites||(this._pendingWrites[t]={lastChange:s,cancelWait:function(){return delete this._pendingWrites[t],clearTimeout(i),n}.bind(this)},i=setTimeout(a.bind(this),this.options.awaitWriteFinish.pollInterval))};var dotRe=/\..*\.(sw[px])$|\~$|\.subl.*\.tmp/;FSWatcher.prototype._isIgnored=function(t,e){if(this.options.atomic&&dotRe.test(t))return!0;if(!this._userIgnored){var n=this.options.cwd,r=this.options.ignored;n&&r&&(r=r.map(function(t){return"string"!=typeof t?t:isAbsolute(t)?t:sysPath.join(n,t)}));var i=arrify(r).filter(function(t){return"string"==typeof t&&!isGlob(t)}).map(function(t){return t+"/**"});this._userIgnored=anymatch(this._globIgnored.concat(r).concat(i))}return this._userIgnored([t,e])};var replacerRe=/^\.[\/\\]/;FSWatcher.prototype._getWatchHelpers=function(t,e){t=t.replace(replacerRe,"");var n=e||!isGlob(t)?t:globParent(t),r=sysPath.resolve(n),i=n!==t,o=i?anymatch(t):!1,s=this.options.followSymlinks,a=i&&s?null:!1,c=function(t){return null==a&&(a=t.fullParentDir===r?!1:{realPath:t.fullParentDir,linkPath:r}),a?t.fullPath.replace(a.realPath,a.linkPath):t.fullPath},l=function(t){return sysPath.join(n,sysPath.relative(n,c(t)))},u=function(t){if(t.stat&&t.stat.isSymbolicLink())return d(t);var e=l(t);return(!i||o(e))&&this._isntIgnored(e,t.stat)&&(this.options.ignorePermissionErrors||this._hasReadPermissions(t.stat))}.bind(this),h=function(t){if(!i)return!1;var e=sysPath.relative(n,t).split(/[\/\\]/);return e},p=h(t);p&&p.length>1&&p.pop();var f,d=function(t){if(i){var e=h(c(t)),n=!1;f=!p.every(function(t,r){return"**"===t&&(n=!0),n||!e[r]||anymatch(t,e[r])})}return!f&&this._isntIgnored(l(t),t.stat)}.bind(this);return{followSymlinks:s,statMethod:s?"stat":"lstat",path:t,watchPath:n,entryPath:l,hasGlob:i,globFilter:o,filterPath:u,filterDir:d}},FSWatcher.prototype._getWatchedDir=function(t){var e=sysPath.resolve(t),n=this._remove.bind(this);return e in this._watched||(this._watched[e]={_items:Object.create(null),add:function(t){"."!==t&&(this._items[t]=!0)},remove:function(t){delete this._items[t],this.children().length||fs.readdir(e,function(t){t&&n(sysPath.dirname(e),sysPath.basename(e))})},has:function(t){return t in this._items},children:function(){return Object.keys(this._items)}}),this._watched[e]},FSWatcher.prototype._hasReadPermissions=function(t){return Boolean(4&parseInt((511&(t&&t.mode)).toString(8)[0],10))},FSWatcher.prototype._remove=function(t,e){var n=sysPath.join(t,e),r=sysPath.resolve(n),i=this._watched[n]||this._watched[r];if(this._throttle("remove",n,100)){var o=Object.keys(this._watched);i||this.options.useFsEvents||1!==o.length||this.add(t,e,!0);var s=this._getWatchedDir(n).children();s.forEach(function(t){this._remove(n,t)},this);var a=this._getWatchedDir(t),c=a.has(e);a.remove(e);var l=n;if(this.options.cwd&&(l=sysPath.relative(this.options.cwd,n)),this.options.awaitWriteFinish&&this._pendingWrites[l]){var u=this._pendingWrites[l].cancelWait();if("add"===u)return}delete this._watched[n],delete this._watched[r];var h=i?"unlinkDir":"unlink";c&&!this._isIgnored(n)&&this._emit(h,n),this.options.useFsEvents||this._closePath(n)}},FSWatcher.prototype._closePath=function(t){this._closers[t]&&(this._closers[t](),delete this._closers[t],this._getWatchedDir(sysPath.dirname(t)).remove(sysPath.basename(t)))},FSWatcher.prototype.add=function(t,e,n){var r=this.options.cwd;if(this.closed=!1,t=flatten(arrify(t)),!t.every(isString))throw new TypeError("Non-string provided as watch path: "+t);return r&&(t=t.map(function(t){return isAbsolute(t)?t:"!"===t[0]?"!"+sysPath.join(r,t.substring(1)):sysPath.join(r,t)})),t=t.filter(function(t){return"!"!==t[0]?(delete this._ignoredPaths[t],delete this._ignoredPaths[t+"/**"],this._userIgnored=null,!0):void(this._ignoredPaths[t.substring(1)]=!0)},this),this.options.useFsEvents&&FsEventsHandler.canUse()?(this._readyCount||(this._readyCount=t.length),this.options.persistent&&(this._readyCount*=2),t.forEach(this._addToFsEvents,this)):(this._readyCount||(this._readyCount=0),this._readyCount+=t.length,asyncEach(t,function(t,r){this._addToNodeFs(t,!n,0,0,e,function(t,e){e&&this._emitReady(),r(t,e)}.bind(this))}.bind(this),function(t,n){n.forEach(function(t){t&&this.add(sysPath.dirname(t),sysPath.basename(e||t))},this)}.bind(this))),this},FSWatcher.prototype.unwatch=function(t){return this.closed?this:(t=flatten(arrify(t)),t.forEach(function(t){isAbsolute(t)||this._closers[t]||(this.options.cwd&&(t=sysPath.join(this.options.cwd,t)),t=sysPath.resolve(t)),this._closePath(t),this._ignoredPaths[t]=!0,t in this._watched&&(this._ignoredPaths[t+"/**"]=!0),this._userIgnored=null},this),this)},FSWatcher.prototype.close=function(){return this.closed?this:(this.closed=!0,Object.keys(this._closers).forEach(function(t){this._closers[t](),delete this._closers[t]},this),this._watched=Object.create(null),this.removeAllListeners(),this)},FSWatcher.prototype.getWatched=function(){var t={};return Object.keys(this._watched).forEach(function(e){var n=this.options.cwd?sysPath.relative(this.options.cwd,e):e;t[n||"."]=Object.keys(this._watched[e]._items).sort()}.bind(this)),t},importHandler(NodeFsHandler),FsEventsHandler.canUse()&&importHandler(FsEventsHandler),exports.FSWatcher=FSWatcher,exports.watch=function(t,e){return new FSWatcher(e).add(t)};