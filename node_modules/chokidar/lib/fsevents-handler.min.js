"use strict";function createFSEventsInstance(e,t){return new fsevents(e).on("fsevent",t).start()}function setFSEventsListener(e,t,r,n){function l(e,n,i){u&&(e=e.replace(t,o)),e!==o&&e.indexOf(o+sysPath.sep)||r(e,n,i)}function c(){return Object.keys(FSEventsWatchers).some(function(e){return t.indexOf(sysPath.resolve(e)+sysPath.sep)?void 0:(i=e,!0)})}var a,i=sysPath.extname(e)?sysPath.dirname(e):e,s=sysPath.dirname(i);couldConsolidate(s)&&(i=s);var o=sysPath.resolve(e),u=o!==t;i in FSEventsWatchers||c()?(a=FSEventsWatchers[i],a.listeners.push(l)):a=FSEventsWatchers[i]={listeners:[l],rawEmitters:[n],watcher:createFSEventsInstance(i,function(e,t){var r=fsevents.getInfo(e,t);a.listeners.forEach(function(n){n(e,t,r)}),a.rawEmitters.forEach(function(t){t(r.event,e,r)})})};var f=a.listeners.length-1;return function(){delete a.listeners[f],delete a.rawEmitters[f],Object.keys(a.listeners).length||(a.watcher.stop(),delete FSEventsWatchers[i])}}function couldConsolidate(e){for(var t=Object.keys(FSEventsWatchers),r=0,n=0,i=t.length;i>n;++n){var a=t[n];if(0===a.indexOf(e)&&(r++,r>=consolidateThreshhold))return!0}return!1}function canUse(){return fsevents&&Object.keys(FSEventsWatchers).length<128}function depth(e,t){for(var r=0;!e.indexOf(t)&&(e=sysPath.dirname(e))!==t;)r++;return r}function FsEventsHandler(){}var fs=require("fs"),sysPath=require("path"),readdirp=require("readdirp"),fsevents;try{fsevents=require("fsevents")}catch(error){}var FSEventsWatchers=Object.create(null),consolidateThreshhold=10;FsEventsHandler.prototype._watchWithFsEvents=function(e,t,r,n){if(!this._isIgnored(e)){var i=function(i,a,s){function h(){p(c.has(l)?"change":"add")}function d(){fs.open(o,"r",function(e,t){t&&fs.close(t),e&&"EACCES"!==e.code?p("unlink"):h()})}if(!(void 0!==this.options.depth&&depth(i,t)>this.options.depth)){var o=r(sysPath.join(e,sysPath.relative(e,i)));if(!n||n(o)){var u=sysPath.dirname(o),l=sysPath.basename(o),c=this._getWatchedDir("directory"===s.type?o:u),f=function(e){return this._isIgnored(o,e)?(this._ignoredPaths[o]=!0,e&&e.isDirectory()&&(this._ignoredPaths[o+"/**/*"]=!0),!0):(delete this._ignoredPaths[o],void delete this._ignoredPaths[o+"/**/*"])}.bind(this),p=function(e){if(!f())if("unlink"===e)("directory"===s.type||c.has(l))&&this._remove(u,l);else{if("add"===e){if("directory"===s.type&&this._getWatchedDir(o),"symlink"===s.type&&this.options.followSymlinks){var r=void 0===this.options.depth?void 0:depth(i,t)+1;return this._addToFsEvents(o,!1,!0,r)}this._getWatchedDir(u).add(l)}var n="directory"===s.type?e+"Dir":e;this._emit(n,o),"addDir"===n&&this._addToFsEvents(o,!1,!0)}}.bind(this),v=[69888,70400,71424,72704,73472,131328,131840,262912];if(-1!==v.indexOf(a)||"unknown"===s.event)"function"==typeof this.options.ignored?fs.stat(o,function(e,t){f(t)||(t?h():p("unlink"))}):d();else switch(s.event){case"created":case"modified":return h();case"deleted":case"moved":return d()}}}}.bind(this),a=setFSEventsListener(e,t,i,this.emit.bind(this,"raw"));return this._emitReady(),a}},FsEventsHandler.prototype._handleFsEventsSymlink=function(e,t,r,n){this._symlinkPaths[t]||(this._symlinkPaths[t]=!0,this._readyCount++,fs.realpath(e,function(t,i){return this._handleError(t)||this._isIgnored(i)?this._emitReady():(this._readyCount++,void this._addToFsEvents(i||e,function(t){var n="."+sysPath.sep,a=e;return i&&i!==n?a=t.replace(i,e):t!==n&&(a=sysPath.join(e,t)),r(a)},!1,n))}.bind(this)))},FsEventsHandler.prototype._addToFsEvents=function(e,t,r,n){var i="function"==typeof t?t:function(e){return e},a=function(e,t){var n=i(e),a=t.isDirectory(),s=this._getWatchedDir(sysPath.dirname(n)),o=sysPath.basename(n);a&&this._getWatchedDir(n),s.has(o)||(s.add(o),this.options.ignoreInitial&&r!==!0||this._emit(a?"addDir":"add",n,t))}.bind(this),s=this._getWatchHelpers(e);if(fs[s.statMethod](s.watchPath,function(t,r){if(this._handleError(t)||this._isIgnored(s.watchPath,r))return this._emitReady(),this._emitReady();if(r.isDirectory()){if(s.globFilter||a(i(e),r),n&&n>this.options.depth)return;readdirp({root:s.watchPath,entryType:"all",fileFilter:s.filterPath,directoryFilter:s.filterDir,lstat:!0,depth:this.options.depth-(n||0)}).on("data",function(e){if(!e.stat.isDirectory()||s.filterPath(e)){var t=sysPath.join(s.watchPath,e.path),r=e.fullPath;if(s.followSymlinks&&e.stat.isSymbolicLink()){var n=void 0===this.options.depth?void 0:depth(t,sysPath.resolve(s.watchPath))+1;this._handleFsEventsSymlink(t,r,i,n)}else a(t,e.stat)}}.bind(this)).on("error",function(){}).on("end",this._emitReady)}else a(s.watchPath,r),this._emitReady()}.bind(this)),this.options.persistent&&r!==!0){var o=function(t,r){var n=this._watchWithFsEvents(s.watchPath,sysPath.resolve(r||s.watchPath),i,s.globFilter);n&&(this._closers[e]=n)}.bind(this);"function"==typeof t?o():fs.realpath(s.watchPath,o)}},module.exports=FsEventsHandler,module.exports.canUse=canUse;