"use strict";function createFsWatchInstance(e,t,r,n,i){var a=function(t,n){r(e),i(t,n,{watchedPath:e}),n&&e!==n&&fsWatchBroadcast(sysPath.resolve(e,n),"listeners",sysPath.join(e,n))};try{return fs.watch(e,t,a)}catch(s){n(s)}}function fsWatchBroadcast(e,t,r,n,i){FsWatchInstances[e]&&FsWatchInstances[e][t].forEach(function(e){e(r,n,i)})}function setFsWatchListener(e,t,r,n){var u,i=n.listener,a=n.errHandler,s=n.rawEmitter,o=FsWatchInstances[t];if(!r.persistent)return u=createFsWatchInstance(e,r,i,a,s),u.close.bind(u);if(o)o.listeners.push(i),o.errHandlers.push(a),o.rawEmitters.push(s);else{if(u=createFsWatchInstance(e,r,fsWatchBroadcast.bind(null,t,"listeners"),a,fsWatchBroadcast.bind(null,t,"rawEmitters")),!u)return;var l=fsWatchBroadcast.bind(null,t,"errHandlers");u.on("error",function(t){"win32"===process.platform&&"EPERM"===t.code?fs.open(e,"r",function(e,r){r&&fs.close(r),e||l(t)}):l(t)}),o=FsWatchInstances[t]={listeners:[i],errHandlers:[a],rawEmitters:[s],watcher:u}}var c=o.listeners.length-1;return function(){delete o.listeners[c],delete o.errHandlers[c],delete o.rawEmitters[c],Object.keys(o.listeners).length||(o.watcher.close(),delete FsWatchInstances[t])}}function setFsWatchFileListener(e,t,r,n){var i=n.listener,a=n.rawEmitter,s=FsWatchFileInstances[t],o=[],u=[];s&&(s.options.persistent<r.persistent||s.options.interval>r.interval)&&(o=s.listeners,u=s.rawEmitters,fs.unwatchFile(t),s=!1),s?(s.listeners.push(i),s.rawEmitters.push(a)):(o.push(i),u.push(a),s=FsWatchFileInstances[t]={listeners:o,rawEmitters:u,options:r,watcher:fs.watchFile(t,r,function(r,n){s.rawEmitters.forEach(function(e){e("change",t,{curr:r,prev:n})});var i=r.mtime.getTime();(r.size!==n.size||i>n.mtime.getTime()||0===i)&&s.listeners.forEach(function(t){t(e,r)})})});var l=s.listeners.length-1;return function(){delete s.listeners[l],delete s.rawEmitters[l],Object.keys(s.listeners).length||(fs.unwatchFile(t),delete FsWatchFileInstances[t])}}function NodeFsHandler(){}var fs=require("fs"),sysPath=require("path"),readdirp=require("readdirp"),isBinaryPath=require("is-binary-path"),FsWatchInstances=Object.create(null),FsWatchFileInstances=Object.create(null);NodeFsHandler.prototype._watchWithNodeFs=function(e,t){var r=sysPath.dirname(e),n=sysPath.basename(e),i=this._getWatchedDir(r);i.add(n);var a=sysPath.resolve(e),s={persistent:this.options.persistent};t||(t=Function.prototype);var o;return this.options.usePolling?(s.interval=this.enableBinaryInterval&&isBinaryPath(n)?this.options.binaryInterval:this.options.interval,o=setFsWatchFileListener(e,a,s,{listener:t,rawEmitter:this.emit.bind(this,"raw")})):o=setFsWatchListener(e,a,s,{listener:t,errHandler:this._handleError.bind(this),rawEmitter:this.emit.bind(this,"raw")}),o},NodeFsHandler.prototype._handleFile=function(e,t,r,n){var i=sysPath.dirname(e),a=sysPath.basename(e),s=this._getWatchedDir(i);if(s.has(a))return n();var o=this._watchWithNodeFs(e,function(t,r){this._throttle("watch",e,5)&&(!r||r&&0===r.mtime.getTime()?fs.stat(e,function(t,r){t?this._remove(i,a):this._emit("change",e,r)}.bind(this)):s.has(a)&&this._emit("change",e,r))}.bind(this));if(!r||!this.options.ignoreInitial){if(!this._throttle("add",e,0))return;this._emit("add",e,t)}return n&&n(),o},NodeFsHandler.prototype._handleSymlink=function(e,t,r,n){var i=e.fullPath,a=this._getWatchedDir(t);return this.options.followSymlinks?this._symlinkPaths[i]?!0:void(this._symlinkPaths[i]=!0):(this._readyCount++,fs.realpath(r,function(t,s){a.has(n)?this._symlinkPaths[i]!==s&&(this._symlinkPaths[i]=s,this._emit("change",r,e.stat)):(a.add(n),this._symlinkPaths[i]=s,this._emit("add",r,e.stat)),this._emitReady()}.bind(this)),!0)},NodeFsHandler.prototype._handleDir=function(e,t,r,n,i,a,s){var o=this._getWatchedDir(sysPath.dirname(e)),u=o.has(sysPath.basename(e));r&&this.options.ignoreInitial||i||u||(!a.hasGlob||a.globFilter(e))&&this._emit("addDir",e,t),o.add(sysPath.basename(e)),this._getWatchedDir(e);var c,l=function(t,r,s){if(t=sysPath.join(t,""),!a.hasGlob){var o=this._throttle("readdir",t,1e3);if(!o)return}var u=this._getWatchedDir(a.path),l=[];readdirp({root:t,entryType:"all",fileFilter:a.filterPath,directoryFilter:a.filterDir,depth:0,lstat:!0}).on("data",function(s){var o=s.path,c=sysPath.join(t,o);l.push(o),s.stat.isSymbolicLink()&&this._handleSymlink(s,t,c,o)||(o===i||!i&&!u.has(o))&&(this._readyCount++,c=sysPath.join(e,sysPath.relative(e,c)),this._addToNodeFs(c,r,a,n+1))}.bind(this)).on("end",function(){o&&o.clear(),s&&s(),u.children().filter(function(e){return e!==t&&-1===l.indexOf(e)&&(!a.hasGlob||a.filterPath({fullPath:sysPath.resolve(t,e)}))}).forEach(function(e){this._remove(t,e)},this)}.bind(this)).on("error",this._handleError.bind(this))}.bind(this);return null==this.options.depth||n<=this.options.depth?(i||l(e,r,s),c=this._watchWithNodeFs(e,function(e,t){t&&0===t.mtime.getTime()||l(e,!1)})):s(),c},NodeFsHandler.prototype._addToNodeFs=function(e,t,r,n,i,a){a||(a=Function.prototype);var s=this._emitReady;if(this._isIgnored(e)||this.closed)return s(),a(null,!1);var o=this._getWatchHelpers(e,n);!o.hasGlob&&r&&(o.hasGlob=r.hasGlob,o.globFilter=r.globFilter,o.filterPath=r.filterPath,o.filterDir=r.filterDir),fs[o.statMethod](o.watchPath,function(r,u){if(this._handleError(r))return a(null,e);if(this._isIgnored(o.watchPath,u))return s(),a(null,!1);var c,l=function(e,r){return this._handleDir(e,u,t,n,r,o,s)}.bind(this);if(u.isDirectory())c=l(o.watchPath,i);else if(u.isSymbolicLink()){var f=sysPath.dirname(o.watchPath);this._getWatchedDir(f).add(o.watchPath),this._emit("add",o.watchPath,u),c=l(f,e),fs.realpath(e,function(t,r){this._symlinkPaths[sysPath.resolve(e)]=r,s()}.bind(this))}else c=this._handleFile(o.watchPath,u,t,s);c&&(this._closers[e]=c),a(null,!1)}.bind(this))},module.exports=NodeFsHandler;