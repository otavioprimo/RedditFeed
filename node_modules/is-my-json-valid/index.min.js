var genobj=require("generate-object-property"),genfun=require("generate-function"),jsonpointer=require("jsonpointer"),xtend=require("xtend"),formats=require("./formats"),get=function(t,e,n){var r=function(t){return t&&t.id===n?t:"object"==typeof t&&t?Object.keys(t).reduce(function(e,n){return e||r(t[n])},null):null},i=r(t);if(i)return i;n=n.replace(/^#/,""),n=n.replace(/\/$/,"");try{return jsonpointer.get(t,decodeURI(n))}catch(o){var a,s=n.indexOf("#");if(0!==s)if(-1===s)a=e[n];else{var c=n.slice(0,s);a=e[c];var l=n.slice(s).replace(/^#/,"");try{return jsonpointer.get(a,l)}catch(o){}}else a=e[n];return a||null}},formatName=function(t){t=JSON.stringify(t);for(var e=/\[([^\[\]"]+)\]/;e.test(t);)t=t.replace(e,'."+$1+"');return t},types={};types.any=function(){return"true"},types["null"]=function(t){return t+" === null"},types["boolean"]=function(t){return"typeof "+t+' === "boolean"'},types.array=function(t){return"Array.isArray("+t+")"},types.object=function(t){return"typeof "+t+' === "object" && '+t+" && !Array.isArray("+t+")"},types.number=function(t){return"typeof "+t+' === "number"'},types.integer=function(t){return"typeof "+t+' === "number" && (Math.floor('+t+") === "+t+" || "+t+" > 9007199254740992 || "+t+" < -9007199254740992)"},types.string=function(t){return"typeof "+t+' === "string"'};var unique=function(t){for(var e=[],n=0;n<t.length;n++)e.push("object"==typeof t[n]?JSON.stringify(t[n]):t[n]);for(var n=1;n<e.length;n++)if(e.indexOf(e[n])!==n)return!1;return!0},isMultipleOf=function(t,e){var n,r=(0|e)!==e?Math.pow(10,e.toString().split(".").pop().length):1;if(r>1){var i=(0|t)!==t?Math.pow(10,t.toString().split(".").pop().length):1;n=i>r?!0:Math.round(r*t)%(r*e)}else n=t%e;return!n},toType=function(t){return t.type},compile=function(t,e,n,r,i){var o=i?xtend(formats,i.formats):formats,s={unique:unique,formats:o,isMultipleOf:isMultipleOf},a=i?!!i.verbose:!1,c=i&&void 0!==i.greedy?i.greedy:!1,l={},u=function(t){return t+(l[t]=(l[t]||0)+1)},h={},p=function(t){if(h[t])return h[t];var e=u("pattern");return s[e]=new RegExp(t),h[t]=e,e},f=["i","j","k","l","m","n","o","p","q","r","s","t","u","v","x","y","z"],d=function(){var t=f.shift();return f.push(t+t[0]),t},_=function(t,r,l,h){var f=r.properties,y=r.type,m=!1;Array.isArray(r.items)&&(f={},r.items.forEach(function(t,e){f[e]=t}),y="array",m=!0);var v=0,b=function(e,n,r){g("errors++"),l===!0&&(g("if (validate.errors === null) validate.errors = []"),a?g("validate.errors.push({field:%s,message:%s,value:%s,type:%s})",formatName(n||t),JSON.stringify(e),r||t,JSON.stringify(y)):g("validate.errors.push({field:%s,message:%s})",formatName(n||t),JSON.stringify(e)))};r.required===!0?(v++,g("if (%s === undefined) {",t),b("is required"),g("} else {")):(v++,g("if (%s !== undefined) {",t));var w=[].concat(y).map(function(e){return types[e||"any"](t)}).join(" || ")||"true";if("true"!==w&&(v++,g("if (!(%s)) {",w),b("is the wrong type"),g("} else {")),m)if(r.additionalItems===!1)g("if (%s.length > %d) {",t,r.items.length),b("has additional items"),g("}");else if(r.additionalItems){var E=d();g("for (var %s = %d; %s < %s.length; %s++) {",E,r.items.length,E,t,E),_(t+"["+E+"]",r.additionalItems,l,h),g("}")}if(r.format&&o[r.format]){"string"!==y&&formats[r.format]&&g("if (%s) {",types.string(t));var x=u("format");s[x]=o[r.format],"function"==typeof s[x]?g("if (!%s(%s)) {",x,t):g("if (!%s.test(%s)) {",x,t),b("must be "+r.format+" format"),g("}"),"string"!==y&&formats[r.format]&&g("}")}if(Array.isArray(r.required)){var S=function(e){var n=genobj(t,e);g("if (%s === undefined) {",n),b("is required",n),g("missing++"),g("}")};g("if ((%s)) {","object"!==y?types.object(t):"true"),g("var missing = 0"),r.required.map(S),g("}"),c||(g("if (missing === 0) {"),v++)}if(r.uniqueItems&&("array"!==y&&g("if (%s) {",types.array(t)),g("if (!(unique(%s))) {",t),b("must be unique"),g("}"),"array"!==y&&g("}")),r["enum"]){var k=r["enum"].some(function(t){return"object"==typeof t}),O=k?function(e){return"JSON.stringify("+t+") !== JSON.stringify("+JSON.stringify(e)+")"}:function(e){return t+" !== "+JSON.stringify(e)};g("if (%s) {",r["enum"].map(O).join(" && ")||"false"),b("must be an enum value"),g("}")}if(r.dependencies&&("object"!==y&&g("if (%s) {",types.object(t)),Object.keys(r.dependencies).forEach(function(e){var n=r.dependencies[e];"string"==typeof n&&(n=[n]);var i=function(e){return genobj(t,e)+" !== undefined"};Array.isArray(n)&&(g("if (%s !== undefined && !(%s)) {",genobj(t,e),n.map(i).join(" && ")||"true"),b("dependencies not set"),g("}")),"object"==typeof n&&(g("if (%s !== undefined) {",genobj(t,e)),_(t,n,l,h),g("}"))}),"object"!==y&&g("}")),r.additionalProperties||r.additionalProperties===!1){"object"!==y&&g("if (%s) {",types.object(t));var E=d(),T=u("keys"),A=function(t){return T+"["+E+"] !== "+JSON.stringify(t)},I=function(t){return"!"+p(t)+".test("+T+"["+E+"])"},P=Object.keys(f||{}).map(A).concat(Object.keys(r.patternProperties||{}).map(I)).join(" && ")||"true";g("var %s = Object.keys(%s)",T,t)("for (var %s = 0; %s < %s.length; %s++) {",E,E,T,E)("if (%s) {",P),r.additionalProperties===!1?(h&&g("delete %s",t+"["+T+"["+E+"]]"),b("has additional properties",null,JSON.stringify(t+".")+" + "+T+"["+E+"]")):_(t+"["+T+"["+E+"]]",r.additionalProperties,l,h),g("}")("}"),"object"!==y&&g("}")}if(r.$ref){var R=get(n,i&&i.schemas||{},r.$ref);if(R){var j=e[r.$ref];j||(e[r.$ref]=function(t){return j(t)},j=compile(R,e,n,!1,i));var x=u("ref");s[x]=j,g("if (!(%s(%s))) {",x,t),b("referenced schema does not match"),g("}")}}if(r.not){var N=u("prev");g("var %s = errors",N),_(t,r.not,!1,h),g("if (%s === errors) {",N),b("negative schema matches"),g("} else {")("errors = %s",N)("}")}if(r.items&&!m){"array"!==y&&g("if (%s) {",types.array(t));var E=d();g("for (var %s = 0; %s < %s.length; %s++) {",E,E,t,E),_(t+"["+E+"]",r.items,l,h),g("}"),"array"!==y&&g("}")}if(r.patternProperties){"object"!==y&&g("if (%s) {",types.object(t));var T=u("keys"),E=d();g("var %s = Object.keys(%s)",T,t)("for (var %s = 0; %s < %s.length; %s++) {",E,E,T,E),Object.keys(r.patternProperties).forEach(function(e){var n=p(e);g("if (%s.test(%s)) {",n,T+"["+E+"]"),_(t+"["+T+"["+E+"]]",r.patternProperties[e],l,h),g("}")}),g("}"),"object"!==y&&g("}")}if(r.pattern){var D=p(r.pattern);"string"!==y&&g("if (%s) {",types.string(t)),g("if (!(%s.test(%s))) {",D,t),b("pattern mismatch"),g("}"),"string"!==y&&g("}")}if(r.allOf&&r.allOf.forEach(function(e){_(t,e,l,h)}),r.anyOf&&r.anyOf.length){var N=u("prev");r.anyOf.forEach(function(e,n){0===n?g("var %s = errors",N):g("if (errors !== %s) {",N)("errors = %s",N),_(t,e,!1,!1)}),r.anyOf.forEach(function(t,e){e&&g("}")}),g("if (%s !== errors) {",N),b("no schemas match"),g("}")}if(r.oneOf&&r.oneOf.length){var N=u("prev"),B=u("passes");g("var %s = errors",N)("var %s = 0",B),r.oneOf.forEach(function(e,n){_(t,e,!1,!1),g("if (%s === errors) {",N)("%s++",B)("} else {")("errors = %s",N)("}")}),g("if (%s !== 1) {",B),b("no (or more than one) schemas match"),g("}")}for(void 0!==r.multipleOf&&("number"!==y&&"integer"!==y&&g("if (%s) {",types.number(t)),g("if (!isMultipleOf(%s, %d)) {",t,r.multipleOf),b("has a remainder"),g("}"),"number"!==y&&"integer"!==y&&g("}")),void 0!==r.maxProperties&&("object"!==y&&g("if (%s) {",types.object(t)),g("if (Object.keys(%s).length > %d) {",t,r.maxProperties),b("has more properties than allowed"),g("}"),"object"!==y&&g("}")),void 0!==r.minProperties&&("object"!==y&&g("if (%s) {",types.object(t)),g("if (Object.keys(%s).length < %d) {",t,r.minProperties),b("has less properties than allowed"),g("}"),"object"!==y&&g("}")),void 0!==r.maxItems&&("array"!==y&&g("if (%s) {",types.array(t)),g("if (%s.length > %d) {",t,r.maxItems),b("has more items than allowed"),g("}"),"array"!==y&&g("}")),void 0!==r.minItems&&("array"!==y&&g("if (%s) {",types.array(t)),g("if (%s.length < %d) {",t,r.minItems),b("has less items than allowed"),g("}"),"array"!==y&&g("}")),void 0!==r.maxLength&&("string"!==y&&g("if (%s) {",types.string(t)),g("if (%s.length > %d) {",t,r.maxLength),b("has longer length than allowed"),g("}"),"string"!==y&&g("}")),void 0!==r.minLength&&("string"!==y&&g("if (%s) {",types.string(t)),g("if (%s.length < %d) {",t,r.minLength),b("has less length than allowed"),g("}"),"string"!==y&&g("}")),void 0!==r.minimum&&("number"!==y&&"integer"!==y&&g("if (%s) {",types.number(t)),g("if (%s %s %d) {",t,r.exclusiveMinimum?"<=":"<",r.minimum),b("is less than minimum"),g("}"),"number"!==y&&"integer"!==y&&g("}")),void 0!==r.maximum&&("number"!==y&&"integer"!==y&&g("if (%s) {",types.number(t)),g("if (%s %s %d) {",t,r.exclusiveMaximum?">=":">",r.maximum),b("is more than maximum"),g("}"),"number"!==y&&"integer"!==y&&g("}")),f&&Object.keys(f).forEach(function(e){Array.isArray(y)&&-1!==y.indexOf("null")&&g("if (%s !== null) {",t),_(genobj(t,e),f[e],l,h),Array.isArray(y)&&-1!==y.indexOf("null")&&g("}")});v--;)g("}")},g=genfun("function validate(data) {")("if (data === undefined) data = null")("validate.errors = null")("var errors = 0");return _("data",t,r,i&&i.filter),g("return errors === 0")("}"),g=g.toFunction(s),g.errors=null,Object.defineProperty&&Object.defineProperty(g,"error",{get:function(){return g.errors?g.errors.map(function(t){return t.field+" "+t.message}).join("\n"):""}}),g.toJSON=function(){return t},g};module.exports=function(t,e){return"string"==typeof t&&(t=JSON.parse(t)),compile(t,{},t,!0,e)},module.exports.filter=function(t,e){var n=module.exports(t,xtend(e,{filter:!0}));return function(t){return n(t),t}};