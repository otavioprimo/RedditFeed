function RandomReadStream(e){Stream.call(this),this.readable=!0,this._paused=!1,this._processing=!1,this._hasher=crypto.createHash("sha1"),e=e||{},e.block=e.block||262144,e.total=e.total||268435456,this._remaining=e.total,e.jitter=e.jitter||1024,this._opt=e,this._process=this._process.bind(this),process.nextTick(this._process)}function HashStream(){Stream.call(this),this.readable=this.writable=!0,this._hasher=crypto.createHash("sha1")}var crypto=require("crypto"),stream=require("stream"),Stream=stream.Stream,util=require("util"),tape=require("tape"),zlib=require("../");util.inherits(RandomReadStream,Stream),RandomReadStream.prototype.pause=function(){this._paused=!0,this.emit("pause")},RandomReadStream.prototype.resume=function(){this._paused=!1,this.emit("resume"),this._process()},RandomReadStream.prototype._process=function(){if(!this._processing&&!this._paused){if(this._processing=!0,!this._remaining)return this._hash=this._hasher.digest("hex").toLowerCase().trim(),this._processing=!1,void this.emit("end");var e=this._opt.block,t=this._opt.jitter;t&&(e+=Math.ceil(Math.random()*t-t/2)),e=Math.min(e,this._remaining);for(var r=new Buffer(e),n=0;e>n;n++)r[n]=256*Math.random();this._hasher.update(r),this._remaining-=e,this._processing=!1,this.emit("data",r),process.nextTick(this._process)}},util.inherits(HashStream,Stream),HashStream.prototype.write=function(e){return this._hasher.update(e),process.nextTick(this.resume.bind(this)),!1},HashStream.prototype.resume=function(){this.emit("resume"),process.nextTick(this.emit.bind(this,"drain"))},HashStream.prototype.end=function(e){e&&this.write(e),this._hash=this._hasher.digest("hex").toLowerCase().trim(),this.emit("data",this._hash),this.emit("end")},tape("random byte pipes",function(e){var t=new RandomReadStream({total:1024,block:256,jitter:16}),r=new HashStream,n=zlib.createGzip(),i=zlib.createGunzip();t.pipe(n).pipe(i).pipe(r),t.on("data",function(t){e.ok(t.length)}),n.on("data",function(t){e.ok(t.length)}),i.on("data",function(t){e.ok(t.length)}),r.on("data",function(t){e.ok(t.length)}),r.on("data",function(r){e.ok(r.length),e.equal(r,t._hash,"hashes should match")}),r.on("end",function(){e.end()})});