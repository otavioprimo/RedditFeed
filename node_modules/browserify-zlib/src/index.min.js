function zlibBuffer(e,t,r){function o(){for(var t;null!==(t=e.read());)n.push(t),i+=t.length;e.once("readable",o)}function a(t){e.removeListener("end",s),e.removeListener("readable",o),r(t)}function s(){var t=Buffer.concat(n,i);n=[],r(null,t),e.close()}var n=[],i=0;e.on("error",a),e.on("end",s),e.end(t),o()}function zlibBufferSync(e,t){if("string"==typeof t&&(t=new Buffer(t)),!Buffer.isBuffer(t))throw new TypeError("Not a string or buffer");var r=binding.Z_FINISH;return e._processChunk(t,r)}function Deflate(e){return this instanceof Deflate?void Zlib.call(this,e,binding.DEFLATE):new Deflate(e)}function Inflate(e){return this instanceof Inflate?void Zlib.call(this,e,binding.INFLATE):new Inflate(e)}function Gzip(e){return this instanceof Gzip?void Zlib.call(this,e,binding.GZIP):new Gzip(e)}function Gunzip(e){return this instanceof Gunzip?void Zlib.call(this,e,binding.GUNZIP):new Gunzip(e)}function DeflateRaw(e){return this instanceof DeflateRaw?void Zlib.call(this,e,binding.DEFLATERAW):new DeflateRaw(e)}function InflateRaw(e){return this instanceof InflateRaw?void Zlib.call(this,e,binding.INFLATERAW):new InflateRaw(e)}function Unzip(e){return this instanceof Unzip?void Zlib.call(this,e,binding.UNZIP):new Unzip(e)}function Zlib(e,t){if(this._opts=e=e||{},this._chunkSize=e.chunkSize||exports.Z_DEFAULT_CHUNK,Transform.call(this,e),e.flush&&e.flush!==binding.Z_NO_FLUSH&&e.flush!==binding.Z_PARTIAL_FLUSH&&e.flush!==binding.Z_SYNC_FLUSH&&e.flush!==binding.Z_FULL_FLUSH&&e.flush!==binding.Z_FINISH&&e.flush!==binding.Z_BLOCK)throw new Error("Invalid flush flag: "+e.flush);if(this._flushFlag=e.flush||binding.Z_NO_FLUSH,e.chunkSize&&(e.chunkSize<exports.Z_MIN_CHUNK||e.chunkSize>exports.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<exports.Z_MIN_WINDOWBITS||e.windowBits>exports.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<exports.Z_MIN_LEVEL||e.level>exports.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<exports.Z_MIN_MEMLEVEL||e.memLevel>exports.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=exports.Z_FILTERED&&e.strategy!=exports.Z_HUFFMAN_ONLY&&e.strategy!=exports.Z_RLE&&e.strategy!=exports.Z_FIXED&&e.strategy!=exports.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!Buffer.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._binding=new binding.Zlib(t);var r=this;this._hadError=!1,this._binding.onerror=function(e,t){r._binding=null,r._hadError=!0;var n=new Error(e);n.errno=t,n.code=exports.codes[t],r.emit("error",n)};var n=exports.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(n=e.level);var i=exports.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(i=e.strategy),this._binding.init(e.windowBits||exports.Z_DEFAULT_WINDOWBITS,n,e.memLevel||exports.Z_DEFAULT_MEMLEVEL,i,e.dictionary),this._buffer=new Buffer(this._chunkSize),this._offset=0,this._closed=!1,this._level=n,this._strategy=i,this.once("end",this.close)}var Transform=require("_stream_transform"),binding=require("./binding"),util=require("util"),assert=require("assert").ok;binding.Z_MIN_WINDOWBITS=8,binding.Z_MAX_WINDOWBITS=15,binding.Z_DEFAULT_WINDOWBITS=15,binding.Z_MIN_CHUNK=64,binding.Z_MAX_CHUNK=1/0,binding.Z_DEFAULT_CHUNK=16384,binding.Z_MIN_MEMLEVEL=1,binding.Z_MAX_MEMLEVEL=9,binding.Z_DEFAULT_MEMLEVEL=8,binding.Z_MIN_LEVEL=-1,binding.Z_MAX_LEVEL=9,binding.Z_DEFAULT_LEVEL=binding.Z_DEFAULT_COMPRESSION,Object.keys(binding).forEach(function(e){e.match(/^Z/)&&(exports[e]=binding[e])}),exports.codes={Z_OK:binding.Z_OK,Z_STREAM_END:binding.Z_STREAM_END,Z_NEED_DICT:binding.Z_NEED_DICT,Z_ERRNO:binding.Z_ERRNO,Z_STREAM_ERROR:binding.Z_STREAM_ERROR,Z_DATA_ERROR:binding.Z_DATA_ERROR,Z_MEM_ERROR:binding.Z_MEM_ERROR,Z_BUF_ERROR:binding.Z_BUF_ERROR,Z_VERSION_ERROR:binding.Z_VERSION_ERROR},Object.keys(exports.codes).forEach(function(e){exports.codes[exports.codes[e]]=e}),exports.Deflate=Deflate,exports.Inflate=Inflate,exports.Gzip=Gzip,exports.Gunzip=Gunzip,exports.DeflateRaw=DeflateRaw,exports.InflateRaw=InflateRaw,exports.Unzip=Unzip,exports.createDeflate=function(e){return new Deflate(e)},exports.createInflate=function(e){return new Inflate(e)},exports.createDeflateRaw=function(e){return new DeflateRaw(e)},exports.createInflateRaw=function(e){return new InflateRaw(e)},exports.createGzip=function(e){return new Gzip(e)},exports.createGunzip=function(e){return new Gunzip(e)},exports.createUnzip=function(e){return new Unzip(e)},exports.deflate=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new Deflate(t),e,r)},exports.deflateSync=function(e,t){return zlibBufferSync(new Deflate(t),e)},exports.gzip=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new Gzip(t),e,r)},exports.gzipSync=function(e,t){return zlibBufferSync(new Gzip(t),e)},exports.deflateRaw=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new DeflateRaw(t),e,r)},exports.deflateRawSync=function(e,t){return zlibBufferSync(new DeflateRaw(t),e)},exports.unzip=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new Unzip(t),e,r)},exports.unzipSync=function(e,t){return zlibBufferSync(new Unzip(t),e)},exports.inflate=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new Inflate(t),e,r)},exports.inflateSync=function(e,t){return zlibBufferSync(new Inflate(t),e)},exports.gunzip=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new Gunzip(t),e,r)},exports.gunzipSync=function(e,t){return zlibBufferSync(new Gunzip(t),e)},exports.inflateRaw=function(e,t,r){return"function"==typeof t&&(r=t,t={}),zlibBuffer(new InflateRaw(t),e,r)},exports.inflateRawSync=function(e,t){return zlibBufferSync(new InflateRaw(t),e)},util.inherits(Zlib,Transform),Zlib.prototype.params=function(e,t,r){if(e<exports.Z_MIN_LEVEL||e>exports.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(t!=exports.Z_FILTERED&&t!=exports.Z_HUFFMAN_ONLY&&t!=exports.Z_RLE&&t!=exports.Z_FIXED&&t!=exports.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+t);if(this._level!==e||this._strategy!==t){var n=this;this.flush(binding.Z_SYNC_FLUSH,function(){n._binding.params(e,t),n._hadError||(n._level=e,n._strategy=t,r&&r())})}else process.nextTick(r)},Zlib.prototype.reset=function(){return this._binding.reset()},Zlib.prototype._flush=function(e){this._transform(new Buffer(0),"",e)},Zlib.prototype.flush=function(e,t){var r=this._writableState;if(("function"==typeof e||void 0===e&&!t)&&(t=e,e=binding.Z_FULL_FLUSH),r.ended)t&&process.nextTick(t);else if(r.ending)t&&this.once("end",t);else if(r.needDrain){var n=this;this.once("drain",function(){n.flush(t)})}else this._flushFlag=e,this.write(new Buffer(0),"",t)},Zlib.prototype.close=function(e){if(e&&process.nextTick(e),!this._closed){this._closed=!0,this._binding.close();var t=this;process.nextTick(function(){t.emit("close")})}},Zlib.prototype._transform=function(e,t,r){var n,i=this._writableState,o=i.ending||i.ended,a=o&&(!e||i.length===e.length);if(null===!e&&!Buffer.isBuffer(e))return r(new Error("invalid input"));a?n=binding.Z_FINISH:(n=this._flushFlag,e.length>=i.length&&(this._flushFlag=this._opts.flush||binding.Z_NO_FLUSH));this._processChunk(e,n,r)},Zlib.prototype._processChunk=function(e,t,r){function d(c,f){if(!a._hadError){var p=i-f;if(assert(p>=0,"have should not go down"),p>0){var h=a._buffer.slice(a._offset,a._offset+p);a._offset+=p,s?a.push(h):(u.push(h),l+=h.length)}if((0===f||a._offset>=a._chunkSize)&&(i=a._chunkSize,a._offset=0,a._buffer=new Buffer(a._chunkSize)),0===f){if(o+=n-c,n=c,!s)return!0;var v=a._binding.write(t,e,o,n,a._buffer,a._offset,a._chunkSize);return v.callback=d,void(v.buffer=e)}return s?void r():!1}}var n=e&&e.length,i=this._chunkSize-this._offset,o=0,a=this,s="function"==typeof r;if(!s){var c,u=[],l=0;this.on("error",function(e){c=e});do var f=this._binding.writeSync(t,e,o,n,this._buffer,this._offset,i);while(!this._hadError&&d(f[0],f[1]));if(this._hadError)throw c;var p=Buffer.concat(u,l);return this.close(),p}var h=this._binding.write(t,e,o,n,this._buffer,this._offset,i);h.buffer=e,h.callback=d},util.inherits(Deflate,Zlib),util.inherits(Inflate,Zlib),util.inherits(Gzip,Zlib),util.inherits(Gunzip,Zlib),util.inherits(DeflateRaw,Zlib),util.inherits(InflateRaw,Zlib),util.inherits(Unzip,Zlib);