"use strict";function loadBeautify(){if(void 0===beautify)try{beautify=require("js-beautify").js_beautify}catch(e){beautify=!1}}function compile(e,t,r,n){function b(){var e=v.validate,t=e.apply(null,arguments);return b.errors=e.errors,t}function w(e,r,n,c){var p=!r||r&&r.schema==e;if(r.schema!=t.schema)return compile.call(i,e,r,n,c);var d=e.$async===!0;d&&!o.transpile&&async.setup(o);var v=validateGenerator({isTop:!0,schema:e,isRoot:p,baseId:c,root:r,schemaPath:"",errSchemaPath:"#",errorPath:'""',RULES:g,validate:validateGenerator,util:util,resolve:resolve,resolveRef:x,usePattern:A,useDefault:k,useCustomRule:T,opts:o,formats:m,self:i});v=vars(s,refValCode)+vars(u,patternCode)+vars(l,defaultCode)+vars(f,customRuleCode)+v+"return validate;",o.beautify&&(loadBeautify(),beautify?v=beautify(v,o.beautify):console.error('"npm install js-beautify" to use beautify option'));var y,_,b=o._transpileFunc;try{_=d&&b?b(v):v;var w=new Function("self","RULES","formats","root","refVal","defaults","customRules","co","equal","ucs2length","ValidationError",_);y=w(i,g,m,t,s,l,f,co,equal,ucs2length,ValidationError),s[0]=y}catch(E){throw console.error("Error compiling schema, function code:",_),E}return y.schema=e,y.errors=null,y.refs=a,y.refVal=s,y.root=p?y:r,d&&(y.$async=!0),h&&(y.sourceCode=v),o.sourceCode===!0&&(y.source={patterns:u,defaults:l}),y}function x(e,n,u){n=resolve.url(e,n);var l,p,c=a[n];if(void 0!==c)return l=s[c],p="refVal["+c+"]",S(l,p);if(!u&&t.refs){var f=t.refs[n];if(void 0!==f)return l=t.refVal[f],p=E(n,l),S(l,p)}p=E(n);var h=resolve.call(i,w,t,n);if(!h){var d=r&&r[n];d&&(h=resolve.inlineRef(d,o.inlineRefs)?d:compile.call(i,d,t,r,e))}return h?(C(n,h),S(h,p)):void 0}function E(e,t){var r=s.length;return s[r]=t,a[e]=r,"refVal"+r}function C(e,t){var r=a[e];s[r]=t}function S(e,t){return"object"==typeof e?{code:t,schema:e,inline:!0}:{code:t,$async:e&&e.$async}}function A(e){var t=c[e];return void 0===t&&(t=c[e]=u.length,u[t]=e),"pattern"+t}function k(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return util.toQuotedString(e);case"object":if(null===e)return"null";var t=stableStringify(e),r=p[t];return void 0===r&&(r=p[t]=l.length,l[r]=e),"default"+r}}function T(e,t,r,n){var s=e.definition.validateSchema;if(s&&i._opts.validateSchema!==!1){var a=s(t);if(!a){var u="keyword schema is invalid: "+i.errorsText(s.errors);if("log"!=i._opts.validateSchema)throw new Error(u);console.error(u)}}var h,c=e.definition.compile,l=e.definition.inline,p=e.definition.macro;c?h=c.call(i,t,r,n):p?(h=p.call(i,t,r,n),o.validateSchema!==!1&&i.validateSchema(h,!0)):h=l?l.call(i,n,e.keyword,t,r):e.definition.validate;var d=f.length;return f[d]=h,{code:"customRule"+d,validate:h}}var i=this,o=this._opts,s=[void 0],a={},u=[],c={},l=[],p={},f=[],h=o.sourceCode!==!1;t=t||{schema:e,refVal:s,refs:a};var d=checkCompiling.call(this,e,t,n),v=this._compilations[d.index];if(d.compiling)return v.callValidate=b;var m=this._formats,g=this.RULES;try{var y=w(e,t,r,n);v.validate=y;var _=v.callValidate;return _&&(_.schema=y.schema,_.errors=null,_.refs=y.refs,_.refVal=y.refVal,_.root=y.root,_.$async=y.$async,h&&(_.sourceCode=y.sourceCode)),y}finally{endCompiling.call(this,e,t,n)}}function checkCompiling(e,t,r){var n=compIndex.call(this,e,t,r);return n>=0?{index:n,compiling:!0}:(n=this._compilations.length,this._compilations[n]={schema:e,root:t,baseId:r},{index:n,compiling:!1})}function endCompiling(e,t,r){var n=compIndex.call(this,e,t,r);n>=0&&this._compilations.splice(n,1)}function compIndex(e,t,r){for(var n=0;n<this._compilations.length;n++){var i=this._compilations[n];if(i.schema==e&&i.root==t&&i.baseId==r)return n}return-1}function patternCode(e,t){return"var pattern"+e+" = new RegExp("+util.toQuotedString(t[e])+");"}function defaultCode(e){return"var default"+e+" = defaults["+e+"];"}function refValCode(e,t){return t[e]?"var refVal"+e+" = refVal["+e+"];":""}function customRuleCode(e){return"var customRule"+e+" = customRules["+e+"];"}function vars(e,t){if(!e.length)return"";for(var r="",n=0;n<e.length;n++)r+=t(n,e);return r}var resolve=require("./resolve"),util=require("./util"),stableStringify=require("json-stable-stringify"),async=require("../async"),beautify,validateGenerator=require("../dotjs/validate"),co=require("co"),ucs2length=util.ucs2length,equal=require("./equal"),ValidationError=require("./validation_error");module.exports=compile;