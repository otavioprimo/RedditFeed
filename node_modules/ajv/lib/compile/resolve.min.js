"use strict";function resolve(e,t,r){var n=this._refs[r];if("string"==typeof n){if(!this._refs[n])return resolve.call(this,e,t,n);n=this._refs[n]}if(n=n||this._schemas[r],n instanceof SchemaObject)return inlineRef(n.schema,this._opts.inlineRefs)?n.schema:n.validate||this._compile(n);var o,s,a,i=resolveSchema.call(this,t,r);return i&&(o=i.schema,t=i.root,a=i.baseId),o instanceof SchemaObject?s=o.validate||e.call(this,o.schema,t,void 0,a):o&&(s=inlineRef(o,this._opts.inlineRefs)?o:e.call(this,o,t,void 0,a)),s}function resolveSchema(e,t){var r=url.parse(t,!1,!0),n=_getFullPath(r),i=getFullPath(e.schema.id);if(n!==i){var o=normalizeId(n),s=this._refs[o];if("string"==typeof s)return resolveRecursive.call(this,e,s,r);if(s instanceof SchemaObject)s.validate||this._compile(s),e=s;else{if(s=this._schemas[o],!(s instanceof SchemaObject))return;if(s.validate||this._compile(s),o==normalizeId(t))return{schema:s,root:e,baseId:i};e=s}if(!e.schema)return;i=getFullPath(e.schema.id)}return getJsonPointer.call(this,r,i,e.schema,e)}function resolveRecursive(e,t,r){var n=resolveSchema.call(this,e,t);if(n){var i=n.schema,o=n.baseId;return e=n.root,i.id&&(o=resolveUrl(o,i.id)),getJsonPointer.call(this,r,o,i,e)}}function getJsonPointer(e,t,r,n){if(e.hash=e.hash||"","#/"==e.hash.slice(0,2)){for(var i=e.hash.split("/"),o=1;o<i.length;o++){var s=i[o];if(s){if(s=util.unescapeFragment(s),r=r[s],!r)break;if(r.id&&!PREVENT_SCOPE_CHANGE[s]&&(t=resolveUrl(t,r.id)),r.$ref){var a=resolveUrl(t,r.$ref),u=resolveSchema.call(this,n,a);u&&(r=u.schema,n=u.root,t=u.baseId)}}}return r&&r!=n.schema?{schema:r,root:n,baseId:t}:void 0}}function inlineRef(e,t){return t===!1?!1:void 0===t||t===!0?checkNoRef(e):t?countKeys(e)<=t:void 0}function checkNoRef(e){var t;if(Array.isArray(e)){for(var r=0;r<e.length;r++)if(t=e[r],"object"==typeof t&&!checkNoRef(t))return!1}else for(var n in e){if("$ref"==n)return!1;if(t=e[n],"object"==typeof t&&!checkNoRef(t))return!1}return!0}function countKeys(e){var r,t=0;if(Array.isArray(e)){for(var n=0;n<e.length;n++)if(r=e[n],"object"==typeof r&&(t+=countKeys(r)),t==1/0)return 1/0}else for(var i in e){if("$ref"==i)return 1/0;if(SIMPLE_INLINED[i])t++;else if(r=e[i],"object"==typeof r&&(t+=countKeys(r)+1),t==1/0)return 1/0}return t}function getFullPath(e,t){t!==!1&&(e=normalizeId(e));var r=url.parse(e,!1,!0);return _getFullPath(r)}function _getFullPath(e){var t=e.protocol||"//"==e.href.slice(0,2)?"//":"";return(e.protocol||"")+t+(e.host||"")+(e.path||"")+"#"}function normalizeId(e){return e?e.replace(TRAILING_SLASH_HASH,""):""}function resolveUrl(e,t){return t=normalizeId(t),url.resolve(e,t)}function resolveIds(e){function n(e,t,i){if(Array.isArray(e))for(var o=0;o<e.length;o++)n.call(this,e[o],t+"/"+o,i);else if(e&&"object"==typeof e){if("string"==typeof e.id){var s=i=i?url.resolve(i,e.id):e.id;s=normalizeId(s);var a=this._refs[s];if("string"==typeof a&&(a=this._refs[a]),a&&a.schema){if(!equal(e,a.schema))throw new Error('id "'+s+'" resolves to more than one schema')}else if(s!=normalizeId(t))if("#"==s[0]){if(r[s]&&!equal(e,r[s]))throw new Error('id "'+s+'" resolves to more than one schema');r[s]=e}else this._refs[s]=t}for(var u in e)n.call(this,e[u],t+"/"+util.escapeFragment(u),i)}}var t=normalizeId(e.id),r={};return n.call(this,e,getFullPath(t,!1),t),r}var url=require("url"),equal=require("./equal"),util=require("./util"),SchemaObject=require("./schema_obj");module.exports=resolve,resolve.normalizeId=normalizeId,resolve.fullPath=getFullPath,resolve.url=resolveUrl,resolve.ids=resolveIds,resolve.inlineRef=inlineRef,resolve.schema=resolveSchema;var PREVENT_SCOPE_CHANGE=util.toHash(["properties","patternProperties","enum","dependencies","definitions"]),SIMPLE_INLINED=util.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]),TRAILING_SLASH_HASH=/#\/?$/;