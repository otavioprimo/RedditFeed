"use strict";function SCHEMA_URI_FORMAT_FUNC(e){return SCHEMA_URI_FORMAT.test(e)}function Ajv(e){function r(e,r){var n;if("string"==typeof e){if(n=u(e),!n)throw new Error('no schema with key or ref "'+e+'"')}else{var i=h(e);n=i.validate||d(i)}var o=n(r);return n.$async===!0?"*"==t._opts.async?co(o):o:(t.errors=n.errors,o)}function n(e,t){var r=h(e,void 0,t);return r.validate||d(r)}function i(e,r,n,o){if(Array.isArray(e))for(var s=0;s<e.length;s++)i(e[s],void 0,n,o);else r=resolve.normalizeId(r||e.id),b(r),t._schemas[r]=h(e,n,o,!0)}function o(e,t,r){i(e,t,r,!0)}function s(e,n){var i=e.$schema||t._opts.defaultMeta||a(),o=t._formats.uri;t._formats.uri="function"==typeof o?SCHEMA_URI_FORMAT_FUNC:SCHEMA_URI_FORMAT;var s;try{s=r(i,e)}finally{t._formats.uri=o}if(!s&&n){var u="schema is invalid: "+v();if("log"!=t._opts.validateSchema)throw new Error(u);console.error(u)}return s}function a(){var e=t._opts.meta;return t._opts.defaultMeta="object"==typeof e?e.id||e:t._opts.v5?v5.META_SCHEMA_ID:META_SCHEMA_ID,t._opts.defaultMeta}function u(e){var t=c(e);switch(typeof t){case"object":return t.validate||d(t);case"string":return u(t);case"undefined":return l(e)}}function l(e){var r=resolve.schema.call(t,{schema:{}},e);if(r){var n=r.schema,i=r.root,o=r.baseId,s=compileSchema.call(t,n,i,void 0,o);return t._fragments[e]=new SchemaObject({ref:e,fragment:!0,schema:n,root:i,baseId:o,validate:s}),s}}function c(e){return e=resolve.normalizeId(e),t._schemas[e]||t._refs[e]||t._fragments[e]}function p(e){if(e instanceof RegExp)return f(t._schemas,e),void f(t._refs,e);switch(typeof e){case"undefined":return f(t._schemas),f(t._refs),void t._cache.clear();case"string":var r=c(e);return r&&t._cache.del(r.jsonStr),delete t._schemas[e],void delete t._refs[e];case"object":var n=stableStringify(e);t._cache.del(n);var i=e.id;i&&(i=resolve.normalizeId(i),delete t._schemas[i],delete t._refs[i])}}function f(e,r){for(var n in e){var i=e[n];i.meta||r&&!r.test(n)||(t._cache.del(i.jsonStr),delete e[n])}}function h(e,r,n,i){if("object"!=typeof e)throw new Error("schema should be object");var o=stableStringify(e),a=t._cache.get(o);if(a)return a;i=i||t._opts.addUsedSchema!==!1;var u=resolve.normalizeId(e.id);u&&i&&b(u);var c,l=t._opts.validateSchema!==!1&&!r;l&&!(c=e.id&&e.id==e.$schema)&&s(e,!0);var p=resolve.ids.call(t,e),f=new SchemaObject({id:u,schema:e,localRefs:p,jsonStr:o,meta:n});return"#"!=u[0]&&i&&(t._refs[u]=f),t._cache.put(o,f),l&&c&&s(e,!0),f}function d(e,r){function o(){var t=e.validate,r=t.apply(null,arguments);return o.errors=t.errors,r}if(e.compiling)return e.validate=o,o.schema=e.schema,o.errors=null,o.root=r?r:o,e.schema.$async===!0&&(o.$async=!0),o;e.compiling=!0;var n;e.meta&&(n=t._opts,t._opts=t._metaOpts);var i;try{i=compileSchema.call(t,e.schema,r,e.localRefs)}finally{e.compiling=!1,e.meta&&(t._opts=n)}return e.validate=i,e.refs=i.refs,e.refVal=i.refVal,e.root=i.root,i}function v(e,r){if(e=e||t.errors,!e)return"No errors";r=r||{};for(var n=void 0===r.separator?", ":r.separator,i=void 0===r.dataVar?"data":r.dataVar,o="",s=0;s<e.length;s++){var a=e[s];a&&(o+=i+a.dataPath+" "+a.message+n)}return o.slice(0,-n.length)}function m(e,r){"string"==typeof r&&(r=new RegExp(r)),t._formats[e]=r}function g(){if(t._opts.meta!==!1){var e=require("./refs/json-schema-draft-04.json");o(e,META_SCHEMA_ID,!0),t._refs["http://json-schema.org/schema"]=META_SCHEMA_ID}}function y(){var e=t._opts.schemas;if(e)if(Array.isArray(e))i(e);else for(var r in e)i(e[r],r)}function _(){for(var e in t._opts.formats){var r=t._opts.formats[e];m(e,r)}}function b(e){if(t._schemas[e]||t._refs[e])throw new Error('schema with key or id "'+e+'" already exists')}function w(){for(var e=util.copy(t._opts),r=0;r<META_IGNORE_OPTIONS.length;r++)delete e[META_IGNORE_OPTIONS[r]];return e}if(!(this instanceof Ajv))return new Ajv(e);var t=this;e=this._opts=util.copy(e)||{},this._schemas={},this._refs={},this._fragments={},this._formats=formats(e.format),this._cache=e.cache||new Cache,this._loadingSchemas={},this._compilations=[],this.RULES=rules(),this.validate=r,this.compile=n,this.addSchema=i,this.addMetaSchema=o,this.validateSchema=s,this.getSchema=u,this.removeSchema=p,this.addFormat=m,this.errorsText=v,this._addSchema=h,this._compile=d,e.loopRequired=e.loopRequired||1/0,(e.async||e.transpile)&&async.setup(e),e.beautify===!0&&(e.beautify={indent_size:2}),"property"==e.errorDataPath&&(e._errorDataPathProperty=!0),this._metaOpts=w(),e.formats&&_(),g(),e.v5&&v5.enable(this),"object"==typeof e.meta&&o(e.meta),y()}var compileSchema=require("./compile"),resolve=require("./compile/resolve"),Cache=require("./cache"),SchemaObject=require("./compile/schema_obj"),stableStringify=require("json-stable-stringify"),formats=require("./compile/formats"),rules=require("./compile/rules"),v5=require("./v5"),util=require("./compile/util"),async=require("./async"),co=require("co");module.exports=Ajv,Ajv.prototype.compileAsync=async.compile,Ajv.prototype.addKeyword=require("./keyword"),Ajv.ValidationError=require("./compile/validation_error");var META_SCHEMA_ID="http://json-schema.org/draft-04/schema",SCHEMA_URI_FORMAT=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/\/)?[^\s]*$/i,META_IGNORE_OPTIONS=["removeAdditional","useDefaults","coerceTypes"];