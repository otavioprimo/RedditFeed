"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function calcLineCount(e){var t=!1;e.oldLines=0,e.newLines=0,e.lines.forEach(function(r){return"string"!=typeof r?void(t=!0):(("+"===r[0]||" "===r[0])&&e.newLines++,void(("-"===r[0]||" "===r[0])&&e.oldLines++))}),t&&(delete e.oldLines,delete e.newLines)}function merge(e,t,r){e=loadPatch(e,r),t=loadPatch(t,r);var n={};(e.index||t.index)&&(n.index=e.index||t.index),(e.newFileName||t.newFileName)&&(fileNameChanged(e)?fileNameChanged(t)?(n.oldFileName=selectField(n,e.oldFileName,t.oldFileName),n.newFileName=selectField(n,e.newFileName,t.newFileName),n.oldHeader=selectField(n,e.oldHeader,t.oldHeader),n.newHeader=selectField(n,e.newHeader,t.newHeader)):(n.oldFileName=e.oldFileName,n.newFileName=e.newFileName,n.oldHeader=e.oldHeader,n.newHeader=e.newHeader):(n.oldFileName=t.oldFileName||e.oldFileName,n.newFileName=t.newFileName||e.newFileName,n.oldHeader=t.oldHeader||e.oldHeader,n.newHeader=t.newHeader||e.newHeader)),n.hunks=[];for(var i=0,a=0,o=0,s=0;i<e.hunks.length||a<t.hunks.length;){var u=e.hunks[i]||{oldStart:1/0},l=t.hunks[a]||{oldStart:1/0};if(hunkBefore(u,l))n.hunks.push(cloneHunk(u,o)),i++,s+=u.newLines-u.oldLines;else if(hunkBefore(l,u))n.hunks.push(cloneHunk(l,s)),a++,o+=l.newLines-l.oldLines;else{var c={oldStart:Math.min(u.oldStart,l.oldStart),oldLines:0,newStart:Math.min(u.newStart+o,l.oldStart+s),newLines:0,lines:[]};mergeLines(c,u.oldStart,u.lines,l.oldStart,l.lines),a++,i++,n.hunks.push(c)}}return n}function loadPatch(e,t){if("string"==typeof e){if(/^@@/m.test(e)||/^Index:/m.test(e))return _parse.parsePatch(e)[0];if(!t)throw new Error("Must provide a base reference or pass in a patch");return _create.structuredPatch(void 0,void 0,t,e)}return e}function fileNameChanged(e){return e.newFileName&&e.newFileName!==e.oldFileName}function selectField(e,t,r){return t===r?t:(e.conflict=!0,{mine:t,theirs:r})}function hunkBefore(e,t){return e.oldStart<t.oldStart&&e.oldStart+e.oldLines<t.oldStart}function cloneHunk(e,t){return{oldStart:e.oldStart,oldLines:e.oldLines,newStart:e.newStart+t,newLines:e.newLines,lines:e.lines}}function mergeLines(e,t,r,n,i){var a={offset:t,lines:r,index:0},o={offset:n,lines:i,index:0};for(insertLeading(e,a,o),insertLeading(e,o,a);a.index<a.lines.length&&o.index<o.lines.length;){var s=a.lines[a.index],u=o.lines[o.index];if("-"!==s[0]&&"+"!==s[0]||"-"!==u[0]&&"+"!==u[0])if("+"===s[0]&&" "===u[0]){var l;(l=e.lines).push.apply(l,_toConsumableArray(collectChange(a)))}else if("+"===u[0]&&" "===s[0]){var c;(c=e.lines).push.apply(c,_toConsumableArray(collectChange(o)))}else"-"===s[0]&&" "===u[0]?removal(e,a,o):"-"===u[0]&&" "===s[0]?removal(e,o,a,!0):s===u?(e.lines.push(s),a.index++,o.index++):conflict(e,collectChange(a),collectChange(o));else mutualChange(e,a,o)}insertTrailing(e,a),insertTrailing(e,o),calcLineCount(e)}function mutualChange(e,t,r){var n=collectChange(t),i=collectChange(r);if(allRemoves(n)&&allRemoves(i)){if(_array.arrayStartsWith(n,i)&&skipRemoveSuperset(r,n,n.length-i.length)){var a;return void(a=e.lines).push.apply(a,_toConsumableArray(n))}if(_array.arrayStartsWith(i,n)&&skipRemoveSuperset(t,i,i.length-n.length)){var o;return void(o=e.lines).push.apply(o,_toConsumableArray(i))}}else if(_array.arrayEqual(n,i)){var s;return void(s=e.lines).push.apply(s,_toConsumableArray(n))}conflict(e,n,i)}function removal(e,t,r,n){var i=collectChange(t),a=collectContext(r,i);if(a.merged){var o;(o=e.lines).push.apply(o,_toConsumableArray(a.merged))}else conflict(e,n?a:i,n?i:a)}function conflict(e,t,r){e.conflict=!0,e.lines.push({conflict:!0,mine:t,theirs:r})}function insertLeading(e,t,r){for(;t.offset<r.offset&&t.index<t.lines.length;){var n=t.lines[t.index++];e.lines.push(n),t.offset++}}function insertTrailing(e,t){for(;t.index<t.lines.length;){var r=t.lines[t.index++];e.lines.push(r)}}function collectChange(e){for(var t=[],r=e.lines[e.index][0];e.index<e.lines.length;){var n=e.lines[e.index];if("-"===r&&"+"===n[0]&&(r="+"),r!==n[0])break;t.push(n),e.index++}return t}function collectContext(e,t){for(var r=[],n=[],i=0,a=!1,o=!1;i<t.length&&e.index<e.lines.length;){var s=e.lines[e.index],u=t[i];if("+"===u[0])break;if(a=a||" "!==s[0],n.push(u),i++,"+"===s[0])for(o=!0;"+"===s[0];)r.push(s),s=e.lines[++e.index];u.substr(1)===s.substr(1)?(r.push(s),e.index++):o=!0}if("+"===(t[i]||"")[0]&&a&&(o=!0),o)return r;for(;i<t.length;)n.push(t[i++]);return{merged:n,changes:r}}function allRemoves(e){return e.reduce(function(e,t){return e&&"-"===t[0]},!0)}function skipRemoveSuperset(e,t,r){for(var n=0;r>n;n++){var i=t[t.length-r+n].substr(1);if(e.lines[e.index+n]!==" "+i)return!1}return e.index+=r,!0}exports.__esModule=!0,exports.calcLineCount=calcLineCount,exports.merge=merge;var _create=require("./create"),_parse=require("./parse"),_array=require("../util/array");