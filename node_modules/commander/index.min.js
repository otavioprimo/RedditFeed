function Option(t,e){this.flags=t,this.required=~t.indexOf("<"),this.optional=~t.indexOf("["),this.bool=!~t.indexOf("-no-"),t=t.split(/[ ,|]+/),t.length>1&&!/^[[<]/.test(t[1])&&(this["short"]=t.shift()),this["long"]=t.shift(),this.description=e||""}function Command(t){this.commands=[],this.options=[],this._execs=[],this._allowUnknownOption=!1,this._args=[],this._name=t}function camelcase(t){return t.split("-").reduce(function(t,e){return t+e[0].toUpperCase()+e.slice(1)})}function pad(t,e){var n=Math.max(0,e-t.length);return t+Array(n+1).join(" ")}function outputHelpIfNecessary(t,e){e=e||[];for(var n=0;n<e.length;n++)("--help"==e[n]||"-h"==e[n])&&(t.outputHelp(),process.exit(0))}function humanReadableArgName(t){var e=t.name+(t.variadic===!0?"...":"");return t.required?"<"+e+">":"["+e+"]"}function exists(t){try{if(fs.statSync(t).isFile())return!0}catch(e){return!1}}var EventEmitter=require("events").EventEmitter,spawn=require("child_process").spawn,readlink=require("graceful-readlink").readlinkSync,path=require("path"),dirname=path.dirname,basename=path.basename,fs=require("fs");exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this["long"].replace("--","").replace("no-","")},Option.prototype.is=function(t){return t==this["short"]||t==this["long"]},Command.prototype.__proto__=EventEmitter.prototype,Command.prototype.command=function(t,e,n){n=n||{};var r=t.split(/ +/),i=new Command(r.shift());return e&&(i.description(e),this.executables=!0,this._execs[i._name]=!0),i._noHelp=!!n.noHelp,this.commands.push(i),i.parseExpectedArgs(r),i.parent=this,e?this:i},Command.prototype.arguments=function(t){return this.parseExpectedArgs(t.split(/ +/))},Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},Command.prototype.parseExpectedArgs=function(t){if(t.length){var e=this;return t.forEach(function(t){var n={required:!1,name:"",variadic:!1};switch(t[0]){case"<":n.required=!0,n.name=t.slice(1,-1);break;case"[":n.name=t.slice(1,-1)}n.name.length>3&&"..."===n.name.slice(-3)&&(n.variadic=!0,n.name=n.name.slice(0,-3)),n.name&&e._args.push(n)}),this}},Command.prototype.action=function(t){var e=this,n=function(n,r){n=n||[],r=r||[];var i=e.parseOptions(r);outputHelpIfNecessary(e,i.unknown),i.unknown.length>0&&e.unknownOption(i.unknown[0]),i.args.length&&(n=i.args.concat(n)),e._args.forEach(function(t,r){t.required&&null==n[r]?e.missingArgument(t.name):t.variadic&&(r!==e._args.length-1&&e.variadicArgNotLast(t.name),n[r]=n.splice(r))}),e._args.length?n[e._args.length]=e:n.push(e),t.apply(e,n)},r=this.parent||this,i=r===this?"*":this._name;return r.on(i,n),this._alias&&r.on(this._alias,n),this},Command.prototype.option=function(t,e,n,r){var i=this,o=new Option(t,e),s=o.name(),a=camelcase(s);if("function"!=typeof n)if(n instanceof RegExp){var c=n;n=function(t,e){var n=c.exec(t);return n?n[0]:e}}else r=n,n=null;return(0==o.bool||o.optional||o.required)&&(0==o.bool&&(r=!0),void 0!==r&&(i[a]=r)),this.options.push(o),this.on(s,function(t){null!==t&&n&&(t=n(t,void 0===i[a]?r:i[a])),"boolean"==typeof i[a]||"undefined"==typeof i[a]?null==t?i[a]=o.bool?r||!0:!1:i[a]=t:null!==t&&(i[a]=t)}),this},Command.prototype.allowUnknownOption=function(t){return this._allowUnknownOption=0===arguments.length||t,this},Command.prototype.parse=function(t){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=t,this._name=this._name||basename(t[1],".js"),this.executables&&t.length<3&&t.push("--help");var e=this.parseOptions(this.normalize(t.slice(2))),n=this.args=e.args,r=this.parseArgs(this.args,e.unknown),i=r.args[0];return this._execs[i]&&"function"!=typeof this._execs[i]?this.executeSubCommand(t,n,e.unknown):r},Command.prototype.executeSubCommand=function(t,e,n){e=e.concat(n),e.length||this.help(),"help"==e[0]&&1==e.length&&this.help(),"help"==e[0]&&(e[0]=e[1],e[1]="--help");var o,r=t[1],i=basename(r,".js")+"-"+e[0],s=readlink(r);s!==r&&"/"!==s.charAt(0)&&(s=path.join(dirname(r),s)),o=dirname(s);var a=path.join(o,i),c=!1;exists(a+".js")?(i=a+".js",c=!0):exists(a)&&(i=a),e=e.slice(1);var l;"win32"!==process.platform?c?(e.unshift(a),e=(process.execArgv||[]).concat(e),l=spawn("node",e,{stdio:"inherit",customFds:[0,1,2]})):l=spawn(i,e,{stdio:"inherit",customFds:[0,1,2]}):(e.unshift(a),l=spawn(process.execPath,e,{stdio:"inherit"})),l.on("close",process.exit.bind(process)),l.on("error",function(t){"ENOENT"==t.code?console.error("\n  %s(1) does not exist, try --help\n",i):"EACCES"==t.code&&console.error("\n  %s(1) not executable. try chmod or run with root\n",i),process.exit(1)}),this.runningCommand=l},Command.prototype.normalize=function(t){for(var n,r,i,e=[],o=0,s=t.length;s>o;++o){if(n=t[o],o>0&&(r=this.optionFor(t[o-1])),"--"===n){e=e.concat(t.slice(o));break}r&&r.required?e.push(n):n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(t){e.push("-"+t)}):/^--/.test(n)&&~(i=n.indexOf("="))?e.push(n.slice(0,i),n.slice(i+1)):e.push(n)}return e},Command.prototype.parseArgs=function(t,e){var n;return t.length?(n=t[0],this.listeners(n).length?this.emit(t.shift(),t,e):this.emit("*",t)):(outputHelpIfNecessary(this,e),e.length>0&&this.unknownOption(e[0])),this},Command.prototype.optionFor=function(t){for(var e=0,n=this.options.length;n>e;++e)if(this.options[e].is(t))return this.options[e]},Command.prototype.parseOptions=function(t){for(var r,i,o,e=[],n=t.length,s=[],a=0;n>a;++a)if(o=t[a],"--"!=o)if(r)e.push(o);else if(i=this.optionFor(o))if(i.required){if(o=t[++a],null==o)return this.optionMissingArgument(i);this.emit(i.name(),o)}else i.optional?(o=t[a+1],null==o||"-"==o[0]&&"-"!=o?o=null:++a,this.emit(i.name(),o)):this.emit(i.name());else o.length>1&&"-"==o[0]?(s.push(o),t[a+1]&&"-"!=t[a+1][0]&&s.push(t[++a])):e.push(o);else r=!0;return{args:e,unknown:s}},Command.prototype.opts=function(){for(var t={},e=this.options.length,n=0;e>n;n++){var r=camelcase(this.options[n].name());t[r]="version"===r?this._version:this[r]}return t},Command.prototype.missingArgument=function(t){console.error(),console.error("  error: missing required argument `%s'",t),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(t,e){console.error(),e?console.error("  error: option `%s' argument missing, got `%s'",t.flags,e):console.error("  error: option `%s' argument missing",t.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(t){this._allowUnknownOption||(console.error(),console.error("  error: unknown option `%s'",t),console.error(),process.exit(1))},Command.prototype.variadicArgNotLast=function(t){console.error(),console.error("  error: variadic arguments must be last `%s'",t),console.error(),process.exit(1)},Command.prototype.version=function(t,e){return 0==arguments.length?this._version:(this._version=t,e=e||"-V, --version",this.option(e,"output the version number"),this.on("version",function(){process.stdout.write(t+"\n"),process.exit(0)}),this)},Command.prototype.description=function(t){return 0==arguments.length?this._description:(this._description=t,this)},Command.prototype.alias=function(t){return 0==arguments.length?this._alias:(this._alias=t,this)},Command.prototype.usage=function(t){var e=this._args.map(function(t){return humanReadableArgName(t)}),n="[options]"+(this.commands.length?" [command]":"")+(this._args.length?" "+e.join(" "):"");return 0==arguments.length?this._usage||n:(this._usage=t,this)},Command.prototype.name=function(){return this._name},Command.prototype.largestOptionLength=function(){return this.options.reduce(function(t,e){return Math.max(t,e.flags.length)},0)},Command.prototype.optionHelp=function(){var t=this.largestOptionLength();return[pad("-h, --help",t)+"  output usage information"].concat(this.options.map(function(e){return pad(e.flags,t)+"  "+e.description})).join("\n")},Command.prototype.commandHelp=function(){if(!this.commands.length)return"";var t=this.commands.filter(function(t){return!t._noHelp}).map(function(t){var e=t._args.map(function(t){return humanReadableArgName(t)}).join(" ");return[t._name+(t._alias?"|"+t._alias:"")+(t.options.length?" [options]":"")+" "+e,t.description()]}),e=t.reduce(function(t,e){return Math.max(t,e[0].length)},0);return["","  Commands:","",t.map(function(t){return pad(t[0],e)+"  "+t[1]}).join("\n").replace(/^/gm,"    "),""].join("\n")},Command.prototype.helpInformation=function(){var t=[];this._description&&(t=["  "+this._description,""]);var e=this._name;this._alias&&(e=e+"|"+this._alias);var n=["","  Usage: "+e+" "+this.usage(),""],r=[],i=this.commandHelp();i&&(r=[i]);var o=["  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""];return n.concat(r).concat(t).concat(o).join("\n")},Command.prototype.outputHelp=function(){process.stdout.write(this.helpInformation()),this.emit("--help")},Command.prototype.help=function(){this.outputHelp(),process.exit()};