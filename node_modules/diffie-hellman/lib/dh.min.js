function setPublicKey(e,t){return t=t||"utf8",Buffer.isBuffer(e)||(e=new Buffer(e,t)),this._pub=new BN(e),this}function setPrivateKey(e,t){return t=t||"utf8",Buffer.isBuffer(e)||(e=new Buffer(e,t)),this._priv=new BN(e),this}function checkPrime(e,t){var r=t.toString("hex"),n=[r,e.toString(16)].join("_");if(n in primeCache)return primeCache[n];var i=0;if(e.isEven()||!primes.simpleSieve||!primes.fermatTest(e)||!millerRabin.test(e))return i+=1,i+="02"===r||"05"===r?8:4,primeCache[n]=i,i;millerRabin.test(e.shrn(1))||(i+=2);var a;switch(r){case"02":e.mod(TWENTYFOUR).cmp(ELEVEN)&&(i+=8);break;case"05":a=e.mod(TEN),a.cmp(THREE)&&a.cmp(SEVEN)&&(i+=8);break;default:i+=4}return primeCache[n]=i,i}function DH(e,t,r){this.setGenerator(t),this.__prime=new BN(e),this._prime=BN.mont(this.__prime),this._primeLen=e.length,this._pub=void 0,this._priv=void 0,this._primeCode=void 0,r?(this.setPublicKey=setPublicKey,this.setPrivateKey=setPrivateKey):this._primeCode=8}function formatReturnValue(e,t){var r=new Buffer(e.toArray());return t?r.toString(t):r}var BN=require("bn.js"),MillerRabin=require("miller-rabin"),millerRabin=new MillerRabin,TWENTYFOUR=new BN(24),ELEVEN=new BN(11),TEN=new BN(10),THREE=new BN(3),SEVEN=new BN(7),primes=require("./generatePrime"),randomBytes=require("randombytes");module.exports=DH;var primeCache={};Object.defineProperty(DH.prototype,"verifyError",{enumerable:!0,get:function(){return"number"!=typeof this._primeCode&&(this._primeCode=checkPrime(this.__prime,this.__gen)),this._primeCode}}),DH.prototype.generateKeys=function(){return this._priv||(this._priv=new BN(randomBytes(this._primeLen))),this._pub=this._gen.toRed(this._prime).redPow(this._priv).fromRed(),this.getPublicKey()},DH.prototype.computeSecret=function(e){e=new BN(e),e=e.toRed(this._prime);var t=e.redPow(this._priv).fromRed(),r=new Buffer(t.toArray()),n=this.getPrime();if(r.length<n.length){var i=new Buffer(n.length-r.length);i.fill(0),r=Buffer.concat([i,r])}return r},DH.prototype.getPublicKey=function(e){return formatReturnValue(this._pub,e)},DH.prototype.getPrivateKey=function(e){return formatReturnValue(this._priv,e)},DH.prototype.getPrime=function(e){return formatReturnValue(this.__prime,e)},DH.prototype.getGenerator=function(e){return formatReturnValue(this._gen,e)},DH.prototype.setGenerator=function(e,t){return t=t||"utf8",Buffer.isBuffer(e)||(e=new Buffer(e,t)),this.__gen=e,this._gen=new BN(e),this};