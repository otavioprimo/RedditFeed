"use strict";function isMethodCallOf(e,t){var r=e.expression;if(r.kind===ts.SyntaxKind.PropertyAccessExpression){var n=r,i=n.name;if(i.kind==ts.SyntaxKind.Identifier)return i.text===t}return!1}function isCallOf(e,t){var r=e.expression;if(r.kind===ts.SyntaxKind.Identifier){var n=r;return n.text===t}return!1}function everyNodeChild(e,t){return!ts.forEachChild(e,function(e){return!t(e)})}function isPrimitive(e){return Object(e)!==e}function isDefined(e){return void 0!==e}function getSourceFileOfNode(e){for(;e&&e.kind!=ts.SyntaxKind.SourceFile;)e=e.parent;return e}function errorSymbol(e,t,r,n){var i;if(t&&(n=n||getSourceFileOfNode(t))){var o=ts.getLineAndCharacterOfPosition(n,t.getStart(n)),s=o.line,a=o.character;i={__symbolic:"error",message:e,line:s,character:a}}return i||(i={__symbolic:"error",message:e}),r&&(i.context=r),i}function isPropertyAssignment(e){return e.kind==ts.SyntaxKind.PropertyAssignment}var ts=require("typescript"),schema_1=require("./schema");exports.isPrimitive=isPrimitive,exports.errorSymbol=errorSymbol;var Evaluator=function(){function e(e,t){this.symbols=e,this.nodeMap=t}return e.prototype.nameOf=function(e){if(e.kind==ts.SyntaxKind.Identifier)return e.text;var t=this.evaluateNode(e);return schema_1.isMetadataError(t)||"string"==typeof t?t:errorSymbol("Name expected",e,{received:e.getText()})},e.prototype.isFoldable=function(e){return this.isFoldableWorker(e,new Map)},e.prototype.isFoldableWorker=function(e,t){var r=this;if(e)switch(e.kind){case ts.SyntaxKind.ObjectLiteralExpression:return everyNodeChild(e,function(e){if(e.kind===ts.SyntaxKind.PropertyAssignment){var n=e;return r.isFoldableWorker(n.initializer,t)}return!1});case ts.SyntaxKind.ArrayLiteralExpression:return everyNodeChild(e,function(e){return r.isFoldableWorker(e,t)});case ts.SyntaxKind.CallExpression:var n=e;if(isMethodCallOf(n,"concat")&&1===n.arguments.length){var i=n.expression.expression;if(this.isFoldableWorker(i,t)&&this.isFoldableWorker(n.arguments[0],t)){var o=this.evaluateNode(i);if(o&&Array.isArray(o))return!0}}return isCallOf(n,"CONST_EXPR")&&1===n.arguments.length?this.isFoldableWorker(n.arguments[0],t):!1;case ts.SyntaxKind.NoSubstitutionTemplateLiteral:case ts.SyntaxKind.StringLiteral:case ts.SyntaxKind.NumericLiteral:case ts.SyntaxKind.NullKeyword:case ts.SyntaxKind.TrueKeyword:case ts.SyntaxKind.FalseKeyword:return!0;case ts.SyntaxKind.ParenthesizedExpression:var s=e;return this.isFoldableWorker(s.expression,t);case ts.SyntaxKind.BinaryExpression:var a=e;switch(a.operatorToken.kind){case ts.SyntaxKind.PlusToken:case ts.SyntaxKind.MinusToken:case ts.SyntaxKind.AsteriskToken:case ts.SyntaxKind.SlashToken:case ts.SyntaxKind.PercentToken:case ts.SyntaxKind.AmpersandAmpersandToken:case ts.SyntaxKind.BarBarToken:return this.isFoldableWorker(a.left,t)&&this.isFoldableWorker(a.right,t);default:return!1}case ts.SyntaxKind.PropertyAccessExpression:var u=e;return this.isFoldableWorker(u.expression,t);case ts.SyntaxKind.ElementAccessExpression:var c=e;return this.isFoldableWorker(c.expression,t)&&this.isFoldableWorker(c.argumentExpression,t);case ts.SyntaxKind.Identifier:var l=e,p=this.symbols.resolve(l.text);if(void 0!==p&&isPrimitive(p))return!0}return!1},e.prototype.evaluateNode=function(e){function i(e,t){return r.nodeMap.set(e,t),e}var n,t=this,r=this;switch(e.kind){case ts.SyntaxKind.ObjectLiteralExpression:var o={};return ts.forEachChild(e,function(e){switch(e.kind){case ts.SyntaxKind.ShorthandPropertyAssignment:case ts.SyntaxKind.PropertyAssignment:var r=e,i=t.nameOf(r.name);if(schema_1.isMetadataError(i))return n=i,!0;var s=isPropertyAssignment(r)?t.evaluateNode(r.initializer):{__symbolic:"reference",name:i};if(schema_1.isMetadataError(s))return n=s,!0;o[i]=s}}),n?n:o;case ts.SyntaxKind.ArrayLiteralExpression:var s=[];return ts.forEachChild(e,function(e){var r=t.evaluateNode(e);if(schema_1.isMetadataError(r))return n=r,!0;if(schema_1.isMetadataSymbolicSpreadExpression(r)&&Array.isArray(r.expression))for(var i=0,o=r.expression;i<o.length;i++){var a=o[i];s.push(a)}else s.push(r)}),n?n:s;case ts.SyntaxKind.SpreadElementExpression:var a=e,u=this.evaluateNode(a.expression);return i({__symbolic:"spread",expression:u},e);case ts.SyntaxKind.CallExpression:var c=e;if(isCallOf(c,"forwardRef")&&1===c.arguments.length){var l=c.arguments[0];if(l.kind==ts.SyntaxKind.ArrowFunction){var p=l;return i(this.evaluateNode(p.body),e)}}var f=c.arguments.map(function(e){return t.evaluateNode(e)});if(f.some(schema_1.isMetadataError))return f.find(schema_1.isMetadataError);if(this.isFoldable(c)&&isMethodCallOf(c,"concat")){var h=this.evaluateNode(c.expression.expression);return schema_1.isMetadataError(h)?h:h.concat(f[0])}if(isCallOf(c,"CONST_EXPR")&&1===c.arguments.length)return i(f[0],e);var d=this.evaluateNode(c.expression);if(schema_1.isMetadataError(d))return i(d,e);var v={__symbolic:"call",expression:d};return f&&f.length&&(v.arguments=f),i(v,e);case ts.SyntaxKind.NewExpression:var y=e,m=y.arguments.map(function(e){return t.evaluateNode(e)});if(m.some(schema_1.isMetadataError))return i(m.find(schema_1.isMetadataError),e);var g=this.evaluateNode(y.expression);if(schema_1.isMetadataError(g))return i(g,e);var _={__symbolic:"new",expression:g};return m.length&&(_.arguments=m),i(_,e);case ts.SyntaxKind.PropertyAccessExpression:var w=e,b=this.evaluateNode(w.expression);if(schema_1.isMetadataError(b))return i(b,e);var E=this.nameOf(w.name);return schema_1.isMetadataError(E)?i(E,e):b&&this.isFoldable(w.expression)?b[E]:schema_1.isMetadataModuleReferenceExpression(b)?i({__symbolic:"reference",module:b.module,name:E},e):i({__symbolic:"select",expression:b,member:E},e);case ts.SyntaxKind.ElementAccessExpression:var C=e,x=this.evaluateNode(C.expression);if(schema_1.isMetadataError(x))return i(x,e);var S=this.evaluateNode(C.argumentExpression);return schema_1.isMetadataError(x)?i(x,e):this.isFoldable(C.expression)&&this.isFoldable(C.argumentExpression)?x[S]:i({__symbolic:"index",expression:x,index:S},e);case ts.SyntaxKind.Identifier:var T=e,A=T.text,P=this.symbols.resolve(A);return void 0===P?i({__symbolic:"reference",name:A},e):P;case ts.SyntaxKind.TypeReference:var O=e,M=O.typeName,k=function(e){if(M.kind===ts.SyntaxKind.QualifiedName){var r=e,n=t.evaluateNode(r.left);return schema_1.isMetadataModuleReferenceExpression(n)?i({__symbolic:"reference",module:n.module,name:r.right.text},e):{__symbolic:"select",expression:n,member:r.right.text}}var o=M,s=t.symbols.resolve(o.text);return schema_1.isMetadataError(s)||schema_1.isMetadataSymbolicReferenceExpression(s)?i(s,e):i(errorSymbol("Could not resolve type",e,{typeName:o.text}),e)},N=k(M);if(schema_1.isMetadataError(N))return i(N,e);if(!schema_1.isMetadataModuleReferenceExpression(N)&&O.typeArguments&&O.typeArguments.length){var I=O.typeArguments.map(function(e){return t.evaluateNode(e)});N.arguments=I}return i(N,e);case ts.SyntaxKind.NoSubstitutionTemplateLiteral:return e.text;case ts.SyntaxKind.StringLiteral:return e.text;case ts.SyntaxKind.NumericLiteral:return parseFloat(e.text);case ts.SyntaxKind.AnyKeyword:return i({__symbolic:"reference",name:"any"},e);case ts.SyntaxKind.StringKeyword:return i({__symbolic:"reference",name:"string"},e);case ts.SyntaxKind.NumberKeyword:return i({__symbolic:"reference",name:"number"},e);case ts.SyntaxKind.BooleanKeyword:return i({__symbolic:"reference",name:"boolean"},e);case ts.SyntaxKind.ArrayType:var D=e;return i({__symbolic:"reference",name:"Array",arguments:[this.evaluateNode(D.elementType)]},e);case ts.SyntaxKind.NullKeyword:return null;case ts.SyntaxKind.TrueKeyword:return!0;case ts.SyntaxKind.FalseKeyword:return!1;case ts.SyntaxKind.ParenthesizedExpression:var R=e;return this.evaluateNode(R.expression);case ts.SyntaxKind.TypeAssertionExpression:var j=e;return this.evaluateNode(j.expression);case ts.SyntaxKind.PrefixUnaryExpression:var V=e,L=this.evaluateNode(V.operand);if(isDefined(L)&&isPrimitive(L))switch(V.operator){case ts.SyntaxKind.PlusToken:return+L;case ts.SyntaxKind.MinusToken:return-L;case ts.SyntaxKind.TildeToken:return~L;case ts.SyntaxKind.ExclamationToken:return!L}var F=void 0;switch(V.operator){case ts.SyntaxKind.PlusToken:F="+";break;case ts.SyntaxKind.MinusToken:F="-";break;case ts.SyntaxKind.TildeToken:F="~";break;case ts.SyntaxKind.ExclamationToken:F="!";break;default:return void 0}return i({__symbolic:"pre",operator:F,operand:L},e);case ts.SyntaxKind.BinaryExpression:var U=e,H=this.evaluateNode(U.left),B=this.evaluateNode(U.right);if(isDefined(H)&&isDefined(B)){if(isPrimitive(H)&&isPrimitive(B))switch(U.operatorToken.kind){case ts.SyntaxKind.BarBarToken:return H||B;case ts.SyntaxKind.AmpersandAmpersandToken:return H&&B;case ts.SyntaxKind.AmpersandToken:return H&B;case ts.SyntaxKind.BarToken:return H|B;case ts.SyntaxKind.CaretToken:return H^B;case ts.SyntaxKind.EqualsEqualsToken:return H==B;case ts.SyntaxKind.ExclamationEqualsToken:return H!=B;case ts.SyntaxKind.EqualsEqualsEqualsToken:return H===B;case ts.SyntaxKind.ExclamationEqualsEqualsToken:return H!==B;case ts.SyntaxKind.LessThanToken:return B>H;case ts.SyntaxKind.GreaterThanToken:return H>B;case ts.SyntaxKind.LessThanEqualsToken:return B>=H;case ts.SyntaxKind.GreaterThanEqualsToken:return H>=B;case ts.SyntaxKind.LessThanLessThanToken:return H<<B;case ts.SyntaxKind.GreaterThanGreaterThanToken:return H>>B;case ts.SyntaxKind.GreaterThanGreaterThanGreaterThanToken:return H>>>B;case ts.SyntaxKind.PlusToken:return H+B;case ts.SyntaxKind.MinusToken:return H-B;case ts.SyntaxKind.AsteriskToken:return H*B;case ts.SyntaxKind.SlashToken:return H/B;case ts.SyntaxKind.PercentToken:return H%B}return i({__symbolic:"binop",operator:U.operatorToken.getText(),left:H,right:B},e)}break;case ts.SyntaxKind.ConditionalExpression:var q=e,G=this.evaluateNode(q.condition),K=this.evaluateNode(q.whenTrue),z=this.evaluateNode(q.whenFalse);return isPrimitive(G)?G?K:z:i({__symbolic:"if",condition:G,thenExpression:K,elseExpression:z},e);case ts.SyntaxKind.FunctionExpression:case ts.SyntaxKind.ArrowFunction:return i(errorSymbol("Function call not supported",e),e)}return i(errorSymbol("Expression form not supported",e),e)},e}();exports.Evaluator=Evaluator;