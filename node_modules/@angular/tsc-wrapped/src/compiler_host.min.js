"use strict";var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},fs_1=require("fs"),tsickle_1=require("tsickle"),ts=require("typescript"),collector_1=require("./collector"),DelegatingHost=function(){function e(e){var t=this;this.delegate=e,this.getSourceFile=function(e,r,n){return t.delegate.getSourceFile(e,r,n)},this.getCancellationToken=function(){return t.delegate.getCancellationToken()},this.getDefaultLibFileName=function(e){return t.delegate.getDefaultLibFileName(e)},this.getDefaultLibLocation=function(){return t.delegate.getDefaultLibLocation()},this.writeFile=this.delegate.writeFile,this.getCurrentDirectory=function(){return t.delegate.getCurrentDirectory()},this.getDirectories=function(e){return t.delegate.getDirectories?t.delegate.getDirectories(e):[]},this.getCanonicalFileName=function(e){return t.delegate.getCanonicalFileName(e)},this.useCaseSensitiveFileNames=function(){return t.delegate.useCaseSensitiveFileNames()},this.getNewLine=function(){return t.delegate.getNewLine()},this.fileExists=function(e){return t.delegate.fileExists(e)},this.readFile=function(e){return t.delegate.readFile(e)},this.trace=function(e){return t.delegate.trace(e)},this.directoryExists=function(e){return t.delegate.directoryExists(e)}}return e}();exports.DelegatingHost=DelegatingHost;var TsickleHost=function(e){function t(t,r){var n=this;e.call(this,t),this.program=r,this.diagnostics=[],this.TSICKLE_SUPPORT="\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n",this.getSourceFile=function(e,t,r){var i=n.delegate.readFile(e),o=i;if(!/\.d\.ts$/.test(e))try{var s=tsickle_1.convertDecorators(n.program.getTypeChecker(),n.program.getSourceFile(e));s.diagnostics&&(u=n.diagnostics).push.apply(u,s.diagnostics),o=s.output+n.TSICKLE_SUPPORT}catch(a){throw console.error("Cannot convertDecorators on file",e),a}return ts.createSourceFile(e,o,t,!0);var u}}return __extends(t,e),t}(DelegatingHost);exports.TsickleHost=TsickleHost;var IGNORED_FILES=/\.ngfactory\.js$|\.css\.js$|\.css\.shim\.js$/,MetadataWriterHost=function(e){function t(t,r,n){var i=this;e.call(this,t),this.program=r,this.ngOptions=n,this.metadataCollector=new collector_1.MetadataCollector,this.writeFile=function(e,t,r,n,o){if(/\.d\.ts$/.test(e))return void i.delegate.writeFile(e,t,r,n,o);if(!IGNORED_FILES.test(e)){if(!o)throw new Error("Metadata emit requires the sourceFiles are passed to WriteFileCallback. Update to TypeScript ^1.9.0-dev");if(o.length>1)throw new Error("Bundled emit with --out is not supported");i.writeMetadata(e,o[0])}}}return __extends(t,e),t.prototype.writeMetadata=function(e,t){if(/\.js$/.test(e)){var r=e.replace(/\.js$/,".metadata.json"),n=this.metadataCollector.getMetadata(t,!!this.ngOptions.strictMetadataEmit);if(n&&n.metadata){var i=JSON.stringify(n);fs_1.writeFileSync(r,i,{encoding:"utf-8"})}}},t}(DelegatingHost);exports.MetadataWriterHost=MetadataWriterHost;