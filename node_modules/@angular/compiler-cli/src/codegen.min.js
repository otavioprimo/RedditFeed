"use strict";var compiler=require("@angular/compiler"),core_1=require("@angular/core"),path=require("path"),path_mapped_reflector_host_1=require("./path_mapped_reflector_host"),private_import_core_1=require("./private_import_core"),reflector_host_1=require("./reflector_host"),static_reflection_capabilities_1=require("./static_reflection_capabilities"),static_reflector_1=require("./static_reflector"),nodeFs=require("fs"),GENERATED_FILES=/\.ngfactory\.ts$|\.css\.ts$|\.css\.shim\.ts$/,GENERATED_OR_DTS_FILES=/\.d\.ts$|\.ngfactory\.ts$|\.css\.ts$|\.css\.shim\.ts$/,PREAMBLE="/**\n * This file is generated by the Angular 2 template compiler.\n * Do not edit.\n */\n /* tslint:disable */\n\n",CodeGeneratorModuleCollector=function(){function e(e,t,r,n){this.staticReflector=e,this.reflectorHost=t,this.program=r,this.options=n}return e.prototype.getModuleSymbols=function(e){var t=this,r=this.options.generateCodeForLibraries===!1?GENERATED_OR_DTS_FILES:GENERATED_FILES,n=this.program.getSourceFiles().filter(function(e){return!r.test(e.fileName)}).map(function(e){return t.reflectorHost.getCanonicalFileName(e.fileName)}),i=n.map(function(e){return t.readFileMetadata(e)}),o=i.reduce(function(e,t){return e.push.apply(e,t.ngModules),e},[]);return{fileMetas:i,ngModules:o}},e.prototype.readFileMetadata=function(e){var t=this.staticReflector.getModuleMetadata(e),r={directives:[],ngModules:[],fileUrl:e};if(!t)return console.log("WARNING: no metadata found for "+e),r;var n=t.metadata,i=n&&Object.keys(n);if(!i||!i.length)return r;for(var o=function(t){if(n[t]&&"error"==n[t].__symbolic)return"continue";var i=s.reflectorHost.findDeclaration(e,t,e),o=s.staticReflector.annotations(i);o.forEach(function(e){e instanceof core_1.NgModule?r.ngModules.push(i):e instanceof core_1.Directive&&r.directives.push(i)})},s=this,a=0,u=i;a<u.length;a++){var c=u[a];o(c)}return r},e}();exports.CodeGeneratorModuleCollector=CodeGeneratorModuleCollector;var CodeGenerator=function(){function e(e,t,r,n,i,o){this.options=e,this.program=t,this.host=r,this.staticReflector=n,this.compiler=i,this.reflectorHost=o,this.moduleCollector=new CodeGeneratorModuleCollector(n,o,t,e)}return e.prototype.calculateEmitPath=function(e){for(var t=this.options.basePath,r=0,n=this.options.rootDirs||[];r<n.length;r++){var i=n[r];this.options.trace&&console.log("Check if "+e+" is under rootDirs element "+i),0!==path.relative(i,e).indexOf(".")&&(t=i)}for(var o=path.relative(t,e);o.startsWith(".."+path.sep);)o=o.substr(3);return path.join(this.options.genDir,o)},e.prototype.codegen=function(){var e=this,t=this.moduleCollector.getModuleSymbols(this.program),r=t.fileMetas,n=t.ngModules,i=this.compiler.analyzeModules(n);return Promise.all(r.map(function(t){return e.compiler.compile(t.fileUrl,i,t.directives,t.ngModules).then(function(r){r.forEach(function(r){var n=e.program.getSourceFile(t.fileUrl),i=e.calculateEmitPath(r.moduleUrl);e.host.writeFile(i,PREAMBLE+r.source,!1,function(){},[n])})})}))},e.create=function(t,r,n,i,o,s,a){s=s||{get:function(e){if(!i.fileExists(e))throw new Error("Compilation failed. Resource file not found: "+e);return Promise.resolve(i.readFile(e))}};var u=r.i18nFile,c=r.locale,l="";if(u){if(!c)throw new Error("The translation file ("+u+") locale must be provided. Use the --locale option.");l=nodeFs.readFileSync(u,"utf8")}var p=compiler.createOfflineCompileUrlResolver();if(!a){var h=!!t.rootDirs&&t.rootDirs.length>0;a=h?new path_mapped_reflector_host_1.PathMappedReflectorHost(n,i,t,o):new reflector_host_1.ReflectorHost(n,i,t,o)}var f=new static_reflector_1.StaticReflector(a);static_reflection_capabilities_1.StaticAndDynamicReflectionCapabilities.install(f);var v=new compiler.I18NHtmlParser(new compiler.HtmlParser,l,r.i18nFormat),d=new compiler.CompilerConfig({genDebugInfo:t.debug===!0,defaultEncapsulation:core_1.ViewEncapsulation.Emulated,logBindingUpdate:!1,useJit:!1}),m=new compiler.DirectiveNormalizer(s,p,v,d),y=new compiler.Parser(new compiler.Lexer),g=new compiler.DomElementSchemaRegistry,_=new private_import_core_1.Console,w=new compiler.TemplateParser(y,g,v,_,[]),E=new compiler.CompileMetadataResolver(new compiler.NgModuleResolver(f),new compiler.DirectiveResolver(f),new compiler.PipeResolver(f),g,f),C=new compiler.OfflineCompiler(E,m,w,new compiler.StyleCompiler(p),new compiler.ViewCompiler(d),new compiler.DirectiveWrapperCompiler(d),new compiler.NgModuleCompiler,new compiler.TypeScriptEmitter(a),r.locale,r.i18nFormat);return new e(t,n,i,f,C,a)},e}();exports.CodeGenerator=CodeGenerator;