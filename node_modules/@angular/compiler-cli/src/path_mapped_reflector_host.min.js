"use strict";var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},path=require("path"),ts=require("typescript"),reflector_host_1=require("./reflector_host"),EXT=/(\.ts|\.d\.ts|\.js|\.jsx|\.tsx)$/,DTS=/\.d\.ts$/,PathMappedReflectorHost=function(e){function t(t,r,n,i){e.call(this,t,r,n,i)}return __extends(t,e),t.prototype.getCanonicalFileName=function(e){if(!e)return e;for(var t=0,r=this.options.rootDirs||[];t<r.length;t++){var n=r[t];0===e.indexOf(n)&&(e=e.substring(n.length))}return e},t.prototype.resolve=function(e,t){for(var r=0,n=this.options.rootDirs||[""];r<n.length;r++){var i=n[r],o=path.join(i,t),s=ts.resolveModuleName(e,o,this.options,this.context).resolvedModule;if(s)return this.options.traceResolution&&console.log("resolve",e,t,"=>",s.resolvedFileName),s.resolvedFileName}},t.prototype.getImportPath=function(e,t){var r=this;t=this.resolveAssetUrl(t,e),e=this.resolveAssetUrl(e,""),this.options.traceResolution&&console.log("getImportPath from containingFile",e,"to importedFile",t),this.context.fileExists(t)||(this.options.rootDirs&&this.options.rootDirs.length>0?this.context.assumeFileExists(path.join(this.options.rootDirs[0],t)):this.context.assumeFileExists(t));for(var s,n=function(e){var n=r.getCanonicalFileName(r.resolve(e,t));return n&&n.replace(EXT,"")===t.replace(EXT,"")},i=t.replace(EXT,""),o=i.split(path.sep).filter(function(e){return!!e}),a=o.length-1;a>=0;a--){var u=o.slice(a,o.length).join(path.sep);if(n(u))return u;u="."+path.sep+u,n(u)&&(s=u)}if(s)return s;var c=path.relative(path.dirname(e),i);if(n(c))return c;throw new Error("Unable to find any resolvable import for "+t+" relative to "+e)},t.prototype.getMetadataFor=function(e){for(var t=0,r=this.options.rootDirs||[];t<r.length;t++){var n=r[t],i=path.join(n,e);if(this.compilerHost.fileExists(i)){if(!DTS.test(i)){var a=this.program.getSourceFile(i);if(!a)throw new Error("Source file "+i+" not present in program.");return a.fileName=this.getCanonicalFileName(a.fileName),this.metadataCollector.getMetadata(a)}var o=i.replace(DTS,".metadata.json");if(this.context.fileExists(o)){var s=this.readMetadata(o);return Array.isArray(s)&&0==s.length?void 0:s}}}},t}(reflector_host_1.ReflectorHost);exports.PathMappedReflectorHost=PathMappedReflectorHost;