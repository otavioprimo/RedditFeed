"use strict";var compiler_1=require("@angular/compiler"),tsc_wrapped_1=require("@angular/tsc-wrapped"),fs=require("fs"),path=require("path"),ts=require("typescript"),static_reflector_1=require("./static_reflector"),EXT=/(\.ts|\.d\.ts|\.js|\.jsx|\.tsx)$/,DTS=/\.d\.ts$/,NODE_MODULES="/node_modules/",IS_GENERATED=/\.(ngfactory|css(\.shim)?)$/,ReflectorHost=function(){function e(e,t,r,n){this.program=e,this.compilerHost=t,this.options=r,this.metadataCollector=new tsc_wrapped_1.MetadataCollector,this.typeCache=new Map,this.resolverCache=new Map,this.basePath=path.normalize(path.join(this.options.basePath,".")).replace(/\\/g,"/"),this.genDir=path.normalize(path.join(this.options.genDir,".")).replace(/\\/g,"/"),this.context=n||new NodeReflectorHostContext(t);var i=path.relative(this.basePath,this.genDir);this.isGenDirChildOfRootDir=""===i||!i.startsWith("..")}return e.prototype.angularImportLocations=function(){return{coreDecorators:"@angular/core/src/metadata",diDecorators:"@angular/core/src/di/metadata",diMetadata:"@angular/core/src/di/metadata",diOpaqueToken:"@angular/core/src/di/opaque_token",animationMetadata:"@angular/core/src/animation/metadata",provider:"@angular/core/src/di/provider"}},e.prototype.getCanonicalFileName=function(e){return e},e.prototype.resolve=function(e,t){e=e.replace(EXT,"");var r=ts.resolveModuleName(e,t.replace(/\\/g,"/"),this.options,this.context).resolvedModule;return r?r.resolvedFileName:null},e.prototype.normalizeAssetUrl=function(e){var t=compiler_1.AssetUrl.parse(e),r=t?t.packageName+"/"+t.modulePath:null;return this.getCanonicalFileName(r)},e.prototype.resolveAssetUrl=function(e,t){var r=this.normalizeAssetUrl(e);return r?this.getCanonicalFileName(this.resolve(r,t)):e},e.prototype.getImportPath=function(e,t){t=this.resolveAssetUrl(t,e),e=this.resolveAssetUrl(e,""),this.compilerHost.fileExists(t)||this.context.assumeFileExists(t),e=this.rewriteGenDirPath(e);var r=path.dirname(e);t=t.replace(EXT,"");var n=t.indexOf(NODE_MODULES),i=-1===n?null:t.substring(n+NODE_MODULES.length),o=IS_GENERATED.test(t);return o?i?this.dotRelative(r,this.genDir+NODE_MODULES+i):(t=this.rewriteGenDirPath(t),this.dotRelative(r,t)):i?i:(this.isGenDirChildOfRootDir||(t=t.replace(this.basePath,this.genDir)),this.dotRelative(r,t))},e.prototype.dotRelative=function(e,t){var r=path.relative(e,t).replace(/\\/g,"/");return r.startsWith(".")?r:"./"+r},e.prototype.rewriteGenDirPath=function(e){var t=e.indexOf(NODE_MODULES);return-1!==t?path.join(this.genDir,e.substring(t)):e.replace(this.basePath,this.genDir)},e.prototype.findDeclaration=function(e,t,r,n){if(!r||!r.length){if(0===e.indexOf("."))throw new Error("Resolution of relative paths requires a containing file.");r=path.join(this.basePath,"index.ts")}try{var i=this.normalizeAssetUrl(e);i&&(e=i);var o=this.resolve(e,r);if(!o)return this.getStaticSymbol(e,t);var s=this.program.getTypeChecker(),a=this.program.getSourceFile(o);if(!a||!a.symbol)return this.resolveExportedSymbol(o,t)||this.getStaticSymbol(o,t);var u=s.getExportsOfModule(a.symbol).find(function(e){return e.name===t});if(!u)throw new Error("can't find symbol "+t+" exported from module "+o);u&&u.flags&ts.SymbolFlags.Alias&&(u=s.getAliasedSymbol(u));var c=u.getDeclarations()[0],l=this.getCanonicalFileName(c.getSourceFile().fileName);return this.getStaticSymbol(l,u.getName())}catch(p){throw console.error("can't resolve module "+e+" from "+r),p}},e.prototype.getStaticSymbol=function(e,t,r){var n=r?"."+r.join("."):"",i='"'+e+'".'+t+n,o=this.typeCache.get(i);return o||(o=new static_reflector_1.StaticSymbol(e,t,r),this.typeCache.set(i,o)),o},e.prototype.getMetadataFor=function(e){if(this.context.fileExists(e)){if(!DTS.test(e)){var n=this.program.getSourceFile(e);if(!n)throw new Error("Source file "+e+" not present in program.");return this.metadataCollector.getMetadata(n)}var t=e.replace(DTS,".metadata.json");if(this.context.fileExists(t)){var r=this.readMetadata(t);return Array.isArray(r)&&0==r.length?void 0:r}}},e.prototype.readMetadata=function(e){try{return this.resolverCache.get(e)||JSON.parse(this.context.readFile(e))}catch(t){throw console.error("Failed to read JSON file "+e),t}},e.prototype.getResolverMetadata=function(e){var t=this.resolverCache.get(e);return t||(t=this.getMetadataFor(e),this.resolverCache.set(e,t)),t},e.prototype.resolveExportedSymbol=function(e,t){var r=this,n=function(t){var n=r.getCanonicalFileName(r.resolve(t,e));if(!n)throw new Error("Could not resolve module '"+t+"' relative to file "+e);return n},i=this.getResolverMetadata(e);if(i){if(i.metadata[t])return this.getStaticSymbol(e,t);if(i.exports){for(var o=0,s=i.exports;o<s.length;o++){var a=s[o];if(a["export"]){var u=a["export"].find(function(e){return"string"==typeof e?e==t:e.as==t});if(u){var c=t;return"string"!=typeof u&&(c=u.name),this.resolveExportedSymbol(n(a.from),c)}}}for(var l=0,p=i.exports;l<p.length;l++){var a=p[l];if(!a["export"]){var h=n(a.from),f=this.resolveExportedSymbol(h,t);if(f)return f}}}}return null},e}();exports.ReflectorHost=ReflectorHost;var NodeReflectorHostContext=function(){function e(e){this.host=e,this.assumedExists={}}return e.prototype.fileExists=function(e){return this.assumedExists[e]||this.host.fileExists(e)},e.prototype.directoryExists=function(e){try{return fs.statSync(e).isDirectory()}catch(t){return!1}},e.prototype.readFile=function(e){return fs.readFileSync(e,"utf8")},e.prototype.assumeFileExists=function(e){this.assumedExists[e]=!0},e}();exports.NodeReflectorHostContext=NodeReflectorHostContext;